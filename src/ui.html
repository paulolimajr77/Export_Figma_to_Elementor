<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Figma to WP Elementor</title>
  <style>
    /* tokens */
    :root {
      --font: "Inter", sans-serif;
      --space-1: 6px;
      --space-2: 12px;
      --space-3: 18px;
      --space-4: 24px;
      --radius: 10px;
      --color-bg: #f5f6fb;
      --color-panel: #ffffff;
      --color-border: #e2e5ec;
      --color-text: #111318;
      --color-text-secondary: #000000;
      --color-primary: #0c7bff;
      --color-primary-hover: #0063cc;
      --shadow-1: 0 6px 18px rgba(0, 0, 0, 0.07);
    }

    :root.dark {
      --color-bg: #1c1c1f;
      --color-panel: #2a2a2e;
      --color-border: #3a3a3e;
      --color-text: #8d8d8d;
      --color-text-secondary: #e6e6e6;
      --color-primary: #3ea6ff;
      --color-primary-hover: #1c8dd5;
      --shadow-1: 0 8px 20px rgba(0, 0, 0, 0.35);
    }

    @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap");

    :root {
      --anim: 180ms ease;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: var(--font, 'Inter'), system-ui, -apple-system, sans-serif;
      background: var(--color-bg);
      color: var(--color-text);
    }

    .app {
      width: 100%;
      /* max-width: 800px; */
      margin: 0 auto;
      min-height: 100vh;
      padding: var(--space-3);
    }

    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-2);
    }

    .brand {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .brand-title {
      font-weight: 700;
      font-size: 19px;
      color: var(--color-text);
    }

    .brand-subtitle {
      font-size: 13px;
      color: var(--color-text-secondary);
    }

    .top-actions {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .btn {
      border: 1px solid var(--color-border);
      border-radius: var(--radius);
      padding: 10px 14px;
      font-weight: 700;
      cursor: pointer;
      transition: transform var(--anim), box-shadow var(--anim), background var(--anim);
      font-size: 0.7em !important;
      text-wrap: nowrap;
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-1);
    }

    .btn.primary {
      background: #0c7bff;
      border-color: #0c7bff;
      color: #fff;
    }

    .btn.secondary {
      background: #eef1f6;
      color: #1d1f25;
    }

    .btn.ghost {
      background: var(--color-panel);
      color: var(--color-text-secondary);
      border-color: var(--color-border);
    }

    .btn.small {
      padding: 6px 10px;
      font-size: 12px;
    }

    .btn.tiny {
      padding: 6px 10px;
      font-size: 12px;
    }

    .btn:disabled {
      opacity: 0.45;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    .switch {
      position: relative;
      display: inline-block;
      width: 56px;
      height: 30px;
    }

    .switch input {
      display: none;
    }

    .slider {
      position: absolute;
      inset: 0;
      cursor: pointer;
      background: var(--color-border);
      border-radius: 999px;
      transition: var(--anim);
    }

    .slider:before {
      content: "";
      position: absolute;
      left: 4px;
      top: 4px;
      width: 22px;
      height: 22px;
      background: var(--color-panel);
      border-radius: 50%;
      box-shadow: var(--shadow-1);
      transition: var(--anim);
      z-index: 2;
    }

    .slider .sun,
    .slider .moon {
      position: absolute;
      font-size: 13px;
      top: 7px;
      transition: var(--anim);
    }

    .slider .sun {
      left: 10px;
      opacity: 1;
    }

    .slider .moon {
      right: 10px;
      opacity: 0;
    }

    input:checked+.slider {
      background: var(--color-primary);
    }

    input:checked+.slider:before {
      transform: translateX(26px);
    }

    input:checked+.slider .sun {
      opacity: 0;
      transform: translateX(-6px);
    }

    input:checked+.slider .moon {
      opacity: 1;
      transform: translateX(6px);
    }

    .tabs {
      display: flex;
      gap: 0;
      background: var(--color-panel);
      border: 1px solid var(--color-border);
      border-radius: var(--radius);
      position: relative;
      overflow: hidden;
    }

    .tab-btn {
      flex: 1;
      padding: var(--space-2);
      border: none;
      background: transparent;
      font-weight: 400;
      color: var(--color-text-secondary);
      cursor: pointer;
      position: relative;
      transition: color var(--anim), background var(--anim);
      font-size: 0.75em !important;
      text-wrap: nowrap;
    }

    .tab-btn.active {
      color: var(--color-primary);
    }

    .tab-btn:hover {
      background: rgba(0, 0, 0, 0.02);
    }

    .tab-indicator {
      position: absolute;
      bottom: 0;
      left: 0;
      height: 3px;
      width: 25%;
      background: var(--color-primary);
      transition: transform var(--anim), width var(--anim);
    }

    .tab-panels {
      margin-top: var(--space-2);
    }

    .tab-panel {
      display: none;
      animation: fadeIn var(--anim);
    }

    .tab-panel.active {
      display: block;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(4px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .row {
      display: flex;
      gap: 16px;
      margin-bottom: 12px;
    }

    .card {
      background: var(--color-panel);
      border: 1px solid var(--color-border);
      border-radius: var(--radius);
      padding: var(--space-3);
      margin-bottom: var(--space-3);
      box-shadow: var(--shadow-1);
    }

    .card-title {
      font-weight: 900;
      margin-bottom: var(--space-2);
      color: var(--color-text);
      font-size: 0.75em !important;
    }

    .actions {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: var(--space-2);
    }

    select {
      padding: 6px 12px;
      border: 1px solid var(--color-border);
      border-radius: var(--radius);
      font-size: 14px;
      background: #fff;
      color: var(--color-text);
    }

    .input-label {
      display: block;
      margin: var(--space-2) 0 var(--space-1);
      font-weight: 600;
      color: var(--color-text-secondary);
    }

    input[type="text"],
    input[type="password"] {
      width: 100%;
      padding: 6px 12px;
      border: 1px solid var(--color-border);
      border-radius: var(--radius);
      font-size: 14px;
      background: #fff;
      color: var(--color-text);
    }

    .checkbox {
      display: flex;
      gap: 8px;
      align-items: center;
      margin: 6px 0;
      color: var(--color-text-secondary);
    }

    #output {
      width: 100%;
      min-height: 160px;
      border: 1px solid var(--color-border);
      border-radius: var(--radius);
      padding: 12px;
      font-family: "SFMono-Regular", Consolas, monospace;
      background: #f5f6f8;
      resize: vertical;
      color: var(--color-text);
    }

    .logs {
      margin-top: 10px;
      min-height: 80px;
      border: 1px solid var(--color-border);
      border-radius: var(--radius);
      padding: 10px;
      background: var(--color-panel);
      font-size: 12px;
      color: var(--color-text);
      overflow-y: auto;
    }

    .status {
      margin-top: 10px;
      font-size: 13px;
      color: var(--color-text-secondary);
    }

    .provider-block {
      display: none;
    }

    body[data-provider="gemini"] .provider-gemini,
    body[data-provider="gpt"] .provider-gpt {
      display: block;
    }

    .ai-hidden {
      display: none !important;
    }

    .help-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: var(--space-2);
    }

    .help-item {
      padding: var(--space-2);
      border: 1px solid var(--color-border);
      border-radius: var(--radius);
      background: #f9fafb;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .help-item .label {
      font-weight: 600;
      color: var(--color-text);
    }

    .muted {
      color: var(--color-text-secondary);
      font-size: 12px;
      margin-top: var(--space-2);
    }

    body.dark {
      background: var(--color-bg);
      color: var(--color-text);
    }

    body.dark .tabs {
      border-color: var(--color-border);
      background: var(--color-panel);
    }

    body.dark .tab-btn {
      color: var(--color-text-secondary);
    }

    body.dark .tab-btn.active {
      color: var(--color-primary);
    }

    body.dark .card {
      background: var(--color-panel);
      border-color: var(--color-border);
    }

    body.dark .btn.secondary {
      background: #3a3a3e;
      color: #f5f5f5;
    }

    body.dark .btn.ghost {
      background: #2a2a2e;
      color: #f5f5f5;
    }

    body.dark input[type="text"],
    body.dark input[type="password"] {
      background: #1f1f22;
      border-color: var(--color-border);
      color: #eee;
    }

    body.dark #output {
      background: #242424;
      color: #eee;
      border-color: var(--color-border);
    }

    body.dark .logs {
      background: #242424;
      color: #bbb;
      border-color: var(--color-border);
    }

    body.dark .help-item {
      background: #2f2f2f;
      border-color: var(--color-border);
    }

    body.dark .help-item .label {
      color: #f5f5f5;
    }

    /* Estilos para Grid Compacto e Busca */
    .help-grid.compact {
      grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
      gap: 8px;
    }

    .help-item.compact {
      flex-direction: column;
      align-items: flex-start;
      padding: 8px;
      gap: 8px;
    }

    .help-item.compact .item-header {
      display: flex;
      align-items: center;
      gap: 6px;
      width: 100%;
      margin-bottom: 2px;
    }

    .help-item.compact .item-icon {
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--color-primary);
      opacity: 0.8;
    }

    .help-item.compact .label {
      font-size: 11px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      flex: 1;
    }

    .help-item.compact .btn {
      width: 100%;
      justify-content: center;
      padding: 4px;
      font-size: 10px;
      height: 24px;
    }

    .card.compact {
      padding: 10px;
      margin-bottom: 10px;
    }

    .card-title.small {
      font-size: 12px;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      opacity: 0.8;
    }

    .search-box {
      margin-bottom: 12px;
      position: sticky;
      top: 0;
      z-index: 10;
      background: var(--color-bg);
      padding-bottom: 8px;
    }

    .search-input {
      width: 100%;
      padding: 8px 12px 8px 32px;
      border: 1px solid var(--color-border);
      border-radius: var(--radius);
      font-size: 13px;
      background: var(--color-panel);
      color: var(--color-text);
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='14' viewBox='0 0 24 24' fill='none' stroke='%23999' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='11' cy='11' r='8'%3E%3C/circle%3E%3Cline x1='21' y1='21' x2='16.65' y2='16.65'%3E%3C/line%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: 10px center;
    }

    .search-status {
      font-size: 11px;
      color: var(--color-text-secondary);
      margin-bottom: 8px;
      padding: 0 4px;
    }

    .empty-state {
      padding: 20px;
      text-align: center;
      color: var(--color-text-secondary);
      font-size: 13px;
      background: var(--color-panel);
      border-radius: var(--radius);
      border: 1px dashed var(--color-border);
    }

    body.dark .search-input {
      background-color: #2a2a2e;
      border-color: #3a3a3e;
      color: #eee;
    }

    * {
      scrollbar-width: thin;
      scrollbar-color: var(--color-border) transparent;
    }

    *::-webkit-scrollbar {
      width: 8px;
    }

    *::-webkit-scrollbar-track {
      background: transparent;
    }

    *::-webkit-scrollbar-thumb {
      background: var(--color-border);
      border-radius: 4px;
    }

    /* Resizer handle */
    #resizer-handle {
      position: fixed;
      width: 26px;
      height: 26px;
      right: 0px;
      bottom: 0px;
      cursor: se-resize;
      opacity: 1;
      /* background: var(--color-panel); */
      /* border: 1px solid var(--color-border); */
      /* border-radius: 10px; */
      /* transition: opacity var(--anim), background var(--anim), transform var(--anim); */
      z-index: 9999;
      /* box-shadow: var(--shadow-1); */
      pointer-events: auto;
      background-image: url("data:image/svg+xml;utf8,<svg viewBox='0 0 18 18' xmlns='http://www.w3.org/2000/svg' fill='%23f5a905' stroke='%23f5a905'><path fill='%23000000' d='M14.228 16.227a1 1 0 0 1-.707-1.707l1-1a1 1 0 0 1 1.416 1.414l-1 1a1 1 0 0 1-.707.293zm-5.638 0a1 1 0 0 1-.707-1.707l6.638-6.638a1 1 0 0 1 1.416 1.414l-6.638 6.638a1 1 0 0 1-.707.293zm-5.84 0a1 1 0 0 1-.707-1.707L14.52 2.043a1 1 0 1 1 1.415 1.414L3.457 15.934a1 1 0 0 1-.707.293z'></path></svg>");
      background-repeat: no-repeat;
      background-position: center;
      /* background-size: 16px; */
    }

    #resizer-handle:hover {
      opacity: 0.65;
      transform: scale(1.05);
    }

    body.dark #resizer-handle {
      background: #1f1f22;
      opacity: 0.42;
    }

    .progress {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .progress.hidden {
      display: none;
    }

    .progress-bar {
      width: 120px;
      height: 8px;
      border-radius: 999px;
      background: var(--color-border);
      position: relative;
      overflow: hidden;
    }

    .progress-bar::after {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(90deg, var(--color-primary) 0%, #5fb5ff 100%);
      width: 60%;
      animation: slide 1s infinite;
    }

    .progress-text {
      font-size: 12px;
      color: var(--color-text-secondary);
    }

    @keyframes slide {
      0% {
        transform: translateX(-100%);
      }

      50% {
        transform: translateX(0%);
      }

      100% {
        transform: translateX(100%);
      }
    }

    /* Linter Styles */
    #linter-panel {
      margin-top: 16px;
      border-top: 1px solid var(--color-border);
      padding-top: 16px;
    }

    .linter-summary {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
      padding: 12px;
      background: var(--color-bg);
      border-radius: var(--radius);
      align-items: center;
    }

    .linter-score {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: #fff;
      border: 3px solid var(--color-border);
      font-weight: 700;
    }

    .linter-score.success {
      border-color: #2ecc71;
      color: #2ecc71;
    }

    .linter-score.warning {
      border-color: #f1c40f;
      color: #f39c12;
    }

    .linter-score.error {
      border-color: #e74c3c;
      color: #e74c3c;
    }

    .score-value {
      font-size: 18px;
      line-height: 1;
    }

    .score-label {
      font-size: 9px;
      text-transform: uppercase;
      color: var(--color-text-secondary);
      margin-top: 2px;
    }

    .linter-stats {
      flex: 1;
      display: flex;
      gap: 12px;
    }

    .stat-item {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 8px;
      background: #fff;
      border-radius: 6px;
      border: 1px solid var(--color-border);
    }

    .stat-item .count {
      font-weight: 700;
      font-size: 16px;
    }

    .stat-item .label {
      font-size: 10px;
      color: var(--color-text-secondary);
    }

    .stat-item.error .count {
      color: #e74c3c;
    }

    .stat-item.warning .count {
      color: #f39c12;
    }

    .linter-issues {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 400px;
      overflow-y: auto;
    }

    .linter-issue {
      background: #fff;
      border: 1px solid var(--color-border);
      border-radius: 6px;
      padding: 10px;
      cursor: pointer;
      transition: var(--anim);
      border-left: 3px solid transparent;
    }

    .linter-issue:hover {
      transform: translateX(2px);
      box-shadow: var(--shadow-1);
    }

    .linter-issue.error {
      border-left-color: #e74c3c;
    }

    .linter-issue.warning {
      border-left-color: #f1c40f;
    }

    .issue-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }

    .issue-severity {
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      padding: 2px 6px;
      border-radius: 4px;
    }

    .issue-severity.error {
      background: #fadbd8;
      color: #c0392b;
    }

    .issue-severity.warning {
      background: #fcf3cf;
      color: #d68910;
    }

    .issue-message {
      font-size: 12px;
      font-weight: 500;
      flex: 1;
      margin-left: 8px;
    }

    .issue-details {
      font-size: 11px;
      color: var(--color-text-secondary);
      margin-top: 6px;
      padding-top: 6px;
      border-top: 1px solid #f0f0f0;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .issue-suggestion {
      color: var(--color-primary);
      font-style: italic;
    }

    .linter-empty {
      text-align: center;
      padding: 20px;
      color: var(--color-text-secondary);
      font-style: italic;
    }

    /* Linter Report UI */
    .linter-container {
      display: flex;
      flex-direction: column;
      gap: 16px;
      padding: 4px;
    }

    .linter-header {
      display: flex;
      gap: 16px;
      align-items: center;
      background: var(--figma-color-bg-secondary);
      padding: 12px;
      border-radius: 8px;
    }

    .linter-score-card {
      flex-shrink: 0;
    }

    .score-ring {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      border: 4px solid var(--figma-color-bg-brand);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: var(--figma-color-bg);
    }

    .score-value {
      font-size: 18px;
      font-weight: bold;
      line-height: 1;
    }

    .score-label {
      font-size: 9px;
      text-transform: uppercase;
      color: var(--figma-color-text-secondary);
    }

    .linter-stats {
      display: flex;
      gap: 12px;
      flex: 1;
    }

    .stat-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 4px 8px;
      border-radius: 4px;
      flex: 1;
      background: var(--figma-color-bg);
    }

    .stat-item.critical {
      border-bottom: 2px solid #e03e1a;
    }

    .stat-item.major {
      border-bottom: 2px solid #f3c11b;
    }

    .stat-item.minor {
      border-bottom: 2px solid #2f80ed;
    }

    .stat-count {
      font-weight: bold;
      font-size: 14px;
    }

    .stat-label {
      font-size: 10px;
      color: var(--figma-color-text-secondary);
    }

    .linter-actions-bar {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }

    .linter-content {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .issues-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .linter-issue-card {
      background: var(--figma-color-bg);
      border: 1px solid var(--figma-color-border);
      border-radius: 6px;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      transition: all 0.2s;
    }

    .linter-issue-card:hover {
      border-color: var(--figma-color-border-brand);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .issue-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 8px;
    }

    .issue-title {
      font-weight: 600;
      font-size: 12px;
      color: var(--figma-color-text);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .issue-badge {
      font-size: 9px;
      padding: 2px 6px;
      border-radius: 4px;
      text-transform: uppercase;
      font-weight: bold;
    }

    .issue-badge.critical {
      background: #fadbd8;
      color: #c0392b;
    }

    .issue-badge.major {
      background: #fcf3cf;
      color: #d68910;
    }

    .issue-badge.minor {
      background: #d6eaf8;
      color: #2980b9;
    }

    .issue-desc {
      font-size: 11px;
      color: var(--figma-color-text-secondary);
      line-height: 1.4;
    }

    .issue-actions {
      display: flex;
      gap: 8px;
      margin-top: 4px;
    }

    .widgets-section h3 {
      font-size: 12px;
      margin-bottom: 8px;
      color: var(--figma-color-text);
    }

    .widgets-table-container {
      border: 1px solid var(--figma-color-border);
      border-radius: 6px;
      overflow: hidden;
    }

    .widgets-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
    }

    .widgets-table th {
      background: var(--figma-color-bg-secondary);
      text-align: left;
      padding: 8px;
      font-weight: 600;
      color: var(--figma-color-text-secondary);
    }

    .widgets-table td {
      padding: 8px;
      border-top: 1px solid var(--figma-color-border);
      color: var(--figma-color-text);
    }

    .widgets-table tr:hover td {
      background: var(--figma-color-bg-hover);
    }

    .linter-empty-state {
      text-align: center;
      padding: 16px;
      background: var(--figma-color-bg-secondary);
      border-radius: 8px;
    }

    .empty-icon {
      font-size: 24px;
      margin-bottom: 8px;
    }

    /* ========== PROBLEM DETAILS PANEL STYLES ========== */
    .problem-details-panel {
      background: var(--figma-color-bg-secondary);
      border: 1px solid var(--figma-color-border);
      border-radius: 8px;
      padding: 16px;
      margin-top: 16px;
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--figma-color-border);
    }

    .panel-header h3 {
      font-size: 13px;
      font-weight: 600;
      margin: 0;
      color: var(--figma-color-text);
    }

    .panel-content {
      font-size: 11px;
      line-height: 1.5;
    }

    .problem-header {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 12px;
    }

    .problem-severity {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      padding: 3px 8px;
      border-radius: 4px;
      width: fit-content;
    }

    .problem-severity.critical {
      background: #fadbd8;
      color: #c0392b;
    }

    .problem-severity.major {
      background: #fcf3cf;
      color: #d68910;
    }

    .problem-severity.minor {
      background: #d6eaf8;
      color: #2980b9;
    }

    .problem-title {
      font-size: 12px;
      font-weight: 500;
      color: var(--figma-color-text);
      line-height: 1.4;
    }

    .problem-location {
      font-size: 10px;
      color: var(--figma-color-text-secondary);
      padding: 6px 0;
      border-bottom: 1px solid var(--figma-color-border);
      margin-bottom: 12px;
    }

    .problem-tip {
      background: var(--figma-color-bg);
      border-left: 3px solid var(--figma-color-border-brand);
      padding: 8px 10px;
      margin: 12px 0;
      border-radius: 4px;
    }

    .problem-tip p {
      margin: 0;
      font-size: 11px;
      line-height: 1.4;
      color: var(--figma-color-text-secondary);
    }

    .problem-tip strong {
      color: var(--figma-color-text);
    }

    .problem-guide {
      margin-top: 12px;
    }

    .problem-guide h4 {
      font-size: 11px;
      font-weight: 600;
      margin: 0 0 8px 0;
      color: var(--figma-color-text);
    }

    .guide-steps {
      margin: 0;
      padding-left: 20px;
      list-style: none;
      counter-reset: step-counter;
    }

    .guide-steps li {
      counter-increment: step-counter;
      margin-bottom: 6px;
      font-size: 11px;
      line-height: 1.4;
      color: var(--figma-color-text-secondary);
      position: relative;
    }

    .guide-steps li::before {
      content: counter(step-counter);
      position: absolute;
      left: -20px;
      top: 0;
      width: 16px;
      height: 16px;
      background: var(--figma-color-bg-brand);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 9px;
      font-weight: 600;
    }

    .panel-actions {
      display: flex;
      gap: 6px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--figma-color-border);
    }

    .panel-actions .btn {
      flex: 1;
      font-size: 11px;
      padding: 6px 10px;
    }
  </style>
</head>

<body>
  <div id="runtime-health" style="display:none"></div>
  <input id="useDeterministic" type="checkbox" style="display:none" aria-hidden="true" />
  <input id="telemetryEnabled" type="checkbox" style="display:none" aria-hidden="true" />
  <input id="telemetryStoreDiffs" type="checkbox" style="display:none" aria-hidden="true" />
  <input id="telemetryStoreSnapshots" type="checkbox" style="display:none" aria-hidden="true" />
  <div class="app">
    <header class="topbar">
      <div class="brand">
        <div class="brand-title">Figma to WP Elementor</div>
        <div class="brand-subtitle">Convers&#227;o inteligente de Layouts para WP Elementor</div>
      </div>
      <div class="top-actions">
        <label class="switch" title="Alternar tema">
          <input type="checkbox" id="theme-toggle" />
          <span class="slider">
            <span class="sun">&#9728;</span>
            <span class="moon">&#127769;</span>
          </span>
        </label>
      </div>
    </header>

    <nav class="tabs">
      <button class="tab-btn active" data-tab="layout">Layout &rarr; Elementor</button>
      <button class="tab-btn" data-tab="linter">Linter</button>
      <button class="tab-btn" data-tab="ai">Configura&#231;&#227;o da IA</button>
      <button class="tab-btn" data-tab="wp">WordPress</button>
      <button class="tab-btn" data-tab="help">Ajuda</button>
      <span class="tab-indicator"></span>
    </nav>

    <main class="tab-panels">
      <section class="tab-panel active" data-panel="layout">
        <div class="card">
          <div class="card-title">A&#231;&#245;es r&#225;pidas</div>
          <div class="row">
            <button id="btn_inspect" class="btn secondary">Inspecionar Layout</button>
            <button id="btn_analyze" class="btn secondary">🔍 Analisar Layout</button>
            <button id="btn_generate" class="btn primary">Gerar JSON</button>
            <button id="btn_reset" class="btn secondary" data-action="reset">Reiniciar</button>
          </div>
        </div>

        <!-- Linter Panel -->
        <div id="linter-panel" class="card" style="display: none;">
          <div class="card-title" style="display: flex; justify-content: space-between; align-items: center;">
            <span>Relatório de Análise</span>
            <button id="btn_close_linter" class="btn tiny secondary">Fechar</button>
          </div>

          <div id="linter-summary" class="linter-summary"></div>
          <div id="linter-issues" class="linter-issues"></div>
        </div>
        <div class="card">
          <div id="progress" class="progress hidden">
            <div class="progress-bar"></div>
            <span class="progress-text">Processando pipeline...</span>
          </div>
          <textarea id="output" placeholder="O JSON gerado aparecer&#225; aqui" readonly></textarea>
          <div id="logs" class="logs"></div>
          <div style="margin-top:12px;">
            <label style="display:block;font-size:12px;margin-bottom:6px;">JSON gerado (selecionamos automaticamente; se
              precisar use Ctrl+C):</label>
            <textarea id="figma-json-output" style="width:100%;height:200px"
              placeholder="JSON para copiar/colar no Elementor"></textarea>
            <div style="display:flex;gap:8px;margin-top:8px;align-items:center;">
              <button class="btn secondary" id="copy-manual">Copiar JSON</button>
              <span style="font-size:12px;color:#999;">Se o navegador bloquear, selecione o campo e pressione
                Ctrl+C.</span>
            </div>
          </div>
        </div>
      </section>

      <section class="tab-panel" data-panel="linter">
        <div class="linter-container">
          <!-- Header / Summary -->
          <div class="linter-header">
            <div class="linter-score-card">
              <div class="score-ring" id="linter-score-ring">
                <span class="score-value" id="linter-total-issues">0</span>
                <span class="score-label">Issues</span>
              </div>
            </div>
            <div class="linter-stats">
              <div class="stat-item critical">
                <span class="stat-count" id="count-critical">0</span>
                <span class="stat-label">Critical</span>
              </div>
              <div class="stat-item major">
                <span class="stat-count" id="count-major">0</span>
                <span class="stat-label">Major</span>
              </div>
              <div class="stat-item minor">
                <span class="stat-count" id="count-minor">0</span>
                <span class="stat-label">Minor</span>
              </div>
            </div>
          </div> <!-- Educational Banner -->
          <div class="linter-education-banner"
            style="background: var(--figma-color-bg-brand-tertiary); border-left: 3px solid var(--figma-color-border-brand); padding: 10px 12px; margin: 12px 0; border-radius: 4px;">
            <p style="margin: 0; font-size: 11px; line-height: 1.5; color: var(--figma-color-text-secondary);">
              <strong style="color: var(--figma-color-text);">Por que nomenclatura importa:</strong><br>Facilita
              manutenção Melhora detecção automática Gera código Elementor mais legível Reduz erros na exportação

            </p>
          </div>


          <!-- Actions Bar -->
          <div class="linter-actions-bar">
            <button class="btn secondary small" id="btn-copy-report" style="display:none"
              data-action="copy-linter-report">
              <span class="icon">📋</span> Copiar
            </button>
          </div>

          <!-- Issues List -->
          <div class="linter-content">
            <div id="linter-issues-list" class="issues-list">
              <!-- Issues will be injected here -->
              <div class="linter-empty-state">
                <div class="empty-icon">✨</div>
                <h3>Nenhum problema encontrado</h3>
                <p>Seu layout parece estar seguindo todas as boas práticas!</p>
              </div>
            </div>

            <!-- Problem Details Panel (Hidden by default) -->
            <div id="problem-details-panel" class="problem-details-panel" style="display:none;">
              <div class="panel-header">
                <h3>🎯 Problema Selecionado</h3>
                <button id="btn-close-details" class="btn tiny ghost">✖</button>
              </div>

              <div id="problem-details-content" class="panel-content">
                <!-- Content will be injected here -->
              </div>

              <div class="panel-actions">
                <button id="btn-mark-resolved" class="btn primary small">
                  ✅ Marcar como Resolvido
                </button>
                <button id="btn-next-problem" class="btn secondary small">
                  ⏭️ Próximo
                </button>
                <button id="btn-ignore-problem" class="btn ghost small">
                  ❌ Ignorar
                </button>
              </div>
            </div>


            <!-- Widgets Table -->
            <div class="widgets-section">
              <h3>🎨 Widgets Detectados (<span id="widgets-count">0</span>)</h3>
              <div class="widgets-table-container">
                <table class="widgets-table">
                  <thead>
                    <tr>
                      <th>Widget</th>
                      <th>Node</th>
                      <th>Confiança</th>
                    </tr>
                  </thead>
                  <tbody id="widgets-table-body">
                    <!-- Widgets will be injected here -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </section>

      <section class="tab-panel" data-panel="ai">
        <div class="card">
          <div class="card-title">Configura&#231;&#227;o da IA</div>
          <label class="checkbox">
            <input id="use_ai" type="checkbox" checked />
            <span>Usar IA para convers&#227;o</span>
          </label>
          <label class="input-label" for="provider_ai">Provedor de IA</label>
          <select id="provider_ai">
            <option value="gemini">Gemini</option>
            <option value="gpt">GPT (OpenAI)</option>
          </select>

          <div id="ai_settings">
            <div class="provider-block provider-gemini">
              <label class="input-label" for="gemini_api_key">Gemini API Key</label>
              <input id="gemini_api_key" type="password" autocomplete="off" placeholder="Cole sua API Key do Gemini" />
              <label class="input-label" for="gemini_model">Modelo</label>
              <select id="gemini_model">
                <option value="gemini-2.0-flash-exp">gemini-2.0-flash-exp (Experimental)</option>
                <option value="gemini-1.5-pro-002">gemini-1.5-pro-002 (Stable)</option>
                <option value="gemini-1.5-flash-002">gemini-1.5-flash-002 (Fast & Stable)</option>
              </select>
              <div class="actions">
                <button class="btn primary" data-action="test-gemini">Testar conex&#227;o</button>
              </div>
              <div id="gemini-status" class="status"></div>
            </div>

            <div class="provider-block provider-gpt">
              <label class="input-label" for="gpt_api_key">OpenAI API Key</label>
              <input id="gpt_api_key" type="password" autocomplete="off" placeholder="Cole sua chave da OpenAI" />
              <label class="input-label" for="gpt_model">Modelo GPT</label>
              <select id="gpt_model">
                <option value="gpt-4.1-mini">gpt-4.1-mini (recomendado)</option>
                <option value="gpt-4.1">gpt-4.1</option>
                <option value="gpt-4.1-preview">gpt-4.1-preview</option>
                <option value="gpt-o1">gpt-o1</option>
                <option value="gpt-o3-mini">gpt-o3-mini</option>
              </select>
              <div class="actions">
                <button class="btn primary" data-action="test-gpt">Testar conex&#227;o GPT</button>
              </div>
              <div id="gpt-status" class="status"></div>
            </div>
          </div>
          <div class="checkbox-group">
            <label class="checkbox">
              <input id="include_screenshot" type="checkbox" checked />
              <span>Enviar print do frame para a IA (Melhora precis&#227;o)</span>
            </label>
            <label class="checkbox">
              <input id="include_references" type="checkbox" checked />
              <span>Enviar arquivos de refer&#234;ncia (.md) junto com o pedido</span>
            </label>
          </div>
      </section>

      <section class="tab-panel" data-panel="wp">
        <div class="card">
          <div class="card-title">WordPress</div>
          <label class="input-label" for="wp_url">WP URL</label>
          <input id="wp_url" type="text" autocomplete="off" placeholder="https://site.com" />

          <label class="input-label" for="wp_user">Usu&#225;rio WP</label>
          <input id="wp_user" type="text" autocomplete="username" placeholder="usu&#225;rio" />

          <label class="input-label" for="wp_token">Senha do App (Token)</label>
          <input id="wp_token" type="password" autocomplete="current-password"
            placeholder="Senha de aplica&#231;&#227;o do WP" />

          <label class="checkbox">
            <input id="wp_export_images" type="checkbox" />
            <span>Exportar imagens automaticamente</span>
          </label>

          <div class="slider-group" id="webp_quality_group" style="margin: 12px 0; display: none;">
            <label class="input-label" for="wp_webp_quality">Qualidade WebP: <span
                id="webp_quality_value">85</span>%</label>
            <input id="wp_webp_quality" type="range" min="0" max="100" value="85" style="width: 100%;" />
          </div>

          <div class="actions">
            <button class="btn primary" data-action="test-wp">Testar conex&#227;o</button>
            <button class="btn secondary" data-action="export-wp">Exportar WP</button>
          </div>
          <div id="wp-status" class="status"></div>
        </div>
      </section>

      <section class="tab-panel" data-panel="help">
        <!-- Nomenclature Guide -->


        <!-- Widget Search -->
        <div class="search-box">
          <input type="text" id="widget-search" class="search-input"
            placeholder="Buscar widget (ex: button, woo, pro)..." autocomplete="off" />
        </div>
        <div id="widget-list-container"></div>
      </section>
    </main>
  </div>
  <div id="resizer-handle" aria-label="Arraste para redimensionar"></div>

<script>
  parent.postMessage(
    { pluginMessage: { diagnosticPing: true } },
    "*"
  );
  console.log("[diagnostic] UI loaded, ping enviado");
</script>
<script>
    (() => {
      const tabs = document.querySelectorAll('.tab-btn');
      const panels = document.querySelectorAll('.tab-panel');
      const indicator = document.querySelector('.tab-indicator');
      const output = document.getElementById('output');
      const logs = document.getElementById('logs');
      const btnInspect = document.getElementById('btn_inspect');
      const btnDownload = document.querySelector('[data-action="download-json"]');
      const btnCopy = document.querySelector('[data-action="copy-json"]');
      const btnExport = document.querySelector('[data-action="export-wp"]');

      document.getElementById('btn_generate').onclick = () => {
        const payload = {
          type: 'generate-json',
          apiKey: fields.gpt_api_key?.value || '',
          gptModel: fields.gpt_model?.value || '',
          geminiModel: fields.gemini_model?.value || '',
          includeScreenshot: fields.include_screenshot?.checked !== false,
          includeReferences: fields.include_references?.checked !== false,
          autoRename: fields.auto_rename_layers?.checked || false,
          useDeterministic: fields.use_deterministic?.checked || false,
          telemetryEnabled: fields.telemetry_enabled?.checked || false,
          telemetryStoreDiffs: fields.telemetry_store_diffs?.checked || false,
          telemetryStoreSnapshots: fields.telemetry_store_snapshots?.checked || false
        };
        // ... rest of generate logic
        send('generate-json', payload);
      };



      document.getElementById('btn_inspect').onclick = () => {
        send('inspect');
      };
      const themeToggle = document.getElementById('theme-toggle');
      const darkSheet = document.getElementById('theme-dark');
      const bridgeOutput = document.getElementById('figma-json-output');
      const btnCopyManual = document.getElementById('copy-manual');
      let lastPayload = '';
      let fullPayload = '';





      const fields = {
        use_ai: document.getElementById('use_ai'),
        use_deterministic: document.getElementById('useDeterministic'),
        telemetry_enabled: document.getElementById('telemetryEnabled'),
        telemetry_store_diffs: document.getElementById('telemetryStoreDiffs'),
        telemetry_store_snapshots: document.getElementById('telemetryStoreSnapshots'),
        provider_ai: document.getElementById('provider_ai'),
        gemini_api_key: document.getElementById('gemini_api_key'),
        gemini_model: document.getElementById('gemini_model'),
        gpt_api_key: document.getElementById('gpt_api_key'),
        gpt_model: document.getElementById('gpt_model'),
        include_screenshot: document.getElementById('include_screenshot'),
        include_references: document.getElementById('include_references'),
        wp_url: document.getElementById('wp_url'),
        wp_user: document.getElementById('wp_user'),
        wp_token: document.getElementById('wp_token'),
        wp_export_images: document.getElementById('wp_export_images'),
        wp_webp_quality: document.getElementById('wp_webp_quality'),
        webp_quality_group: document.getElementById('webp_quality_group'),
        webp_quality_value: document.getElementById('webp_quality_value')
      };
      const aiSettings = document.getElementById('ai_settings');

      const storage = null; // desativado para evitar SecurityError em sandbox
      const updateBridgeOutput = (value, autoSelect = false) => {
        if (!bridgeOutput) return;
        bridgeOutput.value = value || '';
        if (autoSelect) {
          requestAnimationFrame(() => {
            bridgeOutput.focus();
            bridgeOutput.select();
          });
        }
      };

      function debounce(fn, wait = 300) {
        let t;
        return (...args) => {
          clearTimeout(t);
          t = setTimeout(() => fn(...args), wait);
        };
      }

      function updateIndicator() {
        const active = document.querySelector('.tab-btn.active');
        if (!indicator || !active || !active.parentElement) return;
        const rect = active.getBoundingClientRect();
        const parentRect = active.parentElement.getBoundingClientRect();
        indicator.style.width = `${rect.width}px`;
        indicator.style.transform = `translateX(${rect.left - parentRect.left}px)`;
      }

      function setActiveTab(name) {
        tabs.forEach(t => t.classList.toggle('active', t.dataset.tab === name));
        panels.forEach(p => p.classList.toggle('active', p.dataset.panel === name));
        updateIndicator();
      }

      function setProvider(providerId) {
        const value = providerId === 'gpt' ? 'gpt' : 'gemini';
        document.body?.setAttribute('data-provider', value);
        if (fields.provider_ai) fields.provider_ai.value = value;
      }

      function toggleAIFields(enabled) {
        document.body?.setAttribute('data-use-ai', enabled ? 'true' : 'false');
        if (aiSettings) {
          aiSettings.classList.toggle('ai-hidden', !enabled);
        }
      }

      tabs.forEach(btn => btn.addEventListener('click', () => setActiveTab(btn.dataset.tab)));

      function applyTheme(isDark) {
        document.documentElement.classList.toggle('dark', isDark);
        if (themeToggle) themeToggle.checked = isDark;
        if (darkSheet) darkSheet.disabled = !isDark;
        if (storage) {
          try { storage.setItem('figtoel-theme', isDark ? 'dark' : 'light'); } catch (e) { /* ignore */ }
        }
      }

      function initTheme(pref) {
        let stored = null;
        if (storage) {
          try { stored = storage.getItem('figtoel-theme'); } catch (e) { stored = null; }
        }
        const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        if (typeof pref === 'boolean') applyTheme(pref);
        else applyTheme(stored === 'dark' || (stored === null && prefersDark));
      }

      if (themeToggle) {
        themeToggle.addEventListener('change', () => {
          applyTheme(themeToggle.checked);
          send('save-setting', { key: 'gptel_dark_mode', value: themeToggle.checked });
        });
      }

      function send(type, payload = {}) {
        // FORENSIC LOG
        if (type === 'analyze-layout') {
          console.error('⚠️⚠️⚠️ [UI FORENSIC] send("analyze-layout") CHAMADO!');
          console.error('⚠️ Stack trace:', new Error().stack);
          console.error('⚠️ Payload:', payload);
        }
        parent.postMessage({ pluginMessage: { type, ...payload } }, '*');
      }
      window.send = send;

      function addLog(message, level = 'info') {
        if (!logs) return;
        const now = new Date();
        const time = now.toLocaleTimeString('pt-BR', { hour12: false });
        const div = document.createElement('div');
        div.textContent = `[${time}] [${level}] ${message}`;
        logs.appendChild(div);
        logs.scrollTo(0, logs.scrollHeight);
      }

      async function copyWithFallback(text, label = 'contedo') {
        if (!text) {
          addLog(`Nenhum ${label} para copiar.`, 'warn');
          return false;
        }
        try {
          if (navigator.clipboard && navigator.clipboard.writeText) {
            await navigator.clipboard.writeText(text);
            addLog(` ${label} copiado!`, 'info');
            return true;
          }
        } catch (err) {
          console.warn('Clipboard API falhou:', err);
        }
        try {
          const textarea = document.createElement('textarea');
          textarea.value = text;
          textarea.style.position = 'fixed';
          textarea.style.opacity = '0';
          document.body.appendChild(textarea);
          textarea.select();
          const success = document.execCommand('copy');
          document.body.removeChild(textarea);
          if (success) {
            addLog(` ${label} copiado!`, 'info');
            return true;
          }
        } catch (err) {
          addLog(` Falha ao copiar. Use Ctrl+C.`, 'error');
        }
        return false;
      }

      function loadStoredSettings(payload) {
        if (!payload) return;
        const useAI = payload.useAI;
        if (fields.use_ai) {
          const val = typeof useAI === 'boolean' ? useAI : true;
          fields.use_ai.checked = val;
          toggleAIFields(val);
        }
        if (fields.provider_ai) setProvider(payload.providerAi || 'gemini');
        if (fields.gemini_api_key) fields.gemini_api_key.value = payload.geminiKey || '';
        if (fields.gemini_model && payload.geminiModel) {
          fields.gemini_model.value = payload.geminiModel;
          addLog(`Modelo carregado: ${payload.geminiModel}`, 'info');
        }
        if (fields.gpt_api_key) fields.gpt_api_key.value = payload.gptKey || '';
        if (fields.gpt_model && payload.gptModel) fields.gpt_model.value = payload.gptModel;
        if (fields.include_screenshot) fields.include_screenshot.checked = payload.includeScreenshot !== false;
        if (fields.include_references) fields.include_references.checked = payload.includeReferences !== false;
        if (fields.wp_url) fields.wp_url.value = payload.wpUrl || '';
        if (fields.wp_user) fields.wp_user.value = payload.wpUser || '';
        if (fields.wp_token) fields.wp_token.value = payload.wpToken || '';
        if (fields.wp_export_images) {
          fields.wp_export_images.checked = !!payload.exportImages;
          // Toggle slider visibility based on export images checkbox
          if (fields.webp_quality_group) {
            fields.webp_quality_group.style.display = payload.exportImages ? 'block' : 'none';
          }
        }
        if (fields.wp_webp_quality) {
          const quality = payload.webpQuality !== undefined ? payload.webpQuality : 85;
          fields.wp_webp_quality.value = quality;
          if (fields.webp_quality_value) fields.webp_quality_value.textContent = quality;
        }
        if (typeof payload.darkMode === 'boolean') applyTheme(payload.darkMode);
        updateIndicator();
      }

      function watchInputs() {
        const saveText = (key, el) => debounce(() => send('save-setting', { key, value: el.value }));
        if (fields.use_ai) {
          fields.use_ai.addEventListener('change', () => {
            const enabled = fields.use_ai.checked;
            toggleAIFields(enabled);
            send('save-setting', { key: 'gptel_use_ai', value: enabled });
          });
        }
        if (fields.provider_ai) {
          fields.provider_ai.addEventListener('change', () => {
            setProvider(fields.provider_ai.value);
            send('save-setting', { key: 'aiProvider', value: fields.provider_ai.value });
          });
        }
        if (fields.gemini_api_key) fields.gemini_api_key.addEventListener('input', saveText('gptel_gemini_key', fields.gemini_api_key));
        if (fields.gemini_model) {
          fields.gemini_model.addEventListener('change', () => {
            send('save-setting', { key: 'gemini_model', value: fields.gemini_model.value });
            addLog(`Modelo alterado para: ${fields.gemini_model.value}`, 'info');
          });
        }
        if (fields.gpt_api_key) fields.gpt_api_key.addEventListener('input', saveText('gptApiKey', fields.gpt_api_key));
        if (fields.gpt_model) fields.gpt_model.addEventListener('change', () => send('save-setting', { key: 'gptModel', value: fields.gpt_model.value }));
        if (fields.include_screenshot) fields.include_screenshot.addEventListener('change', () => send('save-setting', { key: 'gptel_include_screenshot', value: fields.include_screenshot.checked }));
        if (fields.include_references) fields.include_references.addEventListener('change', () => send('save-setting', { key: 'gptel_include_references', value: fields.include_references.checked }));
        if (fields.wp_url) fields.wp_url.addEventListener('input', saveText('gptel_wp_url', fields.wp_url));
        if (fields.wp_user) fields.wp_user.addEventListener('input', saveText('gptel_wp_user', fields.wp_user));
        if (fields.wp_token) fields.wp_token.addEventListener('input', saveText('gptel_wp_token', fields.wp_token));
        if (fields.wp_export_images) {
          fields.wp_export_images.addEventListener('change', () => {
            const checked = fields.wp_export_images.checked;
            send('save-setting', { key: 'gptel_export_images', value: checked });
            // Toggle slider visibility
            if (fields.webp_quality_group) {
              fields.webp_quality_group.style.display = checked ? 'block' : 'none';
            }
          });
        }
        if (fields.wp_webp_quality) {
          fields.wp_webp_quality.addEventListener('input', () => {
            const quality = fields.wp_webp_quality.value;
            if (fields.webp_quality_value) fields.webp_quality_value.textContent = quality;
            send('save-setting', { key: 'gptel_webp_quality', value: parseInt(quality) });
          });
        }
      }

      function bindActions() {
        document.querySelectorAll('[data-action]').forEach(btn => {
          btn.addEventListener('click', () => {
            if (btn.disabled && ['copy-json', 'download-json', 'export-wp'].includes(btn.getAttribute('data-action') || '')) {
              return;
            }
            const action = btn.getAttribute('data-action');
            if (fields.gemini_model && fields.gemini_model.value) {
              send('save-setting', { key: 'gemini_model', value: fields.gemini_model.value });
            }
            const payload = {
              useAI: fields.use_ai?.checked !== false,
              providerAi: fields.provider_ai?.value || 'gemini',
              gptModel: fields.gpt_model?.value || '',
              wpConfig: {
                url: fields.wp_url?.value || '',
                user: fields.wp_user?.value || '',
                token: fields.wp_token?.value || '',
                exportImages: fields.wp_export_images?.checked || false,
                webpQuality: parseInt(fields.wp_webp_quality?.value || 85)
              },
              apiKey: fields.gemini_api_key?.value || '',
              gptApiKey: fields.gpt_api_key?.value || '',
              geminiModel: fields.gemini_model?.value || '',
              includeScreenshot: fields.include_screenshot?.checked !== false,
              includeReferences: fields.include_references?.checked !== false,
              useDeterministic: fields.use_deterministic?.checked || false,
              telemetryEnabled: fields.telemetry_enabled?.checked || false,
              telemetryStoreDiffs: fields.telemetry_store_diffs?.checked || false,
              telemetryStoreSnapshots: fields.telemetry_store_snapshots?.checked || false
            };
            if (payload.geminiModel) {
              send('save-setting', { key: 'gemini_model', value: payload.geminiModel });
            }
            if (payload.gptModel) {
              send('save-setting', { key: 'gptModel', value: payload.gptModel });
            }
            switch (action) {
              case 'inspect-layout': send('inspect'); break;
              case 'generate-json':
                toggleProgress(true);
                send('generate-json', payload);
                break;
              case 'optimize-structure': send('optimize-structure', payload); break;
              case 'analyze-widgets': send('analyze-widgets', payload); break;
              case 'copy-json':
                if (lastPayload) {
                  copyToClipboard(lastPayload);
                } else {
                  send('copy-json');
                }
                break;
              case 'download-json':
                if (fullPayload || lastPayload) {
                  downloadPayload(fullPayload || lastPayload);
                } else {
                  send('download-json');
                }
                break;
              case 'reset':
                if (output) output.value = '';
                if (logs) logs.innerHTML = '';
                if (fields.gemini_model) fields.gemini_model.value = fields.gemini_model.options[0]?.value || '';
                updateBridgeOutput('', false);
                updateBridgeOutput('', false);
                lastPayload = '';
                fullPayload = '';
                toggleProgress(false);
                toggleResultButtons(false);
                addLog('Sessao reiniciada.', 'info');
                send('reset');
                break;
                if (fields.gemini_model) fields.gemini_model.value = fields.gemini_model.options[0]?.value || '';
                updateBridgeOutput('', false);
                updateBridgeOutput('', false);
                lastPayload = '';
                fullPayload = '';
                toggleProgress(false);
                toggleResultButtons(false);
                addLog('Sessao reiniciada.', 'info');
                send('reset');
                break;
              case 'test-gemini': send('test-gemini', { apiKey: payload.apiKey }); break;
              case 'test-gpt': send('test-gpt', { apiKey: payload.gptApiKey, model: payload.gptModel || fields.gpt_model?.value }); break;
              case 'test-wp': send('test-wp', { wpConfig: payload.wpConfig }); break;
              case 'resize-ui': send('resize-ui', { width: Math.min(window.innerWidth + 200, 1400), height: Math.min(window.innerHeight + 200, 1000) }); break;
              default: send(action || 'noop', payload);
            }
          });
        });
        document.querySelectorAll('[data-rename]').forEach(btn => {
          btn.addEventListener('click', () => {
            const name = btn.getAttribute('data-rename');
            send('rename-layer', { name });
          });
        });
      }

      async function convertToWebP(uint8Array, originalMime) {
        const blob = new Blob([new Uint8Array(uint8Array)], { type: originalMime });
        const url = URL.createObjectURL(blob);
        const img = new Image();
        await new Promise((resolve, reject) => {
          img.onload = resolve;
          img.onerror = reject;
          img.src = url;
        });

        const canvas = document.createElement('canvas');
        canvas.width = img.width;
        canvas.height = img.height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0);

        return new Promise(resolve => {
          // Get quality from slider (0-100) and convert to 0-1 range
          const qualitySlider = document.getElementById('wp_webp_quality');
          const quality = qualitySlider ? parseInt(qualitySlider.value) / 100 : 0.85;

          canvas.toBlob(blob => {
            URL.revokeObjectURL(url);
            resolve(blob);
          }, 'image/webp', quality);
        });
      }

      async function uploadImage(msg) {
        const { id, name, mimeType, data, needsConversion } = msg;
        const url = (fields.wp_url.value || '').replace(/\/$/, '');
        const user = fields.wp_user.value;
        const token = fields.wp_token.value;

        if (!url || !user || !token) {
          send('upload-image-response', { id, success: false, error: 'Credenciais WP ausentes na UI' });
          return;
        }

        try {
          let blob;
          addLog('[UI] Uploading image: ' + name + ' needsConversion: ' + needsConversion, 'info');
          if (needsConversion) {
            addLog('[UI] Converting to WebP...', 'info');
            try {
              blob = await convertToWebP(data, mimeType);
            } catch (e) {
              console.warn('[UI] WebP conversion failed:', e);
              addLog('[UI] WebP conversion failed. Using original format.', 'warn');
              blob = new Blob([new Uint8Array(data)], { type: mimeType || 'image/png' });
            }
            addLog('[UI] Converted blob type: ' + blob.type + ' size: ' + blob.size, 'info');
          } else {
            blob = new Blob([new Uint8Array(data)], { type: mimeType });
            addLog('[UI] Using original blob type: ' + blob.type, 'info');
          }

          const formData = new FormData();
          formData.append('file', blob, name);
          formData.append('title', name.split('.')[0]);
          formData.append('caption', 'Exported via FigToEL');

          const auth = btoa(`${user}:${token}`);
          const resp = await fetch(`${url}/wp-json/wp/v2/media`, {
            method: 'POST',
            headers: {
              'Authorization': `Basic ${auth}`
            },
            body: formData
          });

          if (!resp.ok) {
            const errText = await resp.text();
            throw new Error(`HTTP ${resp.status}: ${errText}`);
          }

          const json = await resp.json();
          send('upload-image-response', { id, success: true, url: json.source_url, wpId: json.id });

        } catch (e) {
          send('upload-image-response', { id, success: false, error: e.message });
        }
      }

      window.onmessage = (event) => {
        const msg = (event.data || {}).pluginMessage;
        if (!msg) return;
        switch (msg.type) {
          case 'runtime-health': {
            const runtimeEl = document.getElementById('runtime-health');
            if (runtimeEl) {
              runtimeEl.textContent = msg.status || 'unknown';
              runtimeEl.dataset.status = msg.status || 'unknown';
              if (Array.isArray(msg.warnings)) {
                runtimeEl.dataset.warnings = msg.warnings.join(',');
              }
            }
            break;
          }
          case 'preview':
            // Preview = Figma JSON (readonly) -> #output
            if (output) output.value = msg.payload || '';
            break;
          case 'generation-complete':
            // Generation = Elementor JSON (editable) -> #figma-json-output
            // Use pastePayload (elements array) for display/copy, keep payload (full) for download
            lastPayload = msg.pastePayload || msg.payload || '';
            fullPayload = msg.payload || '';
            updateBridgeOutput(lastPayload, true);
            addLog('JSON gerado.', 'info');
            toggleProgress(false);
            toggleResultButtons(true);
            break;
          case 'copy-json': {
            const txt = msg.payload || '';
            lastPayload = txt;
            updateBridgeOutput(txt, true);
            addLog('JSON pronto para copiar. Clique em "Copiar JSON" ou use Ctrl+C.', 'info');
            break;
          }
          case 'clipboard:copy': {
            copyWithFallback(msg.payload || '', 'JSON');
            break;
          }
          case 'generation-error':
            toggleProgress(false);
            toggleResultButtons(false);
            alert(`Erro na geracao: ${msg.message}`);
            break;
          case 'generation-start':
            toggleProgress(true);
            updateBridgeOutput('', false);
            // No limpamos o #output (Figma JSON) pois o usurio pode querer consult-lo
            toggleResultButtons(false);
            break;
          case 'gemini-status':
            addLog(msg.message || 'Status Gemini', msg.success ? 'success' : 'error');
            const gs = document.getElementById('gemini-status');
            if (gs) gs.textContent = msg.message;
            break;
          case 'gpt-status':
            addLog(msg.message || 'Status GPT', msg.success ? 'success' : 'error');
            const gptStatus = document.getElementById('gpt-status');
            if (gptStatus) gptStatus.textContent = msg.message;
            break;
          case 'upload-image-request':
            uploadImage(msg);
            break;
          case 'load-settings':
            console.log('📥 [UI] Recebendo configurações:', msg.payload);
            if (msg.payload) {
              // Gemini
              if (msg.payload.geminiKey && fields.gemini_api_key) {
                fields.gemini_api_key.value = msg.payload.geminiKey;
                console.log('✅ Gemini Key carregada');
              }
              if (msg.payload.geminiModel && fields.gemini_model) {
                fields.gemini_model.value = msg.payload.geminiModel;
              }

              // GPT
              if (msg.payload.gptKey && fields.gpt_api_key) {
                fields.gpt_api_key.value = msg.payload.gptKey;
                console.log('✅ GPT Key carregada');
              }
              if (msg.payload.gptModel && fields.gpt_model) {
                fields.gpt_model.value = msg.payload.gptModel;
              }

              // WordPress
              if (msg.payload.wpUrl && fields.wp_url) {
                fields.wp_url.value = msg.payload.wpUrl;
                console.log('✅ WP URL carregada:', msg.payload.wpUrl);
              }
              if (msg.payload.wpUser && fields.wp_user) {
                fields.wp_user.value = msg.payload.wpUser;
                console.log('✅ WP User carregado');
              }
              if (msg.payload.wpToken && fields.wp_token) {
                fields.wp_token.value = msg.payload.wpToken;
                console.log('✅ WP Token carregado');
              }

              // Provider
              if (msg.payload.providerAi) {
                if (fields.provider_ai) {
                  fields.provider_ai.value = msg.payload.providerAi;
                }
                setProvider(msg.payload.providerAi);
                console.log('✅ Provider setado:', msg.payload.providerAi);
              }

              // Checkboxes
              if (fields.use_ai !== undefined) {
                fields.use_ai.checked = msg.payload.useAI !== false;
              }
              if (fields.export_images !== undefined) {
                fields.export_images.checked = msg.payload.exportImages === true;
              }
              if (fields.auto_page !== undefined) {
                fields.auto_page.checked = msg.payload.autoPage === true;
              }

              console.log('✅ [UI] Todas as configurações aplicadas!');
              addLog('Configurações carregadas com sucesso', 'success');
            }
            break;

          case 'linter-report':
            const report = msg.payload;
            console.log('📊 [UI] Recebendo relatório do Linter:', report);

            // Renderizar visualmente
            renderLinterReport(report);

            // Mudar para a aba do Linter automaticamente
            setActiveTab('linter');

            // Log no console para debug (mantido)
            addLog(`📊 Análise concluída: ${report.summary.total} issues encontrados.`, 'info');
            break;
        }
      };

      bindActions();
      watchInputs();
      initTheme();
      setProvider(fields.provider_ai?.value || 'gemini');
      toggleAIFields(fields.use_ai?.checked !== false);
      send('load-settings');
      setActiveTab('layout');
      if (fields.wp_token) fields.wp_token.setAttribute('type', 'password');

      function toggleResultButtons(enabled) {
        if (btnCopy) btnCopy.disabled = !enabled;
        if (btnDownload) btnDownload.disabled = !enabled;
        if (btnExport) btnExport.disabled = !enabled;
      }
      toggleResultButtons(false);

      function toggleProgress(show) {
        if (!progress) return;
        if (show) {
          progress.classList.remove('hidden');
          progress.style.display = 'flex';
        } else {
          progress.classList.add('hidden');
          progress.style.display = 'none';
        }
      }

      const copyToClipboard = (text) => copyWithFallback(text, 'JSON');

      function downloadPayload(text) {
        const blob = new Blob([text], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'elementor.json';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        addLog('Download iniciado.', 'info');
      }

      // Resizer handle
      const resizer = document.getElementById('resizer-handle');
      if (resizer) {
        let startX = 0, startY = 0, startW = window.innerWidth, startH = window.innerHeight;
        const onMove = (clientX, clientY) => {
          const newW = Math.min(1500, Math.max(600, startW + (clientX - startX)));
          const newH = Math.min(1000, Math.max(500, startH + (clientY - startY)));
          send('resize-ui', { width: newW, height: newH });
        };
        const onMouseMove = (e) => { e.preventDefault(); onMove(e.clientX, e.clientY); };
        const onMouseUp = () => {
          window.removeEventListener('mousemove', onMouseMove);
          window.removeEventListener('mouseup', onMouseUp);
        };
        resizer.addEventListener('mousedown', (e) => {
          e.preventDefault();
          startX = e.clientX;
          startY = e.clientY;
          startW = window.innerWidth;
          startH = window.innerHeight;
          window.addEventListener('mousemove', onMouseMove);
          window.addEventListener('mouseup', onMouseUp);
        });
        const onTouchMove = (e) => {
          const t = e.touches[0];
          if (t) onMove(t.clientX, t.clientY);
        };
        const onTouchEnd = () => {
          window.removeEventListener('touchmove', onTouchMove);
          window.removeEventListener('touchend', onTouchEnd);
        };
        resizer.addEventListener('touchstart', (e) => {
          const t = e.touches[0];
          if (!t) return;
          startX = t.clientX;
          startY = t.clientY;
          startW = window.innerWidth;
          startH = window.innerHeight;
          window.addEventListener('touchmove', onTouchMove);
          window.addEventListener('touchend', onTouchEnd);
        }, { passive: true });
      }

      if (btnCopyManual) {
        btnCopyManual.addEventListener('click', async () => {
          const txt = bridgeOutput?.value || lastPayload || '';
          if (!txt) {
            addLog('Nenhum JSON gerado para copiar ainda.', 'warn');
            return;
          }
          if (bridgeOutput) {
            bridgeOutput.focus();
            bridgeOutput.select();
          }
          await copyWithFallback(txt, 'JSON');
        });
      }

      if (bridgeOutput) {
        bridgeOutput.addEventListener('click', () => {
          bridgeOutput.focus();
          bridgeOutput.select();
        });
      }

      // Icones SVG otimizados
      const ICONS = {
        text: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 7V4h16v3M9 20h6M12 4v16"/></svg>`,
        image: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>`,
        button: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="8" width="18" height="8" rx="2"/><line x1="12" y1="12" x2="12" y2="12"/></svg>`,
        container: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M9 21V9"/></svg>`,
        woo: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></svg>`,
        star: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>`,
        video: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/></svg>`,
        menu: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>`,
        form: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>`,
        default: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>`
      };

      function getWidgetIcon(name) {
        if (name.includes('image') || name.includes('gallery') || name.includes('thumb')) return ICONS.image;
        if (name.includes('text') || name.includes('heading') || name.includes('title')) return ICONS.text;
        if (name.includes('button') || name.includes('btn') || name.includes('link')) return ICONS.button;
        if (name.includes('container') || name.includes('section') || name.includes('div')) return ICONS.container;
        if (name.includes('woo') || name.includes('product') || name.includes('cart')) return ICONS.woo;
        if (name.includes('star') || name.includes('rating') || name.includes('review')) return ICONS.star;
        if (name.includes('video') || name.includes('youtube')) return ICONS.video;
        if (name.includes('menu') || name.includes('nav')) return ICONS.menu;
        if (name.includes('form') || name.includes('input')) return ICONS.form;
        return ICONS.default;
      }

      // Dados dos widgets para geracao dinamica
      const WIDGET_DATA = {
        'Basicos': [
          'heading', 'text', 'button', 'image', 'icon', 'video', 'divider', 'spacer', 'image-box', 'icon-box',
          'star-rating', 'counter', 'progress', 'tabs', 'accordion', 'toggle', 'alert', 'social-icons',
          'soundcloud', 'shortcode', 'html', 'menu-anchor', 'sidebar', 'read-more', 'image-carousel',
          'basic-gallery', 'gallery', 'icon-list', 'nav-menu', 'search-form', 'google-maps', 'testimonial',
          'embed', 'lottie', 'loop:grid', 'w:container', 'w:inner-container',
        ],
        'Pro': [
          'form', 'login', 'subscription', 'call-to-action', 'media:carousel', 'portfolio', 'gallery-pro',
          'slider:slides', 'slideshow', 'flip-box', 'animated-headline', 'post-navigation', 'share-buttons',
          'table-of-contents', 'countdown', 'blockquote', 'testimonial-carousel', 'review-box', 'reviews', 'hotspots',
          'sitemap', 'author-box', 'price-table', 'price-list', 'progress-tracker', 'animated-text',
          'nav-menu-pro', 'breadcrumb', 'facebook-button', 'facebook-comments', 'facebook-embed',
          'facebook-page', 'loop:builder', 'loop:grid-advanced', 'loop-carousel', 'post-excerpt',
          'post-content', 'post-title', 'post-info', 'post-featured-image', 'post-author', 'post-date',
          'post-terms', 'archive-title', 'archive-description', 'site-logo', 'site-title', 'site-tagline',
          'search-results', 'global-widget', 'video-playlist', 'video-gallery'
        ],
        'WooCommerce': [
          'woo:product-title', 'woo:product-image', 'woo:product-price', 'woo:product-add-to-cart',
          'woo:product-data-tabs', 'woo:product-excerpt', 'woo:product-rating', 'woo:product-stock',
          'woo:product-meta', 'woo:product-additional-information', 'woo:product-short-description',
          'woo:product-related', 'woo:product-upsells', 'woo:product-tabs', 'woo:product-breadcrumb',
          'woo:product-gallery', 'woo:products', 'woo:product-grid', 'woo:product-carousel',
          'woo:product-loop-item', 'woo:loop-product-title', 'woo:loop-product-price',
          'woo:loop-product-rating', 'woo:loop-product-image', 'woo:loop-product-button',
          'woo:loop-product-meta', 'woo:cart', 'woo:checkout', 'woo:my-account', 'woo:purchase-summary',
          'woo:order-tracking'
        ],
        'Loop Builder': [
          'loop:item', 'loop:image', 'loop:title', 'loop:meta', 'loop:terms', 'loop:rating', 'loop:price',
          'loop:add-to-cart', 'loop:read-more', 'loop:featured-image', 'loop:pagination'
        ],
        'Experimentais': [
          'w:nested-tabs', 'w:mega-menu', 'w:scroll-snap', 'w:motion-effects', 'w:background-slideshow',
          'w:css-transform', 'w:custom-position', 'w:dynamic-tags', 'w:ajax-pagination'
        ],
        'WordPress': [
          'w:wp-search', 'w:wp-recent-posts', 'w:wp-recent-comments', 'w:wp-archives', 'w:wp-categories',
          'w:wp-calendar', 'w:wp-tag-cloud', 'w:wp-custom-menu'
        ],
        'Nomenclatura Hierárquica': [
          // Accordion
          'accordion:item', 'accordion:title', 'accordion:content', 'accordion:icon',
          // Tabs
          'tabs:item', 'tabs:title', 'tabs:content',
          // Icon List
          'list:item', 'list:icon', 'list:text',
          // Carousel
          'slide:1', 'slide:2', 'carousel:slide',
          // Countdown
          'countdown:days', 'countdown:hours', 'countdown:minutes', 'countdown:seconds',
          // Toggle
          'toggle:item', 'toggle:title', 'toggle:content',
        ]
      };

      function renderWidgetList(filterText = '') {
        const container = document.getElementById('widget-list-container');
        if (!container) return;

        const search = filterText.toLowerCase().trim();
        let html = '';

        if (search) {
          html += `<div class="search-status">Filtrando por: "<strong>${search}</strong>"</div>`;
        }

        let hasResults = false;

        for (const [category, items] of Object.entries(WIDGET_DATA)) {
          const filteredItems = items.filter(item => {
            if (!search) return true;
            return item.toLowerCase().includes(search);
          });

          if (filteredItems.length === 0) continue;
          hasResults = true;

          html += `<div class="card compact"><div class="card-title small">${category}</div><div class="help-grid compact">`;

          filteredItems.forEach(item => {
            let fullName = item;
            if (!item.includes(':') && !item.startsWith('w:')) {
              fullName = 'w:' + item;
            }
            const icon = getWidgetIcon(fullName);

            html += `
              <div class="help-item compact" title="${fullName}">
                <div class="item-header">
                  <span class="item-icon">${icon}</span>
                  <span class="label">${fullName}</span>
                </div>
                <button class="btn tiny ghost full-width" data-rename="${fullName}">Aplicar</button>
              </div>`;
          });

          html += `</div></div>`;
        }

        if (!hasResults) {
          html = `<div class="empty-state">Nenhum widget encontrado para "${search}"</div>`;
        }

        container.innerHTML = html;
      }

      renderWidgetList();

      const searchInput = document.getElementById('widget-search');
      if (searchInput) {
        searchInput.addEventListener('input', (e) => {
          renderWidgetList(e.target.value);
        });
      }

      document.body.addEventListener('click', (e) => {
        const btn = e.target.closest('[data-rename]');
        if (btn) {
          const name = btn.getAttribute('data-rename');
          send('rename-layer', { name });
        }
      });

      // Linter Logic
      const linterPanel = document.getElementById('linter-panel');
      const linterSummary = document.getElementById('linter-summary');
      const linterIssues = document.getElementById('linter-issues');
      const btnAnalyze = document.getElementById('btn_analyze');
      const btnCloseLinter = document.getElementById('btn_close_linter');

      if (btnAnalyze) {
        btnAnalyze.onclick = () => {
          send('analyze-layout');
          addLog('Iniciando análise de layout...', 'info');
        };
      }

      if (btnCloseLinter) {
        btnCloseLinter.onclick = () => {
          if (linterPanel) linterPanel.style.display = 'none';
        };
      }

      function renderLinterReport(report) {
        if (!linterPanel || !linterSummary || !linterIssues) return;

        linterPanel.style.display = 'block';
        linterIssues.innerHTML = '';
        linterSummary.innerHTML = '';

        if (!report) {
          linterSummary.innerHTML = '<div class="linter-empty">Erro ao gerar relatório.</div>';
          return;
        }

        // Render Summary
        const scoreColor = report.score >= 90 ? 'success' : report.score >= 70 ? 'warning' : 'error';
        linterSummary.innerHTML = `
          <div class="linter-score ${scoreColor}">
            <div class="score-value">${report.score}</div>
            <div class="score-label">Score</div>
          </div>
          <div class="linter-stats">
            <div class="stat-item error">
              <span class="count">${report.stats.errors}</span>
              <span class="label">Erros</span>
            </div>
            <div class="stat-item warning">
              <span class="count">${report.stats.warnings}</span>
              <span class="label">Alertas</span>
            </div>
          </div>
        `;

        // Render Issues
        if (report.issues.length === 0) {
          linterIssues.innerHTML = '<div class="linter-empty">Nenhum problema encontrado! 🎉</div>';
        } else {
          report.issues.forEach(issue => {
            const issueEl = document.createElement('div');
            issueEl.className = `linter-issue ${issue.severity}`;
            issueEl.innerHTML = `
              <div class="issue-header">
                <span class="issue-severity ${issue.severity}">${issue.severity === 'error' ? 'Erro' : 'Alerta'}</span>
                <span class="issue-message">${issue.message}</span>
              </div>
              <div class="issue-details">
                <div class="issue-node">Camada: ${issue.nodeName} (${issue.nodeType})</div>
                ${issue.suggestion ? `<div class="issue-suggestion">💡 ${issue.suggestion}</div>` : ''}
                ${issue.fixAvailable ? `<button class="btn tiny primary" data-fix="${issue.ruleId}" data-node="${issue.nodeId}">Corrigir</button>` : ''}
              </div>
            `;

            // Add click handler for selection
            issueEl.addEventListener('click', (e) => {
              if (e.target.tagName !== 'BUTTON') {
                send('select-node', { nodeId: issue.nodeId });
              }
            });

            // Add fix handler
            const fixBtn = issueEl.querySelector('[data-fix]');
            if (fixBtn) {
              fixBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                send('fix-issue', { ruleId: issue.ruleId, nodeId: issue.nodeId });
              });
            }
            linterIssues.appendChild(issueEl);
          });
        }
      }
      // Renderiza o relatório do Linter na UI
      function renderLinterReport(report) {
        if (!report) return;
        // 1. Atualizar Score e Stats
        const totalIssues = report.summary.total || 0;
        document.getElementById('linter-total-issues').textContent = totalIssues;

        // Atualizar cor do anel baseada no score (opcional, por enquanto fixo)
        // document.getElementById('linter-score-ring').style.borderColor = ...
        const counts = report.summary.by_severity || {};
        document.getElementById('count-critical').textContent = counts.critical || 0;
        document.getElementById('count-major').textContent = counts.major || 0;
        document.getElementById('count-minor').textContent = counts.minor || 0;
        // 2. Renderizar Lista de Issues
        const issuesList = document.getElementById('linter-issues-list');
        issuesList.innerHTML = ''; // Limpar lista atual
        if (totalIssues === 0) {
          issuesList.innerHTML = `
            <div class="linter-empty-state">
              <div class="empty-icon">✨</div>
              <h3>Nenhum problema encontrado</h3>
              <p>Seu layout parece estar seguindo todas as boas práticas!</p>
            </div>`;
        } else {
          report.analysis.forEach(issue => {
            // console.log('📊 [DEBUG] Relatório completo:', report);
            // console.log('📊 [DEBUG] Primeiro issue:', report.analysis[0]);
            const card = document.createElement('div');
            card.className = 'linter-issue-card';

            // Ícone baseado na regra
            let icon = '⚠️';
            if (issue.ruleId === 'auto-layout-required') icon = '📐';
            if (issue.ruleId === 'widget-naming') icon = '🏷️';
            if (issue.ruleId === 'spacer-detected') icon = '📏';
            // Check if naming issue
            // Check if naming issue
            const isNamingIssue = issue.rule === 'widget-naming' || issue.rule === 'generic-name-detected';
            let suggestedName = '';
            if (isNamingIssue) {
              const match = issue.message.match(/"([^"]+)"/);
              if (match) suggestedName = match[1];
            }

            card.innerHTML = `
              <div class="issue-header">
                <div class="issue-title">
                  <span>${icon}</span>
                  <span>${issue.nodeName || issue.node_name || 'Node'}</span>
                </div>
                <span class="issue-badge ${issue.severity}">${issue.severity}</span>
              </div>
              <div class="issue-desc">${issue.message}</div>
              <div class="issue-actions" style="display: flex; gap: 6px; margin-top: 8px;">
                <button class="btn tiny secondary issue-btn-focus" data-node-id="${issue.nodeId || issue.node_id}">
                  📍 Ver no Figma
                </button>
                ${isNamingIssue && suggestedName ? `
                  <button class="btn tiny primary issue-btn-rename" data-node-id="${issue.nodeId || issue.node_id}" data-name="${suggestedName}">
                    ✨ Renomear
                  </button>
                ` : ''}
              </div>
            `;

            issuesList.appendChild(card);

            // Add click handlers
            const btnFocus = card.querySelector('.issue-btn-focus');
            if (btnFocus) {
              btnFocus.onclick = (e) => {
                e.stopPropagation();
                send('focus-node', { nodeId: btnFocus.dataset.nodeId });
              };
            }

            const btnRename = card.querySelector('.issue-btn-rename');
            if (btnRename) {
              btnRename.onclick = (e) => {
                e.stopPropagation();
                send('rename-layer', { nodeId: btnRename.dataset.nodeId, name: btnRename.dataset.name });
                addLog(`Renomeando para "${btnRename.dataset.name}"...`, 'info');
              };
            }
          });
        }
        // 3. Renderizar Tabela de Widgets
        const widgetsBody = document.getElementById('widgets-table-body');
        const widgetsCount = document.getElementById('widgets-count');

        widgetsBody.innerHTML = ''; // Limpar tabela
        widgetsCount.textContent = report.widgets ? report.widgets.length : 0;
        if (report.widgets && report.widgets.length > 0) {
          // Mostrar apenas os top 20 para não travar a UI se houver muitos
          report.widgets.slice(0, 20).forEach(widget => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td><strong>${widget.widget}</strong></td>
              <td>${widget.node_name}</td>
              <td>${widget.confidence}</td>
            `;
            widgetsBody.appendChild(row);
          });

          if (report.widgets.length > 20) {
            const row = document.createElement('tr');
            row.innerHTML = `<td colspan="3" style="text-align:center; color:#888;">... e mais ${report.widgets.length - 20} widgets</td>`;
            widgetsBody.appendChild(row);
          }
        } else {
          const row = document.createElement('tr');
          row.innerHTML = `<td colspan="3" style="text-align:center; padding: 12px;">Nenhum widget detectado</td>`;
          widgetsBody.appendChild(row);
        }

        // 4. Adicionar handlers para clique nos issues
        const issueCards = document.querySelectorAll('.linter-issue-card');
        issueCards.forEach((card, index) => {
          card.addEventListener('click', () => {
            showProblemDetails(report.analysis[index], index, report);
          });
        });
      }

      // ========== PROBLEM DETAILS PANEL LOGIC ==========

      let currentProblemIndex = -1;
      let currentReport = null;

      function showProblemDetails(issue, index, report) {
        currentProblemIndex = index;
        currentReport = report;

        const panel = document.getElementById('problem-details-panel');
        const content = document.getElementById('problem-details-content');

        if (!panel || !content) return;

        // Seleciona o node no Figma
        send('select-problem-node', { nodeId: issue.node_id });

        // Gera o guia passo-a-passo baseado na regra
        const guide = generateGuideForRule(issue.rule, issue);

        // Check if this is a naming issue and extract suggested name


        const isNamingIssue = issue.rule === 'widget-naming' || issue.rule === 'generic-name-detected';


        let suggestedName = '';


        if (isNamingIssue) {


          const match = issue.message.match(/"([^"]+)"/);


          if (match) suggestedName = match[1];


        }



        // Renderiza o conteúdo do painel
        content.innerHTML = `
          <div class="problem-header">
            <div class="problem-severity ${issue.severity}">
              ${getSeverityIcon(issue.severity)} ${getSeverityLabel(issue.severity)}
            </div>
            <div class="problem-title">${issue.message}</div>
          </div>

          <div class="problem-location">
            📍 <strong>Localização:</strong> ${issue.node_name} (${issue.node_id})
          </div>

          ${isNamingIssue && suggestedName ? `
            <div style="margin: 12px 0;">
              <button id="btn-auto-rename" class="btn primary small" style="width: 100%;">
                âœ¨ Renomear para "${suggestedName}"
              </button>
            </div>
          ` : ''}

          

          <div class="problem-guide">
            <h4>✅ COMO CORRIGIR (⏱️ ${guide.estimated_time}):</h4>
            <ol class="guide-steps">
              ${guide.steps.map((step, i) => `
                <li>
                  <span class="step-number">${i + 1}</span>
                  <span class="step-action">${step}</span>
                </li>
              `).join('')
          }
            </ol >
        
          </div >
        `;

        // Mostra o painel
        panel.style.display = 'block';

        // Scroll para o painel
        panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });



        // Add handler for auto-rename button


        if (isNamingIssue && suggestedName) {


          const btnAutoRename = document.getElementById('btn-auto-rename');


          if (btnAutoRename) {


            btnAutoRename.onclick = () => {


              send('rename-layer', { nodeId: issue.node_id, name: suggestedName });


              addLog(`Renomeando para "${suggestedName}"...`, 'info');


            };


          }


        }
      }

      function getSeverityIcon(severity) {
        const icons = {
          critical: '🔴',
          major: '🟡',
          minor: '🔵',
          info: 'ℹ️'
        };
        return icons[severity] || '⚠️';
      }

      function getSeverityLabel(severity) {
        const labels = {
          critical: 'Crítico',
          major: 'Importante',
          minor: 'Menor',
          info: 'Informação'
        };
        return labels[severity] || severity;
      }

      function getDifficultyLabel(difficulty) {
        const labels = {
          easy: 'Fácil',
          medium: 'Médio',
          hard: 'Difícil'
        };
        return labels[difficulty] || difficulty;
      }

      function generateGuideForRule(ruleId, issue) {
        // Mapeamento de regras para guias passo-a-passo
        const guides = {
          'auto-layout-required': {
            steps: [
              'Selecione o frame',
              'Pressione Shift + A',
              'Configure direÃ§Ã£o e espaÃ§amento'
            ]
          },
          'spacer-detected': {
            steps: [
              'Selecione o frame pai',
              'Aumente o Gap',
              'Delete o spacer'
            ]
          },
          'generic-name-detected': {
            steps: [
              'Use o botÃ£o "Renomear" acima',
              'Ou clique 2x no nome da camada'
            ]
          },
          'widget-naming': {
            steps: [
              'Use o botÃ£o "Renomear" acima',
              'Ou clique 2x no nome da camada'
            ]
          }
        };

        return guides[ruleId] || {
          steps: ['Corrija manualmente no Figma']
        };
      }

      // Handlers dos botões do painel
      const btnCloseDetails = document.getElementById('btn-close-details');
      const btnMarkResolved = document.getElementById('btn-mark-resolved');
      const btnNextProblem = document.getElementById('btn-next-problem');
      const btnIgnoreProblem = document.getElementById('btn-ignore-problem');

      if (btnCloseDetails) {
        btnCloseDetails.onclick = () => {
          const panel = document.getElementById('problem-details-panel');
          if (panel) panel.style.display = 'none';
        };
      }

      if (btnMarkResolved) {
        btnMarkResolved.onclick = () => {
          if (currentReport && currentProblemIndex >= 0) {
            const issue = currentReport.analysis[currentProblemIndex];
            send('mark-problem-resolved', { nodeId: issue.node_id });
            addLog('Validando correção...', 'info');
          }
        };
      }

      if (btnNextProblem) {
        btnNextProblem.onclick = () => {
          if (currentReport && currentProblemIndex < currentReport.analysis.length - 1) {
            const nextIndex = currentProblemIndex + 1;
            showProblemDetails(currentReport.analysis[nextIndex], nextIndex, currentReport);
          } else {
            addLog('Você chegou ao último problema!', 'info');
          }
        };
      }

      if (btnIgnoreProblem) {
        btnIgnoreProblem.onclick = () => {
          const panel = document.getElementById('problem-details-panel');
          if (panel) panel.style.display = 'none';
          addLog('Problema ignorado', 'info');
        };
      }

    })();
  </script>
</body>

</html>
