<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Figma to WP Elementor</title>
  <style>
    /* tokens */
    :root {
      --font: "Inter", sans-serif;
      --space-1: 6px;
      --space-2: 12px;
      --space-3: 18px;
      --space-4: 24px;
      --radius: 10px;
      --color-bg: #f5f6fb;
      --color-panel: #ffffff;
      --color-border: #e2e5ec;
      --color-text: #111318;
      --color-text-secondary: #000000;
      --color-primary: #0c7bff;
      --color-primary-hover: #0063cc;
      --shadow-1: 0 6px 18px rgba(0, 0, 0, 0.07);
    }

    :root.dark {
      --color-bg: #1c1c1f;
      --color-panel: #2a2a2e;
      --color-border: #3a3a3e;
      --color-text: #8d8d8d;
      --color-text-secondary: #e6e6e6;
      --color-primary: #3ea6ff;
      --color-primary-hover: #1c8dd5;
      --shadow-1: 0 8px 20px rgba(0, 0, 0, 0.35);
    }

    @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap");

    :root {
      --anim: 180ms ease;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: var(--font, 'Inter'), system-ui, -apple-system, sans-serif;
      background: var(--color-bg);
      color: var(--color-text);
    }

    .app {
      width: 100%;
      /* max-width: 800px; */
      margin: 0 auto;
      min-height: 100vh;
      padding: var(--space-3);
    }

    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-2);
    }

    .brand {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .brand-title {
      font-weight: 700;
      font-size: 19px;
      color: var(--color-text);
    }

    .brand-subtitle {
      font-size: 13px;
      color: var(--color-text-secondary);
    }

    .top-actions {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .btn {
      border: 1px solid var(--color-border);
      border-radius: var(--radius);
      padding: 10px 14px;
      font-weight: 600;
      cursor: pointer;
      transition: transform var(--anim), box-shadow var(--anim), background var(--anim);
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-1);
    }

    .btn.primary {
      background: #0c7bff;
      border-color: #0c7bff;
      color: #fff;
    }

    .btn.secondary {
      background: #eef1f6;
      color: #1d1f25;
    }

    .btn.ghost {
      background: var(--color-panel);
      color: var(--color-text-secondary);
      border-color: var(--color-border);
    }

    .btn.small {
      padding: 6px 10px;
      font-size: 12px;
    }

    .btn.tiny {
      padding: 6px 10px;
      font-size: 12px;
    }

    .btn:disabled {
      opacity: 0.45;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    .switch {
      position: relative;
      display: inline-block;
      width: 56px;
      height: 30px;
    }

    .switch input {
      display: none;
    }

    .slider {
      position: absolute;
      inset: 0;
      cursor: pointer;
      background: var(--color-border);
      border-radius: 999px;
      transition: var(--anim);
    }

    .slider:before {
      content: "";
      position: absolute;
      left: 4px;
      top: 4px;
      width: 22px;
      height: 22px;
      background: var(--color-panel);
      border-radius: 50%;
      box-shadow: var(--shadow-1);
      transition: var(--anim);
      z-index: 2;
    }

    .slider .sun,
    .slider .moon {
      position: absolute;
      font-size: 13px;
      top: 7px;
      transition: var(--anim);
    }

    .slider .sun {
      left: 10px;
      opacity: 1;
    }

    .slider .moon {
      right: 10px;
      opacity: 0;
    }

    input:checked+.slider {
      background: var(--color-primary);
    }

    input:checked+.slider:before {
      transform: translateX(26px);
    }

    input:checked+.slider .sun {
      opacity: 0;
      transform: translateX(-6px);
    }

    input:checked+.slider .moon {
      opacity: 1;
      transform: translateX(6px);
    }

    .tabs {
      display: flex;
      gap: 0;
      background: var(--color-panel);
      border: 1px solid var(--color-border);
      border-radius: var(--radius);
      position: relative;
      overflow: hidden;
    }

    .tab-btn {
      flex: 1;
      padding: var(--space-2);
      border: none;
      background: transparent;
      font-weight: 600;
      color: var(--color-text-secondary);
      cursor: pointer;
      position: relative;
      transition: color var(--anim), background var(--anim);
    }

    .tab-btn.active {
      color: var(--color-primary);
    }

    .tab-btn:hover {
      background: rgba(0, 0, 0, 0.02);
    }

    .tab-indicator {
      position: absolute;
      bottom: 0;
      left: 0;
      height: 3px;
      width: 25%;
      background: var(--color-primary);
      transition: transform var(--anim), width var(--anim);
    }

    .tab-panels {
      margin-top: var(--space-2);
    }

    .tab-panel {
      display: none;
      animation: fadeIn var(--anim);
    }

    .tab-panel.active {
      display: block;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(4px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .card {
      background: var(--color-panel);
      border: 1px solid var(--color-border);
      border-radius: var(--radius);
      padding: var(--space-3);
      margin-bottom: var(--space-3);
      box-shadow: var(--shadow-1);
    }

    .card-title {
      font-weight: 700;
      margin-bottom: var(--space-2);
      color: var(--color-text);
    }

    .actions {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: var(--space-2);
    }

    .input-label {
      display: block;
      margin: var(--space-2) 0 var(--space-1);
      font-weight: 600;
      color: var(--color-text-secondary);
    }

    input[type="text"],
    input[type="password"] {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--color-border);
      border-radius: var(--radius);
      font-size: 14px;
      background: #fff;
      color: var(--color-text);
    }

    .checkbox {
      display: flex;
      gap: 8px;
      align-items: center;
      margin: 6px 0;
      color: var(--color-text-secondary);
    }

    #output {
      width: 100%;
      min-height: 160px;
      border: 1px solid var(--color-border);
      border-radius: var(--radius);
      padding: 12px;
      font-family: "SFMono-Regular", Consolas, monospace;
      background: #f5f6f8;
      resize: vertical;
      color: var(--color-text);
    }

    .logs {
      margin-top: 10px;
      min-height: 80px;
      border: 1px solid var(--color-border);
      border-radius: var(--radius);
      padding: 10px;
      background: var(--color-panel);
      font-size: 12px;
      color: var(--color-text);
      overflow-y: auto;
    }

    .status {
      margin-top: 10px;
      font-size: 13px;
      color: var(--color-text-secondary);
    }

    .provider-block {
      display: none;
    }

    body[data-provider="gemini"] .provider-gemini,
    body[data-provider="gpt"] .provider-gpt {
      display: block;
    }

    .help-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: var(--space-2);
    }

    .help-item {
      padding: var(--space-2);
      border: 1px solid var(--color-border);
      border-radius: var(--radius);
      background: #f9fafb;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .help-item .label {
      font-weight: 600;
      color: var(--color-text);
    }

    .muted {
      color: var(--color-text-secondary);
      font-size: 12px;
      margin-top: var(--space-2);
    }

    body.dark {
      background: var(--color-bg);
      color: var(--color-text);
    }

    body.dark .tabs {
      border-color: var(--color-border);
      background: var(--color-panel);
    }

    body.dark .tab-btn {
      color: var(--color-text-secondary);
    }

    body.dark .tab-btn.active {
      color: var(--color-primary);
    }

    body.dark .card {
      background: var(--color-panel);
      border-color: var(--color-border);
    }

    body.dark .btn.secondary {
      background: #3a3a3e;
      color: #f5f5f5;
    }

    body.dark .btn.ghost {
      background: #2a2a2e;
      color: #f5f5f5;
    }

    body.dark input[type="text"],
    body.dark input[type="password"] {
      background: #1f1f22;
      border-color: var(--color-border);
      color: #eee;
    }

    body.dark #output {
      background: #242424;
      color: #eee;
      border-color: var(--color-border);
    }

    body.dark .logs {
      background: #242424;
      color: #bbb;
      border-color: var(--color-border);
    }

    body.dark .help-item {
      background: #2f2f2f;
      border-color: var(--color-border);
    }

    body.dark .help-item .label {
      color: #f5f5f5;
    }

    body.dark .card-title {
      color: #f5f5f5;
    }

    * {
      scrollbar-width: thin;
      scrollbar-color: var(--color-border) transparent;
    }

    *::-webkit-scrollbar {
      width: 8px;
    }

    *::-webkit-scrollbar-track {
      background: transparent;
    }

    *::-webkit-scrollbar-thumb {
      background: var(--color-border);
      border-radius: 4px;
    }

    /* Resizer handle */
    #resizer-handle {
      position: fixed;
      width: 26px;
      height: 26px;
      right: 0px;
      bottom: 0px;
      cursor: se-resize;
      opacity: 1;
      /* background: var(--color-panel); */
      /* border: 1px solid var(--color-border); */
      /* border-radius: 10px; */
      /* transition: opacity var(--anim), background var(--anim), transform var(--anim); */
      z-index: 9999;
      /* box-shadow: var(--shadow-1); */
      pointer-events: auto;
      background-image: url("data:image/svg+xml;utf8,<svg viewBox='0 0 18 18' xmlns='http://www.w3.org/2000/svg' fill='%23f5a905' stroke='%23f5a905'><path fill='%23000000' d='M14.228 16.227a1 1 0 0 1-.707-1.707l1-1a1 1 0 0 1 1.416 1.414l-1 1a1 1 0 0 1-.707.293zm-5.638 0a1 1 0 0 1-.707-1.707l6.638-6.638a1 1 0 0 1 1.416 1.414l-6.638 6.638a1 1 0 0 1-.707.293zm-5.84 0a1 1 0 0 1-.707-1.707L14.52 2.043a1 1 0 1 1 1.415 1.414L3.457 15.934a1 1 0 0 1-.707.293z'></path></svg>");
      background-repeat: no-repeat;
      background-position: center;
      /* background-size: 16px; */
    }

    #resizer-handle:hover {
      opacity: 0.65;
      transform: scale(1.05);
    }

    body.dark #resizer-handle {
      background: #1f1f22;
      opacity: 0.42;
    }

    .progress {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .progress.hidden {
      display: none;
    }

    .progress-bar {
      width: 120px;
      height: 8px;
      border-radius: 999px;
      background: var(--color-border);
      position: relative;
      overflow: hidden;
    }

    .progress-bar::after {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(90deg, var(--color-primary) 0%, #5fb5ff 100%);
      width: 60%;
      animation: slide 1s infinite;
    }

    .progress-text {
      font-size: 12px;
      color: var(--color-text-secondary);
    }

    @keyframes slide {
      0% {
        transform: translateX(-100%);
      }

      50% {
        transform: translateX(0%);
      }

      100% {
        transform: translateX(100%);
      }
    }
  </style>
</head>

<body>
  <div class="app">
    <header class="topbar">
      <div class="brand">
        <div class="brand-title">Figma to WP Elementor</div>
        <div class="brand-subtitle">Convers&#227;o inteligente para Containers Flex</div>
      </div>
      <div class="top-actions">
        <label class="switch" title="Alternar tema">
          <input type="checkbox" id="theme-toggle" />
          <span class="slider">
            <span class="sun">&#9728;</span>
            <span class="moon">&#127769;</span>
          </span>
        </label>
      </div>
    </header>

    <nav class="tabs">
      <button class="tab-btn active" data-tab="layout">Layout &rarr; Elementor</button>
      <button class="tab-btn" data-tab="ai">Configura&#231;&#227;o da IA</button>
      <button class="tab-btn" data-tab="wp">WordPress</button>
      <button class="tab-btn" data-tab="help">Ajuda</button>
      <span class="tab-indicator"></span>
    </nav>

    <main class="tab-panels">
      <section class="tab-panel active" data-panel="layout">
        <div class="card">
          <div class="card-title">A&#231;&#245;es r&#225;pidas</div>
          <div class="actions">
            <button class="btn primary" data-action="inspect-layout">Inspecionar Layout</button>
            <button class="btn primary" data-action="generate-json">Gerar JSON</button>
            <button class="btn secondary" data-action="copy-json" disabled>Copiar JSON</button>
            <button class="btn secondary" data-action="download-json" disabled>Baixar JSON</button>
            <button class="btn secondary" data-action="export-wp" disabled>Exportar WP</button>
            <button class="btn ghost" data-action="reset">Reiniciar</button>
          </div>
        </div>
        <div class="card">
          <div class="card-title">Sa&#237;da / Logs</div>
          <div id="progress" class="progress hidden">
            <div class="progress-bar"></div>
            <span class="progress-text">Processando pipeline...</span>
          </div>
          <textarea id="output" placeholder="O JSON gerado aparecer&#225; aqui" readonly></textarea>
          <div id="logs" class="logs"></div>
        </div>
      </section>

                  <section class="tab-panel" data-panel="ai">
        <div class="card">
          <div class="card-title">Configura&#231;&#227;o da IA</div>
          <label class="input-label" for="provider_ai">Provedor de IA</label>
          <select id="provider_ai">
            <option value="gemini">Gemini</option>
            <option value="gpt">GPT (OpenAI)</option>
          </select>

          <div class="provider-block provider-gemini">
            <label class="input-label" for="gemini_api_key">Gemini API Key</label>
            <input id="gemini_api_key" type="password" autocomplete="off" placeholder="Cole sua API Key do Gemini" />
            <label class="input-label" for="gemini_model">Modelo</label>
            <select id="gemini_model">
              <option value="gemini-2.0-flash-exp">gemini-2.0-flash-exp (Experimental)</option>
              <option value="gemini-1.5-pro-002">gemini-1.5-pro-002 (Stable)</option>
              <option value="gemini-1.5-flash-002">gemini-1.5-flash-002 (Fast & Stable)</option>
            </select>
            <div class="actions">
              <button class="btn primary" data-action="test-gemini">Testar conex&#227;o</button>
            </div>
            <div id="gemini-status" class="status"></div>
          </div>

          <div class="provider-block provider-gpt">
            <label class="input-label" for="gpt_api_key">OpenAI API Key</label>
            <input id="gpt_api_key" type="password" autocomplete="off" placeholder="Cole sua chave da OpenAI" />
            <label class="input-label" for="gpt_model">Modelo GPT</label>
            <select id="gpt_model">
              <option value="gpt-4.1-mini">gpt-4.1-mini (recomendado)</option>
              <option value="gpt-4.1">gpt-4.1</option>
              <option value="gpt-4.1-preview">gpt-4.1-preview</option>
              <option value="gpt-o1">gpt-o1</option>
              <option value="gpt-o3-mini">gpt-o3-mini</option>
            </select>
            <div class="actions">
              <button class="btn primary" data-action="test-gpt">Testar conex&#227;o GPT</button>
            </div>
            <div id="gpt-status" class="status"></div>
          </div>

          <label class="checkbox">
            <input id="auto_fix_layout" type="checkbox" />
            <span>Corre&#231;&#227;o autom&#225;tica de layout (fallback flex column)</span>
          </label>
        </div>
      </section>

      <section class="tab-panel" data-panel="wp">
        <div class="card">
          <div class="card-title">WordPress</div>
          <label class="input-label" for="wp_url">WP URL</label>
          <input id="wp_url" type="text" autocomplete="off" placeholder="https://site.com" />

          <label class="input-label" for="wp_user">Usu&#225;rio WP</label>
          <input id="wp_user" type="text" autocomplete="username" placeholder="usu&#225;rio" />

          <label class="input-label" for="wp_token">Senha do App (Token)</label>
          <input id="wp_token" type="password" autocomplete="current-password" placeholder="Senha de aplica&#231;&#227;o do WP" />

          <label class="checkbox">
            <input id="wp_export_images" type="checkbox" />
            <span>Exportar imagens automaticamente</span>
          </label>
          <label class="checkbox">
            <input id="wp_create_page" type="checkbox" />
            <span>Criar p&#225;gina automaticamente</span>
          </label>

          <div class="actions">
            <button class="btn primary" data-action="test-wp">Testar conex&#227;o</button>
            <button class="btn secondary" data-action="export-wp">Exportar WP</button>
          </div>
          <div id="wp-status" class="status"></div>
        </div>
      </section>

      <section class="tab-panel" data-panel="help">
        <div class="card">
          <div class="card-title">Nomenclaturas e A&#231;&#245;es r&#225;pidas</div>
          <div class="help-grid">
            <div class="help-item"><span class="label">w:heading</span><button class="btn tiny"
                data-rename="w:heading">Renomear layer</button></div>
            <div class="help-item"><span class="label">w:text</span><button class="btn tiny"
                data-rename="w:text">Renomear layer</button></div>
            <div class="help-item"><span class="label">w:button</span><button class="btn tiny"
                data-rename="w:button">Renomear layer</button></div>
            <div class="help-item"><span class="label">w:image</span><button class="btn tiny"
                data-rename="w:image">Renomear layer</button></div>
            <div class="help-item"><span class="label">w:icon</span><button class="btn tiny"
                data-rename="w:icon">Renomear layer</button></div>
            <div class="help-item"><span class="label">c:container</span><button class="btn tiny"
                data-rename="c:container">Renomear layer</button></div>
          </div>
          <p class="muted">Clique para renomear a layer selecionada no Figma com a nomenclatura adequada.</p>
        </div>
      </section>
    </main>
  </div>
  <div id="resizer-handle" aria-label="Arraste para redimensionar"></div>

  <script>
    (() => {
      const tabs = document.querySelectorAll('.tab-btn');
      const panels = document.querySelectorAll('.tab-panel');
      const indicator = document.querySelector('.tab-indicator');
      const output = document.getElementById('output');
      const logs = document.getElementById('logs');
      const progress = document.getElementById('progress');
      const btnCopy = document.querySelector('[data-action="copy-json"]');
      const btnDownload = document.querySelector('[data-action="download-json"]');
      const btnExport = document.querySelector('[data-action="export-wp"]');
      const themeToggle = document.getElementById('theme-toggle');
      const darkSheet = document.getElementById('theme-dark');
      let lastPayload = '';

      const fields = {
        provider_ai: document.getElementById('provider_ai'),
        gemini_api_key: document.getElementById('gemini_api_key'),
        gemini_model: document.getElementById('gemini_model'),
        gpt_api_key: document.getElementById('gpt_api_key'),
        gpt_model: document.getElementById('gpt_model'),
        auto_fix_layout: document.getElementById('auto_fix_layout'),
        wp_url: document.getElementById('wp_url'),
        wp_user: document.getElementById('wp_user'),
        wp_token: document.getElementById('wp_token'),
        wp_export_images: document.getElementById('wp_export_images'),
        wp_create_page: document.getElementById('wp_create_page')
      };

      const storage = null; // desativado para evitar SecurityError em sandbox

      function debounce(fn, wait = 300) {
        let t;
        return (...args) => {
          clearTimeout(t);
          t = setTimeout(() => fn(...args), wait);
        };
      }

      function updateIndicator() {
        const active = document.querySelector('.tab-btn.active');
        if (!indicator || !active || !active.parentElement) return;
        const rect = active.getBoundingClientRect();
        const parentRect = active.parentElement.getBoundingClientRect();
        indicator.style.width = `${rect.width}px`;
        indicator.style.transform = `translateX(${rect.left - parentRect.left}px)`;
      }

      function setActiveTab(name) {
        tabs.forEach(t => t.classList.toggle('active', t.dataset.tab === name));
        panels.forEach(p => p.classList.toggle('active', p.dataset.panel === name));
        updateIndicator();
      }

      function setProvider(providerId) {
        const value = providerId === 'gpt' ? 'gpt' : 'gemini';
        document.body?.setAttribute('data-provider', value);
        if (fields.provider_ai) fields.provider_ai.value = value;
      }

      tabs.forEach(btn => btn.addEventListener('click', () => setActiveTab(btn.dataset.tab)));

      function applyTheme(isDark) {
        document.documentElement.classList.toggle('dark', isDark);
        if (themeToggle) themeToggle.checked = isDark;
        if (darkSheet) darkSheet.disabled = !isDark;
        if (storage) {
          try { storage.setItem('figtoel-theme', isDark ? 'dark' : 'light'); } catch (_) { /* ignore */ }
        }
      }

      function initTheme(pref) {
        let stored = null;
        if (storage) {
          try { stored = storage.getItem('figtoel-theme'); } catch (_) { stored = null; }
        }
        const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        if (typeof pref === 'boolean') applyTheme(pref);
        else applyTheme(stored === 'dark' || (stored === null && prefersDark));
      }

      if (themeToggle) {
        themeToggle.addEventListener('change', () => {
          applyTheme(themeToggle.checked);
          send('save-setting', { key: 'gptel_dark_mode', value: themeToggle.checked });
        });
      }

      function send(type, payload = {}) {
        parent.postMessage({ pluginMessage: { type, ...payload } }, '*');
      }

      function addLog(message, level = 'info') {
        if (!logs) return;
        const now = new Date();
        const time = now.toLocaleTimeString('pt-BR', { hour12: false });
        const div = document.createElement('div');
        div.textContent = `[${time}] [${level}] ${message}`;
        logs.appendChild(div);
        logs.scrollTo(0, logs.scrollHeight);
      }

      function loadStoredSettings(payload) {
        if (!payload) return;
        if (fields.provider_ai) setProvider(payload.providerAi || 'gemini');
        if (fields.gemini_api_key) fields.gemini_api_key.value = payload.geminiKey || '';
        if (fields.gemini_model && payload.geminiModel) {
          fields.gemini_model.value = payload.geminiModel;
          addLog(`Modelo carregado: ${payload.geminiModel}`, 'info');
        }
        if (fields.gpt_api_key) fields.gpt_api_key.value = payload.gptKey || '';
        if (fields.gpt_model && payload.gptModel) fields.gpt_model.value = payload.gptModel;
        if (fields.auto_fix_layout) fields.auto_fix_layout.checked = !!payload.autoFixLayout;
        if (fields.wp_url) fields.wp_url.value = payload.wpUrl || '';
        if (fields.wp_user) fields.wp_user.value = payload.wpUser || '';
        if (fields.wp_token) fields.wp_token.value = payload.wpToken || '';
        if (fields.wp_export_images) fields.wp_export_images.checked = !!payload.exportImages;
        if (fields.wp_create_page) fields.wp_create_page.checked = !!payload.autoPage;
        if (typeof payload.darkMode === 'boolean') applyTheme(payload.darkMode);
        updateIndicator();
      }

      function watchInputs() {
        const saveText = (key, el) => debounce(() => send('save-setting', { key, value: el.value }));
        if (fields.provider_ai) {
          fields.provider_ai.addEventListener('change', () => {
            setProvider(fields.provider_ai.value);
            send('save-setting', { key: 'aiProvider', value: fields.provider_ai.value });
          });
        }
        if (fields.gemini_api_key) fields.gemini_api_key.addEventListener('input', saveText('gptel_gemini_key', fields.gemini_api_key));
        if (fields.gemini_model) {
          fields.gemini_model.addEventListener('change', () => {
            send('save-setting', { key: 'gemini_model', value: fields.gemini_model.value });
            addLog(`Modelo alterado para: ${fields.gemini_model.value}`, 'info');
          });
        }
        if (fields.gpt_api_key) fields.gpt_api_key.addEventListener('input', saveText('gptApiKey', fields.gpt_api_key));
        if (fields.gpt_model) fields.gpt_model.addEventListener('change', () => send('save-setting', { key: 'gptModel', value: fields.gpt_model.value }));
        if (fields.auto_fix_layout) fields.auto_fix_layout.addEventListener('change', () => send('save-setting', { key: 'auto_fix_layout', value: fields.auto_fix_layout.checked }));
        if (fields.wp_url) fields.wp_url.addEventListener('input', saveText('gptel_wp_url', fields.wp_url));
        if (fields.wp_user) fields.wp_user.addEventListener('input', saveText('gptel_wp_user', fields.wp_user));
        if (fields.wp_token) fields.wp_token.addEventListener('input', saveText('gptel_wp_token', fields.wp_token));
        if (fields.wp_export_images) fields.wp_export_images.addEventListener('change', () => send('save-setting', { key: 'gptel_export_images', value: fields.wp_export_images.checked }));
        if (fields.wp_create_page) fields.wp_create_page.addEventListener('change', () => send('save-setting', { key: 'gptel_auto_page', value: fields.wp_create_page.checked }));
      }

            function bindActions() {
        document.querySelectorAll('[data-action]').forEach(btn => {
          btn.addEventListener('click', () => {
            if (btn.disabled && ['copy-json', 'download-json', 'export-wp'].includes(btn.getAttribute('data-action') || '')) {
              return;
            }
            const action = btn.getAttribute('data-action');
            if (fields.gemini_model && fields.gemini_model.value) {
              send('save-setting', { key: 'gemini_model', value: fields.gemini_model.value });
            }
            const payload = {
              providerAi: fields.provider_ai?.value || 'gemini',
              gptModel: fields.gpt_model?.value || '',
              wpConfig: {
                url: fields.wp_url?.value || '',
                user: fields.wp_user?.value || '',
                token: fields.wp_token?.value || '',
                exportImages: fields.wp_export_images?.checked || false,
                autoPage: fields.wp_create_page?.checked || false
              },
              apiKey: fields.gemini_api_key?.value || '',
              gptApiKey: fields.gpt_api_key?.value || '',
              geminiModel: fields.gemini_model?.value || ''
            };
            if (payload.geminiModel) {
              send('save-setting', { key: 'gemini_model', value: payload.geminiModel });
            }
            if (payload.gptModel) {
              send('save-setting', { key: 'gptModel', value: payload.gptModel });
            }
            switch (action) {
              case 'inspect-layout': send('inspect'); break;
              case 'generate-json':
                toggleProgress(true);
                send('generate-json', payload);
                break;
              case 'optimize-structure': send('optimize-structure', payload); break;
              case 'analyze-widgets': send('analyze-widgets', payload); break;
              case 'copy-json':
                if (lastPayload) {
                  copyToClipboard(lastPayload);
                } else {
                  send('copy-json');
                }
                break;
              case 'download-json':
                if (lastPayload) {
                  downloadPayload(lastPayload);
                } else {
                  send('download-json');
                }
                break;
              case 'export-wp': send('export-wp', payload); break;
              case 'reset':
                if (output) output.value = '';
                if (logs) logs.innerHTML = '';
                if (fields.gemini_model) fields.gemini_model.value = fields.gemini_model.options[0]?.value || '';
                toggleProgress(false);
                toggleResultButtons(false);
                addLog('Sessao reiniciada.', 'info');
                send('reset');
                break;
              case 'test-gemini': send('test-gemini', { apiKey: payload.apiKey }); break;
              case 'test-gpt': send('test-gpt', { apiKey: payload.gptApiKey, model: payload.gptModel || fields.gpt_model?.value }); break;
              case 'test-wp': send('test-wp', { wpConfig: payload.wpConfig }); break;
              case 'resize-ui': send('resize-ui', { width: Math.min(window.innerWidth + 200, 1400), height: Math.min(window.innerHeight + 200, 1000) }); break;
              default: send(action || 'noop', payload);
            }
          });
        });
        document.querySelectorAll('[data-rename]').forEach(btn => {
          btn.addEventListener('click', () => {
            const name = btn.getAttribute('data-rename');
            send('rename-layer', { name });
          });
        });
      }
      window.onmessage = (event) => {
        const msg = (event.data || {}).pluginMessage;
        if (!msg) return;
        switch (msg.type) {
          case 'preview':
            if (output) output.value = msg.payload || '';
            if (msg.action === 'download' && msg.payload) {
              downloadPayload(msg.payload);
            }
            break;
          case 'generation-complete':
            lastPayload = msg.payload || '';
            if (output) output.value = msg.payload || '';
            addLog('JSON gerado.', 'info');
            toggleProgress(false);
            toggleResultButtons(true);
            break;
          case 'generation-error':
            toggleProgress(false);
            toggleResultButtons(false);
            alert(`Erro na geracao: ${msg.message}`);
            break;
          case 'generation-start':
            toggleProgress(true);
            toggleResultButtons(false);
            break;
          case 'gemini-status':
            addLog(msg.message || 'Status Gemini', msg.success ? 'success' : 'error');
            const gs = document.getElementById('gemini-status');
            if (gs) gs.textContent = msg.message;
            break;
          case 'gpt-status':
            addLog(msg.message || 'Status GPT', msg.success ? 'success' : 'error');
            const gptStatus = document.getElementById('gpt-status');
            if (gptStatus) gptStatus.textContent = msg.message;
            break;
          case 'wp-status':
            addLog(msg.message || 'Status WP', msg.success ? 'success' : 'error');
            const ws = document.getElementById('wp-status');
            if (ws) ws.textContent = msg.message;
            break;
          case 'log':
            if (typeof msg.message === 'string' && msg.message.includes('Iniciando pipeline')) {
              toggleProgress(true);
            }
            addLog(msg.message, msg.level);
            break;
          case 'load-settings':
            loadStoredSettings(msg.payload);
            break;
        }
      };

      bindActions();
      watchInputs();
      initTheme();
      setProvider(fields.provider_ai?.value || 'gemini');
      send('load-settings');
      setActiveTab('layout');
      if (fields.wp_token) fields.wp_token.setAttribute('type', 'password');

      function toggleResultButtons(enabled) {
        if (btnCopy) btnCopy.disabled = !enabled;
        if (btnDownload) btnDownload.disabled = !enabled;
        if (btnExport) btnExport.disabled = !enabled;
      }
      toggleResultButtons(false);

      function toggleProgress(show) {
        if (!progress) return;
        if (show) {
          progress.classList.remove('hidden');
          progress.style.display = 'flex';
        } else {
          progress.classList.add('hidden');
          progress.style.display = 'none';
        }
      }

      async function copyToClipboard(text) {
        try {
          await navigator.clipboard.writeText(text);
          addLog('JSON copiado.', 'success');
        } catch (e) {
          addLog('Falha ao copiar no navegador.', 'error');
        }
      }

      function downloadPayload(text) {
        const blob = new Blob([text], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'elementor.json';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        addLog('Download iniciado.', 'info');
      }

      // Resizer handle (drag to resize the plugin window)
      const resizer = document.getElementById('resizer-handle');
      if (resizer) {
        let startX = 0, startY = 0, startW = window.innerWidth, startH = window.innerHeight;
        const onMove = (clientX, clientY) => {
          const newW = Math.min(1500, Math.max(600, startW + (clientX - startX)));
          const newH = Math.min(1000, Math.max(500, startH + (clientY - startY)));
          send('resize-ui', { width: newW, height: newH });
        };
        const onMouseMove = (e) => { e.preventDefault(); onMove(e.clientX, e.clientY); };
        const onMouseUp = () => {
          window.removeEventListener('mousemove', onMouseMove);
          window.removeEventListener('mouseup', onMouseUp);
        };
        resizer.addEventListener('mousedown', (e) => {
          e.preventDefault();
          startX = e.clientX;
          startY = e.clientY;
          startW = window.innerWidth;
          startH = window.innerHeight;
          window.addEventListener('mousemove', onMouseMove);
          window.addEventListener('mouseup', onMouseUp);
        });
        // suporte touch
        const onTouchMove = (e) => {
          const t = e.touches[0];
          if (t) onMove(t.clientX, t.clientY);
        };
        const onTouchEnd = () => {
          window.removeEventListener('touchmove', onTouchMove);
          window.removeEventListener('touchend', onTouchEnd);
        };
        resizer.addEventListener('touchstart', (e) => {
          const t = e.touches[0];
          if (!t) return;
          startX = t.clientX;
          startY = t.clientY;
          startW = window.innerWidth;
          startH = window.innerHeight;
          window.addEventListener('touchmove', onTouchMove);
          window.addEventListener('touchend', onTouchEnd);
        }, { passive: true });
      }
    })();
  </script>
</body>

</html>










