<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Figma to WP Elementor</title>
  <style>
    /* tokens */
    :root {
      --font: "Inter", sans-serif;
      --space-1: 6px;
      --space-2: 12px;
      --space-3: 18px;
      --space-4: 24px;
      --radius: 10px;
      --color-bg: #f5f6fb;
      --color-panel: #ffffff;
      --color-border: #e2e5ec;
      --color-text: #111318;
      --color-text-secondary: #000000;
      --color-primary: #0c7bff;
      --color-primary-hover: #0063cc;
      --shadow-1: 0 6px 18px rgba(0, 0, 0, 0.07);
    }

    :root.dark {
      --color-bg: #1c1c1f;
      --color-panel: #2a2a2e;
      --color-border: #3a3a3e;
      --color-text: #8d8d8d;
      --color-text-secondary: #e6e6e6;
      --color-primary: #3ea6ff;
      --color-primary-hover: #1c8dd5;
      --shadow-1: 0 8px 20px rgba(0, 0, 0, 0.35);
    }

    @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap");

    :root {
      --anim: 180ms ease;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: var(--font, 'Inter'), system-ui, -apple-system, sans-serif;
      background: var(--color-bg);
      color: var(--color-text);
    }

    .app {
      width: 100%;
      /* max-width: 800px; */
      margin: 0 auto;
      min-height: 100vh;
      padding: var(--space-3);
    }

    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-2);
    }

    .brand {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .brand-title {
      font-weight: 700;
      font-size: 19px;
      color: var(--color-text);
    }

    .brand-subtitle {
      font-size: 13px;
      color: var(--color-text-secondary);
    }

    .top-actions {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .btn {
      border: 1px solid var(--color-border);
      border-radius: var(--radius);
      padding: 10px 14px;
      font-weight: 600;
      cursor: pointer;
      transition: transform var(--anim), box-shadow var(--anim), background var(--anim);
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-1);
    }

    .btn.primary {
      background: #0c7bff;
      border-color: #0c7bff;
      color: #fff;
    }

    .btn.secondary {
      background: #eef1f6;
      color: #1d1f25;
    }

    .btn.ghost {
      background: var(--color-panel);
      color: var(--color-text-secondary);
      border-color: var(--color-border);
    }

    .btn.small {
      padding: 6px 10px;
      font-size: 12px;
    }

    .btn.tiny {
      padding: 6px 10px;
      font-size: 12px;
    }

    .btn:disabled {
      opacity: 0.45;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    .switch {
      position: relative;
      display: inline-block;
      width: 56px;
      height: 30px;
    }

    .switch input {
      display: none;
    }

    .slider {
      position: absolute;
      inset: 0;
      cursor: pointer;
      background: var(--color-border);
      border-radius: 999px;
      transition: var(--anim);
    }

    .slider:before {
      content: "";
      position: absolute;
      left: 4px;
      top: 4px;
      width: 22px;
      height: 22px;
      background: var(--color-panel);
      border-radius: 50%;
      box-shadow: var(--shadow-1);
      transition: var(--anim);
      z-index: 2;
    }

    .slider .sun,
    .slider .moon {
      position: absolute;
      font-size: 13px;
      top: 7px;
      transition: var(--anim);
    }

    .slider .sun {
      left: 10px;
      opacity: 1;
    }

    .slider .moon {
      right: 10px;
      opacity: 0;
    }

    input:checked+.slider {
      background: var(--color-primary);
    }

    input:checked+.slider:before {
      transform: translateX(26px);
    }

    input:checked+.slider .sun {
      opacity: 0;
      transform: translateX(-6px);
    }

    input:checked+.slider .moon {
      opacity: 1;
      transform: translateX(6px);
    }

    .tabs {
      display: flex;
      gap: 0;
      background: var(--color-panel);
      border: 1px solid var(--color-border);
      border-radius: var(--radius);
      position: relative;
      overflow: hidden;
    }

    .tab-btn {
      flex: 1;
      padding: var(--space-2);
      border: none;
      background: transparent;
      font-weight: 600;
      color: var(--color-text-secondary);
      cursor: pointer;
      position: relative;
      transition: color var(--anim), background var(--anim);
    }

    .tab-btn.active {
      color: var(--color-primary);
    }

    .tab-btn:hover {
      background: rgba(0, 0, 0, 0.02);
    }

    .tab-indicator {
      position: absolute;
      bottom: 0;
      left: 0;
      height: 3px;
      width: 25%;
      background: var(--color-primary);
      transition: transform var(--anim), width var(--anim);
    }

    .tab-panels {
      margin-top: var(--space-2);
    }

    .tab-panel {
      display: none;
      animation: fadeIn var(--anim);
    }

    .tab-panel.active {
      display: block;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(4px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .row {
      display: flex;
      gap: 16px;
      margin-bottom: 12px;
    }

    .card {
      background: var(--color-panel);
      border: 1px solid var(--color-border);
      border-radius: var(--radius);
      padding: var(--space-3);
      margin-bottom: var(--space-3);
      box-shadow: var(--shadow-1);
    }

    .card-title {
      font-weight: 700;
      margin-bottom: var(--space-2);
      color: var(--color-text);
    }

    .actions {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: var(--space-2);
    }

    .input-label {
      display: block;
      width: 56px;
      height: 30px;
    }

    .switch input {
      display: none;
    }

    .slider {
      position: absolute;
      inset: 0;
      cursor: pointer;
      background: var(--color-border);
      border-radius: 999px;
      transition: var(--anim);
    }

    .slider:before {
      content: "";
      position: absolute;
      left: 4px;
      top: 4px;
      width: 22px;
      height: 22px;
      background: var(--color-panel);
      border-radius: 50%;
      box-shadow: var(--shadow-1);
      transition: var(--anim);
      z-index: 2;
    }

    .slider .sun,
    .slider .moon {
      position: absolute;
      font-size: 13px;
      top: 7px;
      transition: var(--anim);
    }

    .slider .sun {
      left: 10px;
      opacity: 1;
    }

    .slider .moon {
      right: 10px;
      opacity: 0;
    }

    input:checked+.slider {
      background: var(--color-primary);
    }

    input:checked+.slider:before {
      transform: translateX(26px);
    }

    input:checked+.slider .sun {
      opacity: 0;
      transform: translateX(-6px);
    }

    input:checked+.slider .moon {
      opacity: 1;
      transform: translateX(6px);
    }

    .tabs {
      display: flex;
      gap: 0;
      background: var(--color-panel);
      border: 1px solid var(--color-border);
      border-radius: var(--radius);
      position: relative;
      overflow: hidden;
    }

    .tab-btn {
      flex: 1;
      padding: var(--space-2);
      border: none;
      background: transparent;
      font-weight: 600;
      color: var(--color-text-secondary);
      cursor: pointer;
      position: relative;
      transition: color var(--anim), background var(--anim);
    }

    .tab-btn.active {
      color: var(--color-primary);
    }

    .tab-btn:hover {
      background: rgba(0, 0, 0, 0.02);
    }

    .tab-indicator {
      position: absolute;
      bottom: 0;
      left: 0;
      height: 3px;
      width: 25%;
      background: var(--color-primary);
      transition: transform var(--anim), width var(--anim);
    }

    .tab-panels {
      margin-top: var(--space-2);
    }

    .tab-panel {
      display: none;
      animation: fadeIn var(--anim);
    }

    .tab-panel.active {
      display: block;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(4px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .row {
      display: flex;
      gap: 16px;
      margin-bottom: 12px;
    }

    .card {
      background: var(--color-panel);
      border: 1px solid var(--color-border);
      border-radius: var(--radius);
      padding: var(--space-3);
      margin-bottom: var(--space-3);
      box-shadow: var(--shadow-1);
    }

    .card-title {
      font-weight: 700;
      margin-bottom: var(--space-2);
      color: var(--color-text);
    }

    .actions {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: var(--space-2);
    }

    .input-label {
      display: block;
      margin: var(--space-2) 0 var(--space-1);
      font-weight: 600;
      color: var(--color-text-secondary);
    }

    input[type="text"],
    input[type="password"] {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--color-border);
      border-radius: var(--radius);
      font-size: 14px;
      background: #fff;
      color: var(--color-text);
    }

    .checkbox {
      display: flex;
      gap: 8px;
      align-items: center;
      margin: 6px 0;
      color: var(--color-text-secondary);
    }

    #output,
    #logs {
      width: 100%;
      min-height: 160px;
      border: 1px solid var(--color-border);
      border-radius: var(--radius);
      padding: 12px;
      font-family: "SFMono-Regular", Consolas, monospace;
      color: var(--color-text-secondary);
      margin-bottom: 8px;
    }

    .provider-block {
      display: none;
    }

    body[data-provider="gemini"] .provider-gemini,
    body[data-provider="gpt"] .provider-gpt {
      display: block;
    }

    .ai-hidden {
      display: none !important;
    }

    .help-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: var(--space-2);
    }

    .help-item {
      padding: var(--space-2);
      border: 1px solid var(--color-border);
      border-radius: var(--radius);
      background: #f9fafb;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .help-item .label {
      font-weight: 600;
      color: var(--color-text);
    }

    .muted {
      color: var(--color-text-secondary);
      font-size: 12px;
      margin-top: var(--space-2);
    }

    body.dark {
      background: var(--color-bg);
      color: var(--color-text);
    }

    body.dark .tabs {
      border-color: var(--color-border);
      background: var(--color-panel);
    }

    body.dark .tab-btn {
      color: var(--color-text-secondary);
    }

    body.dark .tab-btn.active {
      color: var(--color-primary);
    }

    body.dark .card {
      background: var(--color-panel);
      border-color: var(--color-border);
    }

    body.dark .btn.secondary {
      background: #3a3a3e;
      color: #f5f5f5;
    }

    body.dark .btn.ghost {
      background: #2a2a2e;
      color: #f5f5f5;
    }

    body.dark input[type="text"],
    body.dark input[type="password"] {
      background: #1f1f22;
      border-color: var(--color-border);
      color: #eee;
    }

    body.dark #output,
    body.dark #logs {
      background: #242424;
      color: #eee;
      border-color: var(--color-border);
    }

    body.dark .help-item {
      background: #2f2f2f;
      border-color: var(--color-border);
    }

    body.dark .help-item .label {
      color: #f5f5f5;
    }

    /* Estilos para Grid Compacto e Busca */
    .help-grid.compact {
      grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
      gap: 8px;
    }

    .help-item.compact {
      flex-direction: column;
      align-items: flex-start;
      padding: 8px;
      gap: 8px;
    }

    .help-item.compact .item-header {
      display: flex;
      align-items: center;
      gap: 6px;
      width: 100%;
      margin-bottom: 2px;
    }

    .help-item.compact .item-icon {
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--color-primary);
      opacity: 0.8;
    }

    .help-item.compact .label {
      font-size: 11px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      flex: 1;
    }

    .help-item.compact .btn {
      width: 100%;
      justify-content: center;
      padding: 4px;
      font-size: 10px;
      height: 24px;
    }

    .card.compact {
      padding: 10px;
      margin-bottom: 10px;
    }

    .card-title.small {
      font-size: 12px;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      opacity: 0.8;
    }

    .search-box {
      margin-bottom: 12px;
      position: sticky;
      top: 0;
      z-index: 10;
      background: var(--color-bg);
      padding-bottom: 8px;
    }

    .search-input {
      width: 100%;
      padding: 8px 12px 8px 32px;
      border: 1px solid var(--color-border);
      border-radius: var(--radius);
      font-size: 13px;
      background: var(--color-panel);
      color: var(--color-text);
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='14' viewBox='0 0 24 24' fill='none' stroke='%23999' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='11' cy='11' r='8'%3E%3C/circle%3E%3C/svg>");
      background-repeat: no-repeat;
      background-position: 10px center;
    }

    .search-status {
      font-size: 11px;
      color: var(--color-text-secondary);
      margin-bottom: 8px;
      padding: 0 4px;
    }

    .empty-state {
      padding: 20px;
      text-align: center;
      color: var(--color-text-secondary);
      font-size: 13px;
      background: var(--color-panel);
      border-radius: var(--radius);
      border: 1px dashed var(--color-border);
    }

    body.dark .search-input {
      background-color: #2a2a2e;
      border-color: #3a3a3e;
      color: #eee;
    }

    * {
      scrollbar-width: thin;
      scrollbar-color: var(--color-border) transparent;
    }

    *::-webkit-scrollbar {
      width: 8px;
    }

    *::-webkit-scrollbar-track {
      background: transparent;
    }

    *::-webkit-scrollbar-thumb {
      background: var(--color-border);
      border-radius: 4px;
    }

    /* Resizer handle */
    #resizer-handle {
      position: fixed;
      width: 26px;
      height: 26px;
      right: 0px;
      bottom: 0px;
      cursor: se-resize;
      opacity: 1;
      /* background: var(--color-panel); */
      /* border: 1px solid var(--color-border); */
      /* border-radius: 10px; */
      /* transition: opacity var(--anim), background var(--anim), transform var(--anim); */
      z-index: 9999;
      /* box-shadow: var(--shadow-1); */
      pointer-events: auto;
      background-image: url("data:image/svg+xml;utf8,<svg viewBox='0 0 18 18' xmlns='http://www.w3.org/2000/svg' fill='%23f5a905' stroke='%23f5a905'><path fill='%23000000' d='M14.228 16.227a1 1 0 0 1-.707-1.707l1-1a1 1 0 0 1 1.416 1.414l-1 1a1 1 0 0 1-.707.293zm-5.638 0a1 1 0 0 1-.707-1.707l6.638-6.638a1 1 0 0 1 1.416 1.414l-6.638 6.638a1 1 0 0 1-.707.293zm-5.84 0a1 1 0 0 1-.707-1.707L14.52 2.043a1 1 0 1 1 1.415 1.414L3.457 15.934a1 1 0 0 1-.707.293z'></path></svg>");
      background-repeat: no-repeat;
      background-position: center;
      /* background-size: 16px; */
    }

    #resizer-handle:hover {
      opacity: 0.65;
      transform: scale(1.05);
    }

    body.dark #resizer-handle {
      background: #1f1f22;
      opacity: 0.42;
    }

    .progress {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .progress.hidden {
      display: none;
    }

    .progress-bar {
      width: 120px;
      height: 8px;
      border-radius: 999px;
      background: var(--color-border);
      position: relative;
      overflow: hidden;
    }

    .progress-bar::after {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(90deg, var(--color-primary) 0%, #5fb5ff 100%);
      width: 60%;
      animation: slide 1s infinite;
    }

    .progress-text {
      font-size: 12px;
      color: var(--color-text-secondary);
    }

    @keyframes slide {
      0% {
        transform: translateX(-100%);
      }

      50% {
        transform: translateX(0%);
      }

      100% {
        transform: translateX(100%);
      }
    }
  </style>
</head>

<body>
  <div class="app">
    <header class="topbar">
      <div class="brand">
        <div class="brand-title">Figma to WP Elementor</div>
        <div class="brand-subtitle">Convers&#227;o inteligente para Containers Flex</div>
      </div>
      <div class="top-actions">
        <label class="switch" title="Alternar tema">
          <input type="checkbox" id="theme-toggle" />
          <span class="slider">
            <span class="sun">&#9728;</span>
            <span class="moon">&#127769;</span>
          </span>
        </label>
      </div>
    </header>

    <nav class="tabs">
      <button class="tab-btn active" data-tab="layout">Layout &rarr; Elementor</button>
      <button class="tab-btn" data-tab="ai">Configura&#231;&#227;o da IA</button>
      <button class="tab-btn" data-tab="wp">WordPress</button>
      <button class="tab-btn" data-tab="help">Ajuda</button>
      <span class="tab-indicator"></span>
    </nav>

    <main class="tab-panels">
      <section class="tab-panel active" data-panel="layout">
        <div class="card">
          <div class="card-title">A&#231;&#245;es r&#225;pidas</div>
          <div class="row">
            <button id="btn_inspect" class="btn secondary">Inspecionar Layout</button>
            <button id="btn_generate" class="btn primary">Gerar JSON</button>
            <button id="btn_rename_layers" class="btn secondary">Renomear Layers</button>
          </div>
          <div class="row">
            <button id="btn_download" class="btn secondary" data-action="download-json">Baixar JSON</button>
            <button id="btn_reset" class="btn secondary" data-action="reset">Reiniciar</button>
          </div>
        </div>
        <div class="card">
          <div class="card-title">Sa&#237;da / Logs</div>
          <div id="progress" class="progress hidden">
            <div class="progress-bar"></div>
            <span class="progress-text">Processando pipeline...</span>
          </div>
          <textarea id="output" placeholder="O JSON gerado aparecer&#225; aqui" readonly></textarea>
          <div style="margin-top:12px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
              <label class="input-label" style="margin:0;">Logs</label>
              <button id="btn_download_logs" class="btn tiny secondary">Baixar Logs</button>
            </div>
            <textarea id="logs" class="logs" readonly placeholder="Logs do sistema..."></textarea>
          </div>
          <div style="margin-top:12px;">
            <label style="display:block;font-size:12px;margin-bottom:6px;">JSON gerado (selecionamos automaticamente; se
              precisar use Ctrl+C):</label>
            <textarea id="figma-json-output" style="width:100%;height:200px"
              placeholder="JSON para copiar/colar no Elementor"></textarea>
            <div style="display:flex;gap:8px;margin-top:8px;align-items:center;">
              <button class="btn secondary" id="copy-manual">Copiar JSON</button>
              <span style="font-size:12px;color:#999;">Se o navegador bloquear, selecione o campo e pressione
                Ctrl+C.</span>
            </div>
          </div>
        </div>
      </section>

      <section class="tab-panel" data-panel="ai">
        <div class="card">
          <div class="card-title">Configura&#231;&#227;o da IA</div>
          <label class="checkbox">
            <input id="use_ai" type="checkbox" checked />
            <span>Usar IA para convers&#227;o</span>
          </label>
          <label class="input-label" for="provider_ai">Provedor de IA</label>
          <select id="provider_ai">
            <option value="gemini">Gemini</option>
            <option value="gpt">GPT (OpenAI)</option>
          </select>

          <div id="ai_settings">
            <div class="provider-block provider-gemini">
              <label class="input-label" for="gemini_api_key">Gemini API Key</label>
              <input id="gemini_api_key" type="password" autocomplete="off" placeholder="Cole sua API Key do Gemini" />
              <label class="input-label" for="gemini_model">Modelo</label>
              <select id="gemini_model">
                <option value="gemini-2.0-flash-exp">gemini-2.0-flash-exp (Experimental)</option>
                <option value="gemini-1.5-pro-002">gemini-1.5-pro-002 (Stable)</option>
                <option value="gemini-1.5-flash-002">gemini-1.5-flash-002 (Fast & Stable)</option>
              </select>
              <div class="actions">
                <button class="btn primary" data-action="test-gemini">Testar conex&#227;o</button>
              </div>
              <div id="gemini-status" class="status"></div>
            </div>

            <div class="provider-block provider-gpt">
              <label class="input-label" for="gpt_api_key">OpenAI API Key</label>
              <input id="gpt_api_key" type="password" autocomplete="off" placeholder="Cole sua chave da OpenAI" />
              <label class="input-label" for="gpt_model">Modelo GPT</label>
              <select id="gpt_model">
                <option value="gpt-4.1-mini">gpt-4.1-mini (recomendado)</option>
                <option value="gpt-4.1">gpt-4.1</option>
                <option value="gpt-4.1-preview">gpt-4.1-preview</option>
                <option value="gpt-o1">gpt-o1</option>
                <option value="gpt-o3-mini">gpt-o3-mini</option>
              </select>
              <div class="actions">
                <button class="btn primary" data-action="test-gpt">Testar conex&#227;o GPT</button>
              </div>
              <div id="gpt-status" class="status"></div>
            </div>
          </div>
          <div class="checkbox-group">
            <label class="checkbox">
              <input id="include_screenshot" type="checkbox" checked />
              <span>Enviar print do frame para a IA (Melhora precis&#227;o)</span>
            </label>
            <label class="checkbox">
              <input id="include_references" type="checkbox" checked />
              <span>Enviar arquivos de refer&#234;ncia (.md) junto com o pedido</span>
            </label>
          </div>
      </section>

      <section class="tab-panel" data-panel="wp">
        <div class="card">
          <div class="card-title">WordPress</div>
          <label class="input-label" for="wp_url">WP URL</label>
          <input id="wp_url" type="text" autocomplete="off" placeholder="https://site.com" />

          <label class="input-label" for="wp_user">Usu&#225;rio WP</label>
          <input id="wp_user" type="text" autocomplete="username" placeholder="usu&#225;rio" />

          <label class="input-label" for="wp_token">Senha do App (Token)</label>
          <input id="wp_token" type="password" autocomplete="current-password"
            placeholder="Senha de aplica&#231;&#227;o do WP" />

          <label class="checkbox">
            <input id="wp_export_images" type="checkbox" />
            <span>Exportar imagens automaticamente</span>
          </label>
          <label class="checkbox">
            <input id="wp_create_page" type="checkbox" />
            <span>Criar p&#225;gina automaticamente</span>
          </label>

          <div class="actions">
            <button class="btn primary" data-action="test-wp">Testar conex&#227;o</button>
            <button class="btn secondary" data-action="export-wp">Exportar WP</button>
          </div>
          <div id="wp-status" class="status"></div>
        </div>
      </section>

      <section class="tab-panel" data-panel="help">
        <div class="search-box">
          <input type="text" id="widget-search" class="search-input"
            placeholder="Buscar widget (ex: button, woo, pro)..." autocomplete="off" />
        </div>
        <div id="widget-list-container"></div>
      </section>
    </main>
  </div>
  <div id="resizer-handle" aria-label="Arraste para redimensionar"></div>

  <script>
    (() => {
      const tabs = document.querySelectorAll('.tab-btn');
      const panels = document.querySelectorAll('.tab-panel');
      const indicator = document.querySelector('.tab-indicator');
      const output = document.getElementById('output');
      const logs = document.getElementById('logs');
      const btnInspect = document.getElementById('btn_inspect');
      const btnDownload = document.querySelector('[data-action="download-json"]');
      const btnCopy = document.querySelector('[data-action="copy-json"]');
      const btnExport = document.querySelector('[data-action="export-wp"]');

      document.getElementById('btn_generate').onclick = () => {
        const payload = {
          type: 'generate-json',
          apiKey: fields.gpt_api_key?.value || '',
          gptModel: fields.gpt_model?.value || '',
          geminiModel: fields.gemini_model?.value || '',
          includeScreenshot: fields.include_screenshot?.checked !== false,
          includeReferences: fields.include_references?.checked !== false,
          autoRename: fields.auto_rename_layers?.checked || false
        };
        // ... rest of generate logic
        send('generate-json', payload);
      };

      document.getElementById('btn_rename_layers').onclick = () => {
        send('run-heuristics-rename');
      };

      document.getElementById('btn_inspect').onclick = () => {
        send('inspect');
      };
      const themeToggle = document.getElementById('theme-toggle');
      const darkSheet = document.getElementById('theme-dark');
      const bridgeOutput = document.getElementById('figma-json-output');
      const btnCopyManual = document.getElementById('copy-manual');
      let lastPayload = '';
      let fullPayload = '';

      const fields = {
        use_ai: document.getElementById('use_ai'),
        provider_ai: document.getElementById('provider_ai'),
        gemini_api_key: document.getElementById('gemini_api_key'),
        gemini_model: document.getElementById('gemini_model'),
        gpt_api_key: document.getElementById('gpt_api_key'),
        gpt_model: document.getElementById('gpt_model'),
        include_screenshot: document.getElementById('include_screenshot'),
        include_references: document.getElementById('include_references'),
        wp_url: document.getElementById('wp_url'),
        wp_user: document.getElementById('wp_user'),
        wp_token: document.getElementById('wp_token'),
        wp_export_images: document.getElementById('wp_export_images'),
        wp_create_page: document.getElementById('wp_create_page')
      };
      const aiSettings = document.getElementById('ai_settings');

      const storage = null; // desativado para evitar SecurityError em sandbox
      const updateBridgeOutput = (value, autoSelect = false) => {
        if (!bridgeOutput) return;
        bridgeOutput.value = value || '';
        if (autoSelect) {
          requestAnimationFrame(() => {
            bridgeOutput.focus();
            bridgeOutput.select();
          });
        }
      };

      function debounce(fn, wait = 300) {
        let t;
        return (...args) => {
          clearTimeout(t);
          t = setTimeout(() => fn(...args), wait);
        };
      }

      function updateIndicator() {
        const active = document.querySelector('.tab-btn.active');
        if (!indicator || !active || !active.parentElement) return;
        const rect = active.getBoundingClientRect();
        const parentRect = active.parentElement.getBoundingClientRect();
        indicator.style.width = `${rect.width}px`;
        indicator.style.transform = `translateX(${rect.left - parentRect.left}px)`;
      }

      function setActiveTab(name) {
        tabs.forEach(t => t.classList.toggle('active', t.dataset.tab === name));
        panels.forEach(p => p.classList.toggle('active', p.dataset.panel === name));
        updateIndicator();
      }

      function setProvider(providerId) {
        const value = providerId === 'gpt' ? 'gpt' : 'gemini';
        document.body?.setAttribute('data-provider', value);
        if (fields.provider_ai) fields.provider_ai.value = value;
      }

      function toggleAIFields(enabled) {
        document.body?.setAttribute('data-use-ai', enabled ? 'true' : 'false');
        if (aiSettings) {
          aiSettings.classList.toggle('ai-hidden', !enabled);
        }
      }

      tabs.forEach(btn => btn.addEventListener('click', () => setActiveTab(btn.dataset.tab)));

      function applyTheme(isDark) {
        document.documentElement.classList.toggle('dark', isDark);
        if (themeToggle) themeToggle.checked = isDark;
        if (darkSheet) darkSheet.disabled = !isDark;
        if (storage) {
          try { storage.setItem('figtoel-theme', isDark ? 'dark' : 'light'); } catch (_) { /* ignore */ }
        }
      }

      function send(type, payload) {
        parent.postMessage({ pluginMessage: { type, payload } }, '*');
      }

      function initTheme(pref) {
        if (typeof pref === 'boolean') {
          applyTheme(pref);
        } else {
          const sysDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
          applyTheme(sysDark);
        }
      }

      function watchInputs() {
        // Monitora inputs
      }

      function bindActions() {
        if (themeToggle) {
          themeToggle.addEventListener('change', (e) => applyTheme(e.target.checked));
        }
      }

      window.onmessage = (event) => {
        const msg = (event.data || {}).pluginMessage;
        if (!msg) return;
        switch (msg.type) {
          case 'preview':
            if (output) output.value = msg.payload || '';
            break;
          case 'generation-complete':
            lastPayload = msg.pastePayload || msg.payload || '';
            fullPayload = msg.payload || '';
            updateBridgeOutput(lastPayload, true);
            addLog('JSON gerado.', 'info');
            toggleProgress(false);
            toggleResultButtons(true);
            break;
          case 'copy-json': {
            const txt = msg.payload || '';
            lastPayload = txt;
            updateBridgeOutput(txt, true);
            addLog('JSON pronto para copiar.', 'info');
            break;
          }
          case 'generation-error':
            toggleProgress(false);
            toggleResultButtons(false);
            alert(`Erro na geracao: ${msg.message}`);
            break;
          case 'generation-start':
            toggleProgress(true);
            updateBridgeOutput('', false);
            toggleResultButtons(false);
            break;
          case 'gemini-status':
            addLog(msg.message || 'Status Gemini', msg.success ? 'success' : 'error');
            const gs = document.getElementById('gemini-status');
            if (gs) gs.textContent = msg.message;
            break;
          case 'gpt-status':
            addLog(msg.message || 'Status GPT', msg.success ? 'success' : 'error');
            const gptStatus = document.getElementById('gpt-status');
            if (gptStatus) gptStatus.textContent = msg.message;
            break;
          case 'wp-status':
            addLog(msg.message || 'Status WP', msg.success ? 'success' : 'error');
            const ws = document.getElementById('wp-status');
            if (ws) ws.textContent = msg.message;
            break;
          case 'save-debug-json':
            if (msg.name && msg.data) {
              try {
                const blob = new Blob([msg.data], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = msg.name;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                addLog(`Debug JSON salvo: ${msg.name}`, 'info');
              } catch (err) {
                console.error('[UI] Erro ao salvar debug JSON:', err);
                addLog('Erro ao salvar debug JSON.', 'error');
              }
            }
            break;
          case 'log':
            if (typeof msg.message === 'string' && msg.message.includes('Iniciando pipeline')) {
              toggleProgress(true);
              setProvider(fields.provider_ai?.value || 'gemini');
              toggleAIFields(fields.use_ai?.checked !== false);
              send('load-settings');
              setActiveTab('layout');
              if (fields.wp_token) fields.wp_token.setAttribute('type', 'password');
            }
            addLog(msg.message, msg.level);
            break;
        }
      };

      function addLog(message, level = 'info') {
        if (!logs) return;
        const now = new Date();
        const time = now.toLocaleTimeString('pt-BR', { hour12: false });
        const line = `[${time}] [${level}] ${message}\n`;
        logs.value += line;
        logs.scrollTop = logs.scrollHeight;
      }

      function toggleResultButtons(enabled) {
        if (btnCopy) btnCopy.disabled = !enabled;
        if (btnDownload) btnDownload.disabled = !enabled;
        if (btnExport) btnExport.disabled = !enabled;
      }

      function toggleProgress(show) {
        const progress = document.getElementById('progress');
        if (!progress) return;
        if (show) {
          progress.classList.remove('hidden');
        } else {
          progress.classList.add('hidden');
        }
      }

      async function copyWithFallback(text, label = 'JSON') {
        try {
          await navigator.clipboard.writeText(text);
          addLog(`${label} copiado.`, 'success');
          return true;
        } catch (e) {
          try {
            const ta = document.createElement('textarea');
            ta.value = text;
            ta.style.position = 'fixed';
            ta.style.opacity = '0';
            document.body.appendChild(ta);
            ta.focus();
            ta.select();
            const ok = document.execCommand('copy');
            document.body.removeChild(ta);
            if (ok) {
              addLog(`${label} copiado (fallback).`, 'success');
              return true;
            }
          } catch (_) { /* ignore */ }
          if (bridgeOutput) {
            bridgeOutput.focus();
            bridgeOutput.select();
          }
          addLog('Falha ao copiar. Selecione o campo e pressione Ctrl+C.', 'warn');
          return false;
        }
      }

      // Resizer
      const resizer = document.getElementById('resizer-handle');
      if (resizer) {
        let startX = 0, startY = 0, startW = window.innerWidth, startH = window.innerHeight;
        const onMove = (clientX, clientY) => {
          const newW = Math.min(1500, Math.max(600, startW + (clientX - startX)));
          const newH = Math.min(1000, Math.max(500, startH + (clientY - startY)));
          send('resize-ui', { width: newW, height: newH });
        };
        const onMouseMove = (e) => { e.preventDefault(); onMove(e.clientX, e.clientY); };
        const onMouseUp = () => {
          window.removeEventListener('mousemove', onMouseMove);
          window.removeEventListener('mouseup', onMouseUp);
        };
        resizer.addEventListener('mousedown', (e) => {
          e.preventDefault();
          startX = e.clientX;
          startY = e.clientY;
          startW = window.innerWidth;
          startH = window.innerHeight;
          window.addEventListener('mousemove', onMouseMove);
          window.addEventListener('mouseup', onMouseUp);
        });
      }

      // Icons
      const ICONS = {
        text: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 7V4h16v3M9 20h6M12 4v16"/></svg>`,
        image: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>`,
        button: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="8" width="18" height="8" rx="2"/><line x1="12" y1="12" x2="12" y2="12"/></svg>`,
        container: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M9 21V9"/></svg>`,
        woo: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></svg>`,
        star: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>`,
        video: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/></svg>`,
        menu: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>`,
        form: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>`,
        default: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>`
      };

      function getWidgetIcon(name) {
        if (name.includes('image') || name.includes('gallery') || name.includes('thumb')) return ICONS.image;
        if (name.includes('text') || name.includes('heading') || name.includes('title')) return ICONS.text;
        if (name.includes('button') || name.includes('btn') || name.includes('link')) return ICONS.button;
        if (name.includes('container') || name.includes('section') || name.includes('div')) return ICONS.container;
        if (name.includes('woo') || name.includes('product') || name.includes('cart')) return ICONS.woo;
        if (name.includes('star') || name.includes('rating') || name.includes('review')) return ICONS.star;
        if (name.includes('video') || name.includes('youtube')) return ICONS.video;
        if (name.includes('menu') || name.includes('nav')) return ICONS.menu;
        if (name.includes('form') || name.includes('input')) return ICONS.form;
        return ICONS.default;
      }

      const WIDGET_DATA = {
        'Basicos': [
          'heading', 'text', 'button', 'image', 'icon', 'video', 'divider', 'spacer', 'image-box', 'icon-box',
          'star-rating', 'counter', 'progress', 'tabs', 'accordion', 'toggle', 'alert', 'social-icons',
          'soundcloud', 'shortcode', 'html', 'menu-anchor', 'sidebar', 'read-more', 'image-carousel',
          'basic-gallery', 'gallery', 'icon-list', 'nav-menu', 'search-form', 'google-maps', 'testimonial',
          'embed', 'lottie', 'loop:grid'
        ],
        'Pro': [
          'form', 'login', 'subscription', 'call-to-action', 'media:carousel', 'portfolio', 'gallery-pro',
          'slider:slides', 'slideshow', 'flip-box', 'animated-headline', 'post-navigation', 'share-buttons',
          'table-of-contents', 'countdown', 'blockquote', 'testimonial-carousel', 'review-box', 'hotspots',
          'sitemap', 'author-box', 'price-table', 'price-list', 'progress-tracker', 'animated-text',
          'nav-menu-pro', 'breadcrumb', 'facebook-button', 'facebook-comments', 'facebook-embed',
          'facebook-page', 'loop:builder', 'loop:grid-advanced', 'loop:carousel', 'post-excerpt',
          'post-content', 'post-title', 'post-info', 'post-featured-image', 'post-author', 'post-date',
          'post-terms', 'archive-title', 'archive-description', 'site-logo', 'site-title', 'site-tagline',
          'search-results', 'global-widget', 'video-playlist', 'video-gallery'
        ],
        'WooCommerce': [
          'woo:product-title', 'woo:product-image', 'woo:product-price', 'woo:product-add-to-cart',
          'woo:product-data-tabs', 'woo:product-excerpt', 'woo:product-rating', 'woo:product-stock',
          'woo:product-meta', 'woo:product-additional-information', 'woo:product-short-description',
          'woo:product-related', 'woo:product-upsells', 'woo:product-tabs', 'woo:product-breadcrumb',
          'woo:product-gallery', 'woo:products', 'woo:product-grid', 'woo:product-carousel',
          'woo:product-loop-item', 'woo:loop-product-title', 'woo:loop-product-price',
          'woo:loop-product-rating', 'woo:loop-product-image', 'woo:loop-product-button',
          'woo:loop-product-meta', 'woo:cart', 'woo:checkout', 'woo:my-account', 'woo:purchase-summary',
          'woo:order-tracking'
        ],
        'Loop Builder': [
          'loop:item', 'loop:image', 'loop:title', 'loop:meta', 'loop:terms', 'loop:rating', 'loop:price',
          'loop:add-to-cart', 'loop:read-more', 'loop:featured-image', 'loop:pagination'
        ],
        'Experimentais': [
          'w:nested-tabs', 'w:mega-menu', 'w:scroll-snap', 'w:motion-effects', 'w:background-slideshow',
          'w:css-transform', 'w:custom-position', 'w:dynamic-tags', 'w:ajax-pagination',
          'w:aspect-ratio-container'
        ],
        'WordPress': [
          'w:wp-search', 'w:wp-recent-posts', 'w:wp-recent-comments', 'w:wp-archives', 'w:wp-categories',
          'w:wp-calendar', 'w:wp-tag-cloud', 'w:wp-custom-menu'
        ]
      };

      function renderWidgetList(filterText = '') {
        const container = document.getElementById('widget-list-container');
        if (!container) return;

        const search = filterText.toLowerCase().trim();
        let html = '';

        if (search) {
          html += `<div class="search-status">Filtrando por: "<strong>${search}</strong>"</div>`;
        }

        let hasResults = false;

        for (const [category, items] of Object.entries(WIDGET_DATA)) {
          const filteredItems = items.filter(item => {
            if (!search) return true;
            return item.toLowerCase().includes(search);
          });

          if (filteredItems.length === 0) continue;
          hasResults = true;

          html += `<div class="card compact"><div class="card-title small">${category}</div><div class="help-grid compact">`;

          filteredItems.forEach(item => {
            let fullName = item;
            if (!item.includes(':') && !item.startsWith('w:')) {
              fullName = 'w:' + item;
            }
            const icon = getWidgetIcon(fullName);

            html += `
              <div class="help-item compact" title="${fullName}">
                <div class="item-header">
                  <span class="item-icon">${icon}</span>
                  <span class="label">${fullName}</span>
                </div>
                <button class="btn tiny ghost full-width" data-rename="${fullName}">Aplicar</button>
              </div>`;
          });

          html += `</div></div>`;
        }

        if (!hasResults) {
          html = `<div class="empty-state">Nenhum widget encontrado para "${search}"</div>`;
        }

        container.innerHTML = html;
      }

      // Init
      renderWidgetList();
      bindActions();
      watchInputs();

      // Listeners
      const searchInput = document.getElementById('widget-search');
      if (searchInput) {
        searchInput.addEventListener('input', (e) => {
          renderWidgetList(e.target.value);
        });
      }

      document.body.addEventListener('click', (e) => {
        const btn = e.target.closest('[data-rename]');
        if (btn) {
          const name = btn.getAttribute('data-rename');
          send('rename-layer', { name });
        }
      });

      if (btnCopyManual) {
        btnCopyManual.addEventListener('click', async () => {
          const txt = bridgeOutput?.value || lastPayload || '';
          if (!txt) {
            addLog('Nenhum JSON gerado para copiar ainda.', 'warn');
            return;
          }
          if (bridgeOutput) {
            bridgeOutput.focus();
            bridgeOutput.select();
          }
          await copyWithFallback(txt, 'JSON');
        });
      }

      if (bridgeOutput) {
        bridgeOutput.addEventListener('click', () => {
          bridgeOutput.focus();
          bridgeOutput.select();
        });
      }

      const btnDownloadLogs = document.getElementById('btn_download_logs');
      if (btnDownloadLogs) {
        btnDownloadLogs.addEventListener('click', () => {
          const content = logs ? logs.value : '';
          if (!content) {
            alert('Sem logs para baixar.');
            return;
          }
          const blob = new Blob([content], { type: 'text/plain' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `figtoel-logs-${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.txt`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        });
      }

    })();
  </script>
</body>

</html>