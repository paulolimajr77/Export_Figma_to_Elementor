<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <style>
        :root {
            --primary: #0d6efd;
            --primary-hover: #0b5ed7;
            --bg: #ffffff;
            --text: #212529;
            --text-muted: #6c757d;
            --border: #dee2e6;
            --bg-light: #f8f9fa;
            --success: #198754;
            --danger: #dc3545;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg);
            color: var(--text);
            font-size: 13px;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        /* TABS */
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
            background: var(--bg-light);
        }

        .tab-btn {
            flex: 1;
            padding: 10px;
            border: none;
            background: none;
            cursor: pointer;
            font-weight: 500;
            color: var(--text-muted);
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .tab-btn:hover {
            color: var(--primary);
            background: rgba(13, 110, 253, 0.05);
        }

        .tab-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
            background: #fff;
        }

        /* CONTENT PANELS */
        .tab-content {
            display: none;
            padding: 16px;
            flex: 1;
            overflow-y: auto;
        }

        .tab-content.active {
            display: block;
        }

        /* FORMS & INPUTS */
        .form-group {
            margin-bottom: 12px;
        }

        label {
            display: block;
            margin-bottom: 4px;
            font-weight: 500;
            color: var(--text);
        }

        input[type="text"],
        input[type="password"],
        input[type="url"] {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: 4px;
            box-sizing: border-box;
            /* Fix padding issue */
            font-size: 13px;
        }

        input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(13, 110, 253, 0.25);
        }

        .help-text {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        /* BUTTONS */
        .btn {
            display: inline-block;
            width: 100%;
            padding: 10px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            transition: background 0.2s;
            text-align: center;
        }

        .btn:hover {
            background-color: var(--primary-hover);
        }

        .btn-secondary {
            background-color: var(--bg-light);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background-color: #e9ecef;
        }

        /* JSON OUTPUT */
        textarea {
            width: 100%;
            height: 150px;
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-family: monospace;
            font-size: 11px;
            resize: vertical;
            box-sizing: border-box;
            margin-bottom: 10px;
        }

        /* STATUS MESSAGES */
        .status-msg {
            margin-top: 10px;
            padding: 8px;
            border-radius: 4px;
            font-size: 12px;
            text-align: center;
            display: none;
        }

        .status-msg.success {
            background: #d1e7dd;
            color: #0f5132;
            display: block;
        }

        .status-msg.error {
            background: #f8d7da;
            color: #842029;
            display: block;
        }

        /* RESIZE HANDLE */
        #resize-handle {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 16px;
            height: 16px;
            cursor: nwse-resize;
            background: linear-gradient(135deg, transparent 50%, var(--text-muted) 50%);
            opacity: 0.5;
        }
    </style>
</head>

<body>

    <!-- TABS HEADER -->
    <div class="tabs">
        <button class="tab-btn active" data-tab="export">Exportar</button>
        <button class="tab-btn" data-tab="wordpress">WordPress</button>
        <button class="tab-btn" data-tab="help">Ajuda</button>
    </div>

    <!-- TAB: EXPORT -->
    <div id="export" class="tab-content active">
        <p style="margin-top: 0; color: var(--text-muted);">Selecione um frame no Figma e clique abaixo para gerar o
            JSON.</p>

        <button id="exportBtn" class="btn">Exportar para Elementor</button>

        <div id="exportStatus" class="status-msg"></div>

        <div style="margin-top: 15px;">
            <label>JSON Result:</label>
            <textarea id="jsonOutput" readonly placeholder="O JSON aparecerá aqui..."></textarea>
            <button id="copyBtn" class="btn btn-secondary">Copiar JSON</button>
        </div>
    </div>

    <!-- TAB: WORDPRESS -->
    <div id="wordpress" class="tab-content">
        <p style="margin-top: 0; color: var(--text-muted);">Configure seu site para upload automático de imagens.</p>

        <div class="form-group">
            <label>URL do Site</label>
            <input type="url" id="wpUrl" placeholder="https://seusite.com">
        </div>

        <div class="form-group">
            <label>Usuário</label>
            <input type="text" id="wpUser" placeholder="admin">
        </div>

        <div class="form-group">
            <label>Senha de Aplicação</label>
            <input type="password" id="wpPassword" placeholder="xxxx xxxx xxxx xxxx">
            <div class="help-text">Gere em: Usuários > Perfil > Senhas de Aplicação. Não use sua senha de login.</div>
        </div>

        <button id="saveWpConfig" class="btn">Salvar Configuração</button>
        <div id="wpStatus" class="status-msg"></div>
    </div>

    <!-- TAB: HELP -->
    <div id="help" class="tab-content">
        <h3>Como usar</h3>
        <ol style="padding-left: 20px; line-height: 1.6;">
            <li>Crie seu design usando Auto Layout.</li>
            <li>Selecione uma camada e clique no botão <strong>Renomear</strong> ao lado do widget desejado na lista
                abaixo.</li>
            <li>Configure o WordPress na aba ao lado para uploads de imagem.</li>
            <li>Selecione o frame principal e clique em <strong>Exportar</strong>.</li>
            <li>Copie o JSON e cole diretamente no editor do Elementor (Ctrl+V).</li>
        </ol>

        <style>
            .widget-category {
                margin-top: 20px;
                margin-bottom: 10px;
                font-weight: 700;
                color: var(--primary);
                border-bottom: 1px solid #eee;
                padding-bottom: 5px;
            }

            .widget-list {
                list-style: none;
                padding: 0;
                margin: 0;
            }

            .widget-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 6px 0;
                border-bottom: 1px solid #f0f0f0;
                font-size: 12px;
            }

            .widget-name {
                color: var(--text);
            }

            .widget-tag {
                color: var(--text-muted);
                font-family: monospace;
                margin-right: 10px;
                font-size: 11px;
            }

            .btn-rename {
                padding: 2px 8px;
                font-size: 10px;
                background: #e9ecef;
                color: var(--text);
                border: 1px solid #ced4da;
                border-radius: 4px;
                cursor: pointer;
            }

            .btn-rename:hover {
                background: var(--primary);
                color: white;
                border-color: var(--primary);
            }
        </style>

        <div id="widget-list-container"></div>

        <p class="help-text" style="margin-top: 20px;">Versão 1.0.0</p>
    </div>

    <!-- RESIZE HANDLE -->
    <div id="resize-handle"></div>

    <script>
        // --- WIDGET DATA ---
        const widgetCategories = [
            {
                title: "Widgets Nativos do Elementor (Gratuito)",
                widgets: [
                    { name: "Container / Seção", tag: "w:container" },
                    { name: "Caixa de Imagem (Image Box)", tag: "w:image-box" },
                    { name: "Caixa de Ícone (Icon Box)", tag: "w:icon-box" },
                    { name: "Imagem", tag: "w:image" },
                    { name: "Vídeo", tag: "w:video" },
                    { name: "Botão", tag: "w:button" },
                    { name: "Divisor (Divider)", tag: "w:divider" },
                    { name: "Espaçador", tag: "w:spacer" },
                    { name: "Título (Heading)", tag: "w:heading" },
                    { name: "Editor de Texto", tag: "w:text-editor" },
                    { name: "Galeria Básica", tag: "w:basic-gallery" },
                    { name: "Lista de Ícones", tag: "w:icon-list" },
                    { name: "Alerta", tag: "w:alert" },
                    { name: "SoundCloud", tag: "w:soundcloud" },
                    { name: "Google Maps", tag: "w:google_maps" },
                    { name: "Abas (Tabs)", tag: "w:tabs" },
                    { name: "Acordeão (Accordion)", tag: "w:accordion" },
                    { name: "Barra de Progresso", tag: "w:progress" },
                    { name: "Contador", tag: "w:counter" },
                    { name: "HTML Customizado", tag: "w:html" },
                    { name: "Shortcode", tag: "w:shortcode" }
                ]
            },
            {
                title: "Widgets do Elementor Pro",
                widgets: [
                    { name: "Formulário", tag: "w:form" },
                    { name: "Posts", tag: "w:posts" },
                    { name: "Slides", tag: "w:slides" },
                    { name: "Testemunhos", tag: "w:testimonial" },
                    { name: "Portfólio", tag: "w:portfolio" },
                    { name: "Lista de Preços", tag: "w:price-list" },
                    { name: "Tabela de Preços", tag: "w:price-table" },
                    { name: "Call to Action", tag: "w:call-to-action" },
                    { name: "Flip Box", tag: "w:flip-box" },
                    { name: "Carrossel de Mídia", tag: "w:media-carousel" },
                    { name: "Login", tag: "w:login" },
                    { name: "Menu de Navegação", tag: "w:nav-menu" },
                    { name: "Busca", tag: "w:search-form" },
                    { name: "Posts Archive", tag: "w:archive-posts" },
                    { name: "Breadcrumbs", tag: "w:breadcrumbs" }
                ]
            },
            {
                title: "Widgets Nativos do WordPress",
                widgets: [
                    { name: "Arquivos", tag: "w:wp-archives" },
                    { name: "Áudio", tag: "w:wp-audio" },
                    { name: "Calendário", tag: "w:wp-calendar" },
                    { name: "Categorias", tag: "w:wp-categories" },
                    { name: "Galeria WP", tag: "w:wp-gallery" },
                    { name: "Imagem WP", tag: "w:wp-image" },
                    { name: "Menu Personalizado", tag: "w:wp-custom-menu" },
                    { name: "Páginas", tag: "w:wp-pages" },
                    { name: "Pesquisar", tag: "w:wp-search" },
                    { name: "Posts Recentes", tag: "w:wp-recent-posts" },
                    { name: "Tag Cloud", tag: "w:wp-tag-cloud" },
                    { name: "Vídeo WP", tag: "w:wp-video" }
                ]
            },
            {
                title: "WooCommerce",
                widgets: [
                    { name: "Adicionar ao Carrinho", tag: "w:wc-add-to-cart" },
                    { name: "Grid de Produtos", tag: "w:wc-products" },
                    { name: "Categorias de Produto", tag: "w:wc-categories" }
                ]
            }
        ];

        // Render Widget List
        const container = document.getElementById('widget-list-container');
        widgetCategories.forEach(cat => {
            const catTitle = document.createElement('div');
            catTitle.className = 'widget-category';
            catTitle.textContent = cat.title;
            container.appendChild(catTitle);

            const list = document.createElement('ul');
            list.className = 'widget-list';

            cat.widgets.forEach(widget => {
                const item = document.createElement('li');
                item.className = 'widget-item';
                item.innerHTML = `
                    <span class="widget-name">${widget.name} <span class="widget-tag">(${widget.tag})</span></span>
                    <button class="btn-rename" onclick="renameLayer('${widget.tag}')">Renomear</button>
                `;
                list.appendChild(item);
            });
            container.appendChild(list);
        });

        function renameLayer(newName) {
            parent.postMessage({ pluginMessage: { type: 'rename-layer', newName } }, '*');
        }

        // --- TABS LOGIC ---
        const tabs = document.querySelectorAll('.tab-btn');
        const contents = document.querySelectorAll('.tab-content');

        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                // Remove active class
                tabs.forEach(t => t.classList.remove('active'));
                contents.forEach(c => c.classList.remove('active'));

                // Add active class
                tab.classList.add('active');
                document.getElementById(tab.dataset.tab).classList.add('active');
            });
        });

        // --- WORDPRESS CONFIG ---
        let wpConfig = { url: '', user: '', password: '' };

        document.getElementById('saveWpConfig').onclick = () => {
            const url = document.getElementById('wpUrl').value.replace(/\/$/, ""); // Remove trailing slash
            const user = document.getElementById('wpUser').value;
            const password = document.getElementById('wpPassword').value;

            if (!url || !user || !password) {
                showStatus('wpStatus', 'Preencha todos os campos.', 'error');
                return;
            }

            wpConfig = { url, user, password };
            // Save to plugin storage via main thread
            parent.postMessage({ pluginMessage: { type: 'save-wp-config', config: wpConfig } }, '*');

            showStatus('wpStatus', 'Configuração salva!', 'success');
        };

        function showStatus(elementId, msg, type) {
            const el = document.getElementById(elementId);
            el.textContent = msg;
            el.className = 'status-msg ' + type;
            setTimeout(() => { el.style.display = 'none'; }, 3000);
        }

        // --- EXPORT LOGIC ---
        document.getElementById('exportBtn').onclick = () => {
            document.getElementById('jsonOutput').value = 'Processando...';
            parent.postMessage({ pluginMessage: { type: 'export-elementor' } }, '*');
        };

        document.getElementById('copyBtn').onclick = () => {
            const textarea = document.getElementById('jsonOutput');
            textarea.select();
            document.execCommand('copy');
            document.getElementById('copyBtn').textContent = 'Copiado!';
            setTimeout(() => document.getElementById('copyBtn').textContent = 'Copiar JSON', 2000);
        };

        // --- MESSAGE HANDLING ---
        window.onmessage = async (event) => {
            const msg = event.data.pluginMessage;
            if (!msg) return;

            if (msg.type === 'export-result') {
                document.getElementById('jsonOutput').value = msg.data;
                // Auto copy
                document.getElementById('jsonOutput').select();
                document.execCommand('copy');
                showStatus('exportStatus', 'JSON gerado e copiado!', 'success');
            }
            else if (msg.type === 'load-wp-config') {
                if (msg.config) {
                    wpConfig = msg.config;
                    document.getElementById('wpUrl').value = wpConfig.url || '';
                    document.getElementById('wpUser').value = wpConfig.user || '';
                    document.getElementById('wpPassword').value = wpConfig.password || '';
                }
            }
            else if (msg.type === 'upload-image-request') {
                // Handle Image Upload
                const { id, name, mimeType, data } = msg;

                if (!wpConfig.url || !wpConfig.password) {
                    parent.postMessage({
                        pluginMessage: {
                            type: 'upload-image-response',
                            id,
                            success: false,
                            error: 'WP não configurado'
                        }
                    }, '*');
                    return;
                }

                try {
                    let blob;
                    if (typeof data === 'string') {
                        const byteCharacters = atob(data);
                        const byteNumbers = new Array(byteCharacters.length);
                        for (let i = 0; i < byteCharacters.length; i++) {
                            byteNumbers[i] = byteCharacters.charCodeAt(i);
                        }
                        const byteArray = new Uint8Array(byteNumbers);
                        blob = new Blob([byteArray], { type: mimeType });
                    } else {
                        blob = new Blob([data], { type: mimeType });
                    }

                    const formData = new FormData();
                    formData.append('file', blob, name);
                    formData.append('title', name.split('.')[0]);
                    formData.append('caption', 'Exported from Figma');

                    const response = await fetch(`${wpConfig.url}/wp-json/wp/v2/media`, {
                        method: 'POST',
                        headers: {
                            'Authorization': 'Basic ' + btoa(`${wpConfig.user}:${wpConfig.password}`)
                        },
                        body: formData
                    });

                    if (!response.ok) {
                        const errText = await response.text();
                        throw new Error(`HTTP ${response.status}: ${errText}`);
                    }

                    const json = await response.json();

                    parent.postMessage({
                        pluginMessage: {
                            type: 'upload-image-response',
                            id,
                            success: true,
                            url: json.source_url,
                            mediaId: json.id
                        }
                    }, '*');

                } catch (error) {
                    console.error("Upload failed:", error);
                    parent.postMessage({
                        pluginMessage: {
                            type: 'upload-image-response',
                            id,
                            success: false,
                            error: error.message
                        }
                    }, '*');
                }
            }
        };

        // --- RESIZE LOGIC ---
        const handle = document.getElementById('resize-handle');
        let isResizing = false;
        let animationFrameId = null;

        handle.addEventListener('mousedown', (e) => {
            isResizing = true;
            e.preventDefault();
            document.body.style.cursor = 'nwse-resize';
        });

        window.addEventListener('mousemove', (e) => {
            if (!isResizing) return;
            if (animationFrameId) cancelAnimationFrame(animationFrameId);
            animationFrameId = requestAnimationFrame(() => {
                const newWidth = Math.max(300, e.clientX + 5);
                const newHeight = Math.max(400, e.clientY + 5);
                parent.postMessage({
                    pluginMessage: {
                        type: 'resize-window',
                        width: Math.round(newWidth),
                        height: Math.round(newHeight)
                    }
                }, '*');
            });
        });

        window.addEventListener('mouseup', () => {
            isResizing = false;
            document.body.style.cursor = 'default';
            if (animationFrameId) cancelAnimationFrame(animationFrameId);
        });

    </script>
</body>

</html>