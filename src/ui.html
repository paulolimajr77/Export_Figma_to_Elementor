<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Figma to Elementor</title>
    <style>
        :root {
            --primary: #0d99ff;
            --bg: #ffffff;
            --text: #333333;
            --border: #e6e6e6;
            --hover: #f5f5f5;
            --input-bg: #ffffff;
            --code-bg: #f0f0f0;
            --log-bg: #fff0f0;
            /* Levemente avermelhado para diferenciar logs se quiser, ou neutro */
            --section-header: #fafafa;
            --tree-line: #ddd;
        }

        /* Dark Mode Support */
        @media (prefers-color-scheme: dark) {
            :root {
                --bg: #2c2c2c;
                --text: #f0f0f0;
                --border: #444444;
                --hover: #3a3a3a;
                --input-bg: #3a3a3a;
                --code-bg: #1e1e1e;
                --log-bg: #252525;
                --section-header: #333;
                --tree-line: #555;
            }
        }

        body {
            font-family: 'Inter', sans-serif;
            font-size: 12px;
            margin: 0;
            padding: 0;
            background-color: var(--bg);
            color: var(--text);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
            background: var(--bg);
            flex-shrink: 0;
        }

        .tab-btn {
            flex: 1;
            padding: 12px;
            border: none;
            background: none;
            color: var(--text);
            font-weight: 600;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            opacity: 0.6;
            transition: all 0.2s;
        }

        .tab-btn.active {
            border-bottom-color: var(--primary);
            color: var(--primary);
            opacity: 1;
        }

        .tab-btn:hover {
            background-color: var(--hover);
        }

        /* Content Areas */
        .content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: none;
        }

        .content.active {
            display: block;
        }

        /* Forms & Inputs */
        .form-group {
            margin-bottom: 16px;
        }

        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            opacity: 0.8;
        }

        input[type="text"],
        input[type="password"],
        input[type="number"],
        textarea,
        select {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: 4px;
            background-color: var(--input-bg);
            color: var(--text);
            box-sizing: border-box;
            font-family: inherit;
        }

        input:focus,
        textarea:focus {
            outline: 2px solid var(--primary);
            border-color: transparent;
        }

        /* Buttons */
        .btn {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            filter: brightness(1.1);
        }

        .btn-secondary {
            background-color: transparent;
            border: 1px solid var(--border);
            color: var(--text);
        }

        .btn-secondary:hover {
            background-color: var(--hover);
        }

        .btn-small {
            padding: 4px 8px;
            font-size: 11px;
            width: auto;
        }

        /* Output Area */
        #output-area {
            height: 120px;
            /* Reduzido levemente para caber o log */
            font-family: monospace;
            font-size: 11px;
            white-space: pre;
            background-color: var(--code-bg);
            resize: vertical;
            margin-bottom: 12px;
        }

        /* Log Area (NOVO) */
        #log-area {
            height: 100px;
            font-family: 'Courier New', monospace;
            font-size: 10px;
            background-color: var(--code-bg);
            /* ou var(--log-bg) */
            color: var(--text);
            border: 1px solid var(--border);
            resize: vertical;
            padding: 8px;
            line-height: 1.3;
        }

        /* Help/Widgets Section & Tree View */
        .search-bar {
            position: sticky;
            top: 0;
            background: var(--bg);
            padding-bottom: 10px;
            z-index: 10;
        }

        .info-box {
            background-color: rgba(13, 153, 255, 0.1);
            border-left: 3px solid var(--primary);
            padding: 10px;
            margin-bottom: 15px;
            font-size: 11px;
            line-height: 1.4;
        }

        /* Tree Structure Styles */
        .category-block {
            margin-bottom: 20px;
        }

        .category-title {
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--primary);
            margin-bottom: 10px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 5px;
        }

        .tree-root {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .tree-item {
            display: flex;
            align-items: center;
            padding: 4px 0;
        }

        .widget-btn {
            background-color: var(--hover);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 11px;
            cursor: pointer;
            user-select: none;
            display: flex;
            align-items: center;
            transition: all 0.1s;
            text-align: left;
        }

        .widget-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
            background-color: #f0f7ff;
        }

        .widget-btn span.prefix {
            opacity: 0.5;
            margin-right: 4px;
            font-size: 10px;
            font-family: monospace;
        }

        /* Hierarchical Lines */
        .tree-children {
            margin-left: 20px;
            padding-left: 10px;
            border-left: 1px dashed var(--tree-line);
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin-top: 4px;
            margin-bottom: 8px;
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            color: white;
            z-index: 100;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin-bottom: 10px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>

    <!-- Tabs -->
    <div class="tabs">
        <button class="tab-btn active" onclick="openTab('export')">Gerar JSON</button>
        <button class="tab-btn" onclick="openTab('wp')">WordPress</button>
        <button class="tab-btn" onclick="openTab('help')">Ajuda & Widgets</button>
    </div>

    <!-- Tab: Export -->
    <div id="tab-export" class="content active">
        <div class="info-box">
            Selecione Frames ou Grupos no Figma e clique em "Gerar JSON" para criar o código compatível com Elementor.
        </div>

        <div class="form-group">
            <label>Qualidade de Imagem (JPEG/WEBP)</label>
            <div style="display:flex; gap:10px; align-items:center;">
                <input type="range" id="quality" min="0.1" max="1.0" step="0.05" value="0.85" style="flex:1">
                <span id="quality-val">85%</span>
            </div>
        </div>

        <button id="btn-export" class="btn btn-primary" style="margin-bottom: 12px;">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
            Gerar JSON Elementor
        </button>

        <div style="display:flex; gap: 8px; margin-bottom: 12px;">
            <button id="btn-debug" class="btn btn-secondary btn-small">Debug Estrutura</button>
            <button id="btn-copy" class="btn btn-secondary btn-small" disabled>Copiar JSON</button>
        </div>

        <label>Saída JSON:</label>
        <textarea id="output-area" readonly placeholder="O JSON aparecerá aqui..."></textarea>

        <!-- NOVA ÁREA DE LOGS -->
        <label>Logs & Erros:</label>
        <textarea id="log-area" readonly
            placeholder="Logs de processamento, erros de upload e respostas do servidor aparecerão aqui..."></textarea>
    </div>

    <!-- Tab: WordPress -->
    <div id="tab-wp" class="content">
        <div class="info-box">
            Configure para que o plugin faça upload automático de imagens para sua biblioteca.
            Use "Application Passwords" no seu perfil de usuário WP.
        </div>

        <div class="form-group">
            <label>URL do Site (com https://)</label>
            <input type="text" id="wp-url" placeholder="https://meusite.com">
        </div>

        <div class="form-group">
            <label>Usuário (Login/Email)</label>
            <input type="text" id="wp-user" placeholder="admin">
        </div>

        <div class="form-group">
            <label>Senha de Aplicativo</label>
            <input type="password" id="wp-pass" placeholder="xxxx xxxx xxxx xxxx">
            <small style="opacity: 0.7; display:block; margin-top:4px;">Não use sua senha normal. Gere uma Application
                Password no painel do WP.</small>
        </div>

        <button id="btn-save-wp" class="btn btn-primary">Salvar Configuração</button>
    </div>

    <!-- Tab: Help & Widgets -->
    <div id="tab-help" class="content">
        <div class="search-bar">
            <input type="text" id="search-widgets" placeholder="Buscar widget (ex: produto, loop)...">
        </div>

        <div class="info-box">
            Clique em um item para renomear a layer selecionada. A indentação sugere a hierarquia correta no Figma (Pai
            > Filho).
        </div>

        <div id="widgets-container">
            <!-- Widgets injected here -->
        </div>
    </div>

    <div class="loading-overlay" id="loader">
        <div class="spinner"></div>
        <div id="loader-text">Processando...</div>
    </div>

    <script>
        // --- DADOS HIERÁRQUICOS ---
        const widgetTreeData = [
            {
                category: "Estrutura & Layout",
                items: [
                    {
                        name: "container", prefix: "c:",
                        children: [
                            { name: "inner-container", prefix: "c:" }
                        ]
                    },
                    { name: "divider", prefix: "w:" },
                    { name: "spacer", prefix: "w:" },
                    { name: "menu-anchor", prefix: "w:" },
                    { name: "sidebar", prefix: "w:" }
                ]
            },
            {
                category: "Conteúdo Básico",
                items: [
                    { name: "heading", prefix: "w:" },
                    { name: "text-editor", prefix: "w:" },
                    { name: "image", prefix: "w:" },
                    { name: "video", prefix: "w:" },
                    { name: "button", prefix: "w:" },
                    { name: "icon", prefix: "w:" },
                    { name: "read-more", prefix: "w:" }
                ]
            },
            {
                category: "Loop Builder & Grids",
                items: [
                    {
                        name: "loop-grid", prefix: "loop:",
                        children: [
                            {
                                name: "loop-item", prefix: "loop:",
                                children: [
                                    { name: "loop-title", prefix: "loop:" },
                                    { name: "loop-image", prefix: "loop:" },
                                    { name: "loop-content", prefix: "loop:" }, // Alias common
                                    { name: "loop-price", prefix: "loop:" },
                                    { name: "loop-add-to-cart", prefix: "loop:" },
                                    { name: "loop-rating", prefix: "loop:" },
                                    { name: "loop-meta", prefix: "loop:" },
                                    { name: "loop-terms", prefix: "loop:" },
                                    { name: "loop-read-more", prefix: "loop:" },
                                    { name: "loop-featured-image", prefix: "loop:" }
                                ]
                            }
                        ]
                    },
                    { name: "loop-carousel", prefix: "loop:" },
                    { name: "loop-grid-advanced", prefix: "pro:" }
                ]
            },
            {
                category: "WooCommerce (Produto Único)",
                items: [
                    {
                        name: "products", prefix: "woo:", label: "Products Archive (Grid)",
                    },
                    {
                        name: "Product Page Layout", prefix: "", isLabel: true,
                        children: [
                            { name: "product-title", prefix: "woo:" },
                            { name: "product-image", prefix: "woo:" },
                            { name: "product-price", prefix: "woo:" },
                            { name: "product-add-to-cart", prefix: "woo:" },
                            { name: "product-short-description", prefix: "woo:" },
                            { name: "product-meta", prefix: "woo:" },
                            { name: "product-rating", prefix: "woo:" },
                            { name: "product-stock", prefix: "woo:" },
                            { name: "product-tabs", prefix: "woo:" },
                            { name: "product-related", prefix: "woo:" },
                            { name: "product-upsells", prefix: "woo:" }
                        ]
                    },
                    { name: "cart", prefix: "woo:" },
                    { name: "checkout", prefix: "woo:" },
                    { name: "my-account", prefix: "woo:" }
                ]
            },
            {
                category: "Cards & Boxes",
                items: [
                    { name: "icon-box", prefix: "w:" },
                    { name: "image-box", prefix: "w:" },
                    { name: "flip-box", prefix: "pro:" },
                    { name: "call-to-action", prefix: "pro:" },
                    { name: "author-box", prefix: "pro:" },
                    { name: "review-box", prefix: "pro:" },
                    { name: "alert", prefix: "w:" }
                ]
            },
            {
                category: "Carrosséis & Sliders",
                items: [
                    { name: "image-carousel", prefix: "w:" },
                    { name: "media-carousel", prefix: "pro:" },
                    { name: "testimonial-carousel", prefix: "pro:" },
                    {
                        name: "slides", prefix: "slider:",
                        label: "Slides (Slider)",
                        children: [
                            { name: "Slide Item (Auto)", prefix: "", isLabel: true }
                        ]
                    }
                ]
            },
            {
                category: "Blog & Post Single",
                items: [
                    { name: "post-title", prefix: "pro:" },
                    { name: "post-excerpt", prefix: "pro:" },
                    { name: "post-content", prefix: "pro:" },
                    { name: "post-featured-image", prefix: "pro:" },
                    { name: "post-info", prefix: "pro:" },
                    { name: "post-navigation", prefix: "pro:" },
                    { name: "share-buttons", prefix: "pro:" },
                    { name: "author-box", prefix: "pro:" }
                ]
            },
            {
                category: "Site & Header",
                items: [
                    { name: "site-logo", prefix: "pro:" },
                    { name: "site-title", prefix: "pro:" },
                    { name: "nav-menu", prefix: "w:" },
                    { name: "search-form", prefix: "w:" },
                    { name: "sitemap", prefix: "pro:" },
                    { name: "breadcrumb", prefix: "pro:" }
                ]
            },
            {
                category: "Outros & Avançado",
                items: [
                    { name: "form", prefix: "pro:" },
                    { name: "login", prefix: "pro:" },
                    { name: "gallery", prefix: "w:" },
                    { name: "lottie", prefix: "w:" },
                    { name: "html", prefix: "w:" },
                    { name: "shortcode", prefix: "w:" },
                    { name: "google-maps", prefix: "w:" },
                    { name: "progress", prefix: "w:" },
                    { name: "counter", prefix: "w:" },
                    { name: "accordion", prefix: "w:" },
                    { name: "tabs", prefix: "w:" },
                    { name: "toggle", prefix: "w:" }
                ]
            }
        ];

        // --- UI LOGIC ---

        function openTab(tabName) {
            document.querySelectorAll('.content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));

            document.getElementById(`tab-${tabName}`).classList.add('active');

            const btns = document.querySelectorAll('.tab-btn');
            if (tabName === 'export') btns[0].classList.add('active');
            if (tabName === 'wp') btns[1].classList.add('active');
            if (tabName === 'help') btns[2].classList.add('active');
        }

        // --- LOGGING HELPER ---
        function addLog(message, type = 'info') {
            const logArea = document.getElementById('log-area');
            const now = new Date();
            const time = now.toLocaleTimeString();
            let prefix = '[INFO]';
            if (type === 'error') prefix = '[ERRO]';
            if (type === 'success') prefix = '[SUCESSO]';

            const logLine = `[${time}] ${prefix} ${message}\n`;
            logArea.value += logLine;
            // Auto scroll to bottom
            logArea.scrollTop = logArea.scrollHeight;
        }

        // Função Recursiva para renderizar a árvore
        function renderTreeItem(item, container) {
            const el = document.createElement('div');

            if (item.isLabel) {
                el.className = 'tree-item';
                el.innerHTML = `<span style="font-size:11px; color:#888; font-style:italic;">${item.name || item.label}</span>`;
            } else {
                const btn = document.createElement('div');
                btn.className = 'widget-btn';
                btn.innerHTML = `<span class="prefix">${item.prefix}</span>${item.label || item.name}`;
                btn.onclick = (e) => {
                    e.stopPropagation();
                    renameLayer(`${item.prefix}${item.name}`);
                };
                el.className = 'tree-item';
                el.appendChild(btn);
            }

            container.appendChild(el);

            if (item.children && item.children.length > 0) {
                const childContainer = document.createElement('div');
                childContainer.className = 'tree-children';
                item.children.forEach(child => renderTreeItem(child, childContainer));
                container.appendChild(childContainer);
            }
        }

        function renderWidgets(filterText = '') {
            const container = document.getElementById('widgets-container');
            container.innerHTML = '';

            filterText = filterText.toLowerCase();

            // Modo Busca (Lista Plana)
            if (filterText.length > 0) {
                const results = [];
                // Flatten search
                const searchRecursive = (items) => {
                    items.forEach(item => {
                        if ((item.name && item.name.toLowerCase().includes(filterText)) ||
                            (item.label && item.label.toLowerCase().includes(filterText))) {
                            if (!item.isLabel) results.push(item);
                        }
                        if (item.children) searchRecursive(item.children);
                    });
                };

                widgetTreeData.forEach(cat => searchRecursive(cat.items));

                if (results.length > 0) {
                    const grid = document.createElement('div');
                    grid.style.display = 'flex';
                    grid.style.flexWrap = 'wrap';
                    grid.style.gap = '6px';

                    results.forEach(item => {
                        const btn = document.createElement('div');
                        btn.className = 'widget-btn';
                        btn.innerHTML = `<span class="prefix">${item.prefix}</span>${item.name}`;
                        btn.onclick = () => renameLayer(`${item.prefix}${item.name}`);
                        grid.appendChild(btn);
                    });
                    container.appendChild(grid);
                } else {
                    container.innerHTML = '<div style="color:#888; text-align:center; padding:20px;">Nenhum widget encontrado.</div>';
                }
            }
            // Modo Hierárquico (Árvore)
            else {
                widgetTreeData.forEach(cat => {
                    const block = document.createElement('div');
                    block.className = 'category-block';

                    const title = document.createElement('div');
                    title.className = 'category-title';
                    title.textContent = cat.category;
                    block.appendChild(title);

                    const root = document.createElement('div');
                    root.className = 'tree-root';

                    cat.items.forEach(item => renderTreeItem(item, root));

                    block.appendChild(root);
                    container.appendChild(block);
                });
            }
        }

        function renameLayer(newName) {
            addLog(`Solicitando renomeação para: ${newName}`);
            parent.postMessage({
                pluginMessage: {
                    type: 'rename-layer',
                    newName: newName
                }
            }, '*');
        }

        // --- EVENT LISTENERS ---

        document.getElementById('search-widgets').addEventListener('input', (e) => {
            renderWidgets(e.target.value);
        });

        document.getElementById('quality').addEventListener('input', (e) => {
            document.getElementById('quality-val').textContent = Math.round(e.target.value * 100) + '%';
        });

        document.getElementById('btn-export').onclick = () => {
            const quality = parseFloat(document.getElementById('quality').value);
            document.getElementById('output-area').value = '';
            document.getElementById('btn-copy').disabled = true;

            addLog("Iniciando processo de exportação...");
            parent.postMessage({ pluginMessage: { type: 'export-elementor', quality } }, '*');
        };

        document.getElementById('btn-debug').onclick = () => {
            addLog("Solicitando debug de estrutura...");
            parent.postMessage({ pluginMessage: { type: 'debug-structure' } }, '*');
        };

        document.getElementById('btn-copy').onclick = () => {
            const el = document.getElementById('output-area');
            el.select();
            document.execCommand('copy');
            const btn = document.getElementById('btn-copy');
            const originalText = btn.textContent;
            btn.textContent = 'Copiado!';
            setTimeout(() => btn.textContent = originalText, 2000);
            addLog("JSON copiado para área de transferência.", 'success');
        };

        document.getElementById('btn-save-wp').onclick = () => {
            const url = document.getElementById('wp-url').value.replace(/\/$/, "");
            const user = document.getElementById('wp-user').value;
            const pass = document.getElementById('wp-pass').value;

            if (!url || !user || !pass) {
                alert('Preencha todos os campos.');
                return;
            }

            parent.postMessage({
                pluginMessage: {
                    type: 'save-wp-config',
                    config: { url, user, password: pass }
                }
            }, '*');
            addLog("Configurações WP salvas localmente.", 'success');
        };

        // --- MESSAGING FROM CODE.TS ---

        window.onmessage = async (event) => {
            const msg = event.data.pluginMessage;
            if (!msg) return;

            if (msg.type === 'export-result') {
                document.getElementById('output-area').value = msg.data;
                document.getElementById('btn-copy').disabled = false;
                addLog("JSON gerado com sucesso!", 'success');
            }

            else if (msg.type === 'debug-result') {
                document.getElementById('output-area').value = msg.data;
                addLog("Debug recebido.");
            }

            else if (msg.type === 'load-wp-config') {
                if (msg.config) {
                    document.getElementById('wp-url').value = msg.config.url || '';
                    document.getElementById('wp-user').value = msg.config.user || '';
                    document.getElementById('wp-pass').value = msg.config.password || '';
                    addLog("Configurações WP carregadas.");
                }
            }

            else if (msg.type === 'upload-image-request') {
                showLoader(true, `Enviando ${msg.name}...`);
                addLog(`Iniciando upload: ${msg.name} (${msg.targetMimeType || msg.mimeType})`);

                try {
                    const wpUrl = document.getElementById('wp-url').value.replace(/\/$/, "");
                    const wpUser = document.getElementById('wp-user').value;
                    const wpPass = document.getElementById('wp-pass').value;

                    if (!wpUrl || !wpUser || !wpPass) {
                        throw new Error("Credenciais WP ausentes. Configure na aba WordPress.");
                    }

                    // Conversão para WebP se solicitado (Sandbox do Figma envia PNG e pede WebP)
                    let blobToUpload;

                    if (msg.needsConversion && msg.targetMimeType === 'image/webp') {
                        addLog(`Convertendo ${msg.name} para WebP...`);

                        // Criar Blob do PNG original
                        const pngBlob = new Blob([msg.data], { type: msg.mimeType });
                        const bitmap = await createImageBitmap(pngBlob);

                        // Desenhar em Canvas para converter
                        const canvas = document.createElement('canvas');
                        canvas.width = bitmap.width;
                        canvas.height = bitmap.height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(bitmap, 0, 0);

                        // Exportar como WebP
                        blobToUpload = await new Promise(resolve => canvas.toBlob(resolve, 'image/webp', 0.85));
                        addLog(`Conversão concluída.`);
                    } else {
                        blobToUpload = new Blob([msg.data], { type: msg.mimeType });
                    }

                    const formData = new FormData();
                    // Forçar extensão .webp no nome se foi convertido
                    const fileName = msg.needsConversion ? msg.name.replace(/\.(png|jpg|jpeg)$/i, '.webp') : msg.name;

                    formData.append('file', blobToUpload, fileName);
                    formData.append('title', fileName.split('.')[0]);

                    const response = await fetch(`${wpUrl}/wp-json/wp/v2/media`, {
                        method: 'POST',
                        headers: {
                            'Authorization': 'Basic ' + btoa(wpUser + ":" + wpPass)
                        },
                        body: formData
                    });

                    if (!response.ok) {
                        const err = await response.json();
                        throw new Error(err.message || 'Upload falhou no servidor');
                    }

                    const json = await response.json();
                    addLog(`Upload sucesso: ${json.source_url}`, 'success');

                    parent.postMessage({
                        pluginMessage: {
                            type: 'upload-image-response',
                            id: msg.id,
                            success: true,
                            url: json.source_url
                        }
                    }, '*');

                } catch (e) {
                    console.error("Upload Error:", e);
                    addLog(`Erro no upload de ${msg.name}: ${e.message}`, 'error');

                    parent.postMessage({
                        pluginMessage: {
                            type: 'upload-image-response',
                            id: msg.id,
                            success: false,
                            error: e.message
                        }
                    }, '*');
                } finally {
                    showLoader(false);
                }
            }
        };

        let activeUploads = 0;
        function showLoader(show, text) {
            const loader = document.getElementById('loader');
            const txt = document.getElementById('loader-text');
            if (show) {
                activeUploads++;
                loader.style.display = 'flex';
                if (text) txt.textContent = text;
            } else {
                activeUploads--;
                if (activeUploads <= 0) {
                    loader.style.display = 'none';
                    activeUploads = 0;
                }
            }
        }

        // Init
        renderWidgets();
    </script>
</body>

</html>