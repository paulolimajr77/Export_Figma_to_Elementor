<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Figma to WP Elementor</title>
  <style>
    /* tokens */
    :root {
      --font: "Inter", sans-serif;
      --space-1: 6px;
      --space-2: 12px;
      --space-3: 18px;
      --space-4: 24px;
      --radius: 10px;
      --color-bg: #f5f6fb;
      --color-panel: #ffffff;
      --color-border: #e2e5ec;
      --color-text: #111318;
      --color-text-secondary: #000000;
      --color-primary: #0c7bff;
      --color-primary-hover: #0063cc;
      --shadow-1: 0 6px 18px rgba(0, 0, 0, 0.07);
    }

    :root.dark {
      --color-bg: #1c1c1f;
      --color-panel: #2a2a2e;
      --color-border: #3a3a3e;
      --color-text: #8d8d8d;
      --color-text-secondary: #e6e6e6;
      --color-primary: #3ea6ff;
      --color-primary-hover: #1c8dd5;
      --shadow-1: 0 8px 20px rgba(0, 0, 0, 0.35);
    }

    @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap");

    :root {
      --anim: 180ms ease;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: var(--font, 'Inter'), system-ui, -apple-system, sans-serif;
      background: var(--color-bg);
      color: var(--color-text);
    }

    .app {
      width: 100%;
      /* max-width: 800px; */
      margin: 0 auto;
      min-height: 100vh;
      padding: var(--space-3);
    }

    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-2);
    }

    .brand {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .brand-title {
      font-weight: 700;
      font-size: 19px;
      color: var(--color-text);
    }

    .brand-subtitle {
      font-size: 13px;
      color: var(--color-text-secondary);
    }

    .top-actions {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .btn {
      border: 1px solid var(--color-border);
      border-radius: var(--radius);
      padding: 10px 14px;
      font-weight: 700;
      cursor: pointer;
      transition: transform var(--anim), box-shadow var(--anim), background var(--anim);
      font-size: 0.7em !important;
      text-wrap: nowrap;
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-1);
    }

    .btn.primary {
      background: #0c7bff;
      border-color: #0c7bff;
      color: #fff;
    }

    .btn.secondary {
      background: #eef1f6;
      color: #1d1f25;
    }

    .btn.ghost {
      background: var(--color-panel);
      color: var(--color-text-secondary);
      border-color: var(--color-border);
    }

    .btn.small {
      padding: 6px 10px;
      font-size: 12px;
    }

    .btn.tiny {
      padding: 6px 10px;
      font-size: 12px;
    }

    .btn:disabled {
      opacity: 0.45;
      cursor: not-allowed;
      box-shadow: none;
      transform: none;
    }

    .switch {
      position: relative;
      display: inline-block;
      width: 56px;
      height: 30px;
    }

    .switch input {
      display: none;
    }

    .slider {
      position: absolute;
      inset: 0;
      cursor: pointer;
      background: var(--color-border);
      border-radius: 999px;
      transition: var(--anim);
    }

    .slider:before {
      content: "";
      position: absolute;
      left: 4px;
      top: 4px;
      width: 22px;
      height: 22px;
      background: var(--color-panel);
      border-radius: 50%;
      box-shadow: var(--shadow-1);
      transition: var(--anim);
      z-index: 2;
    }

    .slider .sun,
    .slider .moon {
      position: absolute;
      font-size: 13px;
      top: 7px;
      transition: var(--anim);
    }

    .slider .sun {
      left: 10px;
      opacity: 1;
    }

    .slider .moon {
      right: 10px;
      opacity: 0;
    }

    input:checked+.slider {
      background: var(--color-primary);
    }

    input:checked+.slider:before {
      transform: translateX(26px);
    }

    input:checked+.slider .sun {
      opacity: 0;
      transform: translateX(-6px);
    }

    input:checked+.slider .moon {
      opacity: 1;
      transform: translateX(6px);
    }

    .tabs {
      display: flex;
      gap: 0;
      background: var(--color-panel);
      border: 1px solid var(--color-border);
      border-radius: var(--radius);
      position: relative;
      overflow: hidden;
    }

    .tab-btn {
      flex: 1;
      padding: var(--space-2);
      border: none;
      background: transparent;
      font-weight: 400;
      color: var(--color-text-secondary);
      cursor: pointer;
      position: relative;
      transition: color var(--anim), background var(--anim);
      font-size: 0.75em !important;
      text-wrap: nowrap;
    }

    .tab-btn.active {
      color: var(--color-primary);
    }

    .tab-btn:hover {
      background: rgba(0, 0, 0, 0.02);
    }

    .tab-indicator {
      position: absolute;
      bottom: 0;
      left: 0;
      height: 3px;
      width: 25%;
      background: var(--color-primary);
      transition: transform var(--anim), width var(--anim);
    }

    .tab-panels {
      margin-top: var(--space-2);
    }

    .tab-panel {
      display: none;
      animation: fadeIn var(--anim);
    }

    .tab-panel.active {
      display: block;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(4px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .row {
      display: flex;
      gap: 16px;
      margin-bottom: 12px;
    }

    .card {
      background: var(--color-panel);
      border: 1px solid var(--color-border);
      border-radius: var(--radius);
      padding: var(--space-3);
      margin-bottom: var(--space-3);
      box-shadow: var(--shadow-1);
    }

    .card-title {
      font-weight: 900;
      margin-bottom: var(--space-2);
      color: var(--color-text);
      font-size: 0.75em !important;
    }

    .actions {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: var(--space-2);
    }

    select {
      padding: 6px 12px;
      border: 1px solid var(--color-border);
      border-radius: var(--radius);
      font-size: 14px;
      background: #fff;
      color: var(--color-text);
    }

    .input-label {
      display: block;
      margin: var(--space-2) 0 var(--space-1);
      font-weight: 600;
      color: var(--color-text-secondary);
    }

    input[type="text"],
    input[type="password"] {
      width: 100%;
      padding: 6px 12px;
      border: 1px solid var(--color-border);
      border-radius: var(--radius);
      font-size: 14px;
      background: #fff;
      color: var(--color-text);
    }

    .checkbox {
      display: flex;
      gap: 8px;
      align-items: center;
      margin: 6px 0;
      color: var(--color-text-secondary);
    }

    #output {
      width: 100%;
      min-height: 160px;
      border: 1px solid var(--color-border);
      border-radius: var(--radius);
      padding: 12px;
      font-family: "SFMono-Regular", Consolas, monospace;
      background: #f5f6f8;
      resize: vertical;
      color: var(--color-text);
    }

    .logs {
      margin-top: 10px;
      min-height: 80px;
      border: 1px solid var(--color-border);
      border-radius: var(--radius);
      padding: 10px;
      background: var(--color-panel);
      font-size: 12px;
      color: var(--color-text);
      overflow-y: auto;
    }

    .status {
      margin-top: 10px;
      font-size: 13px;
      color: var(--color-text-secondary);
    }

    .provider-block {
      display: none;
    }

    body[data-provider="gemini"] .provider-gemini,
    body[data-provider="gpt"] .provider-gpt {
      display: block;
    }

    .ai-hidden {
      display: none !important;
    }

    .help-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: var(--space-2);
    }

    .help-item {
      padding: var(--space-2);
      border: 1px solid var(--color-border);
      border-radius: var(--radius);
      background: #f9fafb;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .help-item .label {
      font-weight: 600;
      color: var(--color-text);
    }

    .muted {
      color: var(--color-text-secondary);
      font-size: 12px;
      margin-top: var(--space-2);
    }

    body.dark {
      background: var(--color-bg);
      color: var(--color-text);
    }

    body.dark .tabs {
      border-color: var(--color-border);
      background: var(--color-panel);
    }

    body.dark .tab-btn {
      color: var(--color-text-secondary);
    }

    body.dark .tab-btn.active {
      color: var(--color-primary);
    }

    body.dark .card {
      background: var(--color-panel);
      border-color: var(--color-border);
    }

    body.dark .btn.secondary {
      background: #3a3a3e;
      color: #f5f5f5;
    }

    body.dark .btn.ghost {
      background: #2a2a2e;
      color: #f5f5f5;
    }

    body.dark input[type="text"],
    body.dark input[type="password"] {
      background: #1f1f22;
      border-color: var(--color-border);
      color: #eee;
    }

    body.dark #output {
      background: #242424;
      color: #eee;
      border-color: var(--color-border);
    }

    body.dark .logs {
      background: #242424;
      color: #bbb;
      border-color: var(--color-border);
    }

    body.dark .help-item {
      background: #2f2f2f;
      border-color: var(--color-border);
    }

    body.dark .help-item .label {
      color: #f5f5f5;
    }

    /* Estilos para Grid Compacto e Busca */
    .help-grid.compact {
      grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
      gap: 8px;
    }

    .help-item.compact {
      flex-direction: column;
      align-items: flex-start;
      padding: 8px;
      gap: 8px;
    }

    .help-item.compact .item-header {
      display: flex;
      align-items: center;
      gap: 6px;
      width: 100%;
      margin-bottom: 2px;
    }

    .help-item.compact .item-icon {
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--color-primary);
      opacity: 0.8;
    }

    .help-item.compact .label {
      font-size: 11px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      flex: 1;
    }

    .help-item.compact .btn {
      width: 100%;
      justify-content: center;
      padding: 4px;
      font-size: 10px;
      height: 24px;
    }

    .card.compact {
      padding: 10px;
      margin-bottom: 10px;
    }

    .card-title.small {
      font-size: 12px;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      opacity: 0.8;
    }

    .search-box {
      margin-bottom: 12px;
      position: sticky;
      top: 0;
      z-index: 10;
      background: var(--color-bg);
      padding-bottom: 8px;
    }

    .search-input {
      width: 100%;
      padding: 8px 12px 8px 32px;
      border: 1px solid var(--color-border);
      border-radius: var(--radius);
      font-size: 13px;
      background: var(--color-panel);
      color: var(--color-text);
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='14' viewBox='0 0 24 24' fill='none' stroke='%23999' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='11' cy='11' r='8'%3E%3C/circle%3E%3Cline x1='21' y1='21' x2='16.65' y2='16.65'%3E%3C/line%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: 10px center;
    }

    .search-status {
      font-size: 11px;
      color: var(--color-text-secondary);
      margin-bottom: 8px;
      padding: 0 4px;
    }

    .empty-state {
      padding: 20px;
      text-align: center;
      color: var(--color-text-secondary);
      font-size: 13px;
      background: var(--color-panel);
      border-radius: var(--radius);
      border: 1px dashed var(--color-border);
    }

    body.dark .search-input {
      background-color: #2a2a2e;
      border-color: #3a3a3e;
      color: #eee;
    }

    * {
      scrollbar-width: thin;
      scrollbar-color: var(--color-border) transparent;
    }

    *::-webkit-scrollbar {
      width: 8px;
    }

    *::-webkit-scrollbar-track {
      background: transparent;
    }

    *::-webkit-scrollbar-thumb {
      background: var(--color-border);
      border-radius: 4px;
    }

    /* Resizer handle */
    #resizer-handle {
      position: fixed;
      width: 26px;
      height: 26px;
      right: 0px;
      bottom: 0px;
      cursor: se-resize;
      opacity: 1;
      /* background: var(--color-panel); */
      /* border: 1px solid var(--color-border); */
      /* border-radius: 10px; */
      /* transition: opacity var(--anim), background var(--anim), transform var(--anim); */
      z-index: 9999;
      /* box-shadow: var(--shadow-1); */
      pointer-events: auto;
      background-image: url("data:image/svg+xml;utf8,<svg viewBox='0 0 18 18' xmlns='http://www.w3.org/2000/svg' fill='%23f5a905' stroke='%23f5a905'><path fill='%23000000' d='M14.228 16.227a1 1 0 0 1-.707-1.707l1-1a1 1 0 0 1 1.416 1.414l-1 1a1 1 0 0 1-.707.293zm-5.638 0a1 1 0 0 1-.707-1.707l6.638-6.638a1 1 0 0 1 1.416 1.414l-6.638 6.638a1 1 0 0 1-.707.293zm-5.84 0a1 1 0 0 1-.707-1.707L14.52 2.043a1 1 0 1 1 1.415 1.414L3.457 15.934a1 1 0 0 1-.707.293z'></path></svg>");
      background-repeat: no-repeat;
      background-position: center;
      /* background-size: 16px; */
    }

    #resizer-handle:hover {
      opacity: 0.65;
      transform: scale(1.05);
    }

    body.dark #resizer-handle {
      background: #1f1f22;
      opacity: 0.42;
    }

    .progress {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .progress.hidden {
      display: none;
    }

    .progress-bar {
      width: 120px;
      height: 8px;
      border-radius: 999px;
      background: var(--color-border);
      position: relative;
      overflow: hidden;
    }

    .progress-bar::after {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(90deg, var(--color-primary) 0%, #5fb5ff 100%);
      width: 60%;
      animation: slide 1s infinite;
    }

    .progress-text {
      font-size: 12px;
      color: var(--color-text-secondary);
    }

    @keyframes slide {
      0% {
        transform: translateX(-100%);
      }

      50% {
        transform: translateX(0%);
      }

      100% {
        transform: translateX(100%);
      }
    }

    /* Linter Styles */
    #linter-panel {
      margin-top: 16px;
      border-top: 1px solid var(--color-border);
      padding-top: 16px;
    }

    .linter-summary {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
      padding: 12px;
      background: var(--color-bg);
      border-radius: var(--radius);
      align-items: center;
    }

    .linter-score {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: #fff;
      border: 3px solid var(--color-border);
      font-weight: 700;
    }

    .linter-score.success {
      border-color: #2ecc71;
      color: #2ecc71;
    }

    .linter-score.warning {
      border-color: #f1c40f;
      color: #f39c12;
    }

    .linter-score.error {
      border-color: #e74c3c;
      color: #e74c3c;
    }

    .score-value {
      font-size: 18px;
      line-height: 1;
    }

    .score-label {
      font-size: 9px;
      text-transform: uppercase;
      color: var(--color-text-secondary);
      margin-top: 2px;
    }

    .linter-stats {
      flex: 1;
      display: flex;
      gap: 12px;
    }

    .stat-item {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 8px;
      background: #fff;
      border-radius: 6px;
      border: 1px solid var(--color-border);
    }

    .stat-item .count {
      font-weight: 700;
      font-size: 16px;
    }

    .stat-item .label {
      font-size: 10px;
      color: var(--color-text-secondary);
    }

    .stat-item.error .count {
      color: #e74c3c;
    }

    .stat-item.warning .count {
      color: #f39c12;
    }

    .linter-issues {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 400px;
      overflow-y: auto;
    }

    .linter-issue {
      background: #fff;
      border: 1px solid var(--color-border);
      border-radius: 6px;
      padding: 10px;
      cursor: pointer;
      transition: var(--anim);
      border-left: 3px solid transparent;
    }

    .linter-issue:hover {
      transform: translateX(2px);
      box-shadow: var(--shadow-1);
    }

    .linter-issue.error {
      border-left-color: #e74c3c;
    }

    .linter-issue.warning {
      border-left-color: #f1c40f;
    }

    .issue-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }

    .issue-severity {
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      padding: 2px 6px;
      border-radius: 4px;
    }

    .issue-severity.error {
      background: #fadbd8;
      color: #c0392b;
    }

    .issue-severity.warning {
      background: #fcf3cf;
      color: #d68910;
    }

    .issue-message {
      font-size: 12px;
      font-weight: 500;
      flex: 1;
      margin-left: 8px;
    }

    .issue-details {
      font-size: 11px;
      color: var(--color-text-secondary);
      margin-top: 6px;
      padding-top: 6px;
      border-top: 1px solid #f0f0f0;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .issue-suggestion {
      color: var(--color-primary);
      font-style: italic;
    }

    .linter-empty {
      text-align: center;
      padding: 20px;
      color: var(--color-text-secondary);
      font-style: italic;
    }

    /* Linter Report UI */
    .linter-container {
      display: flex;
      flex-direction: column;
      gap: 16px;
      padding: 4px;
    }

    .linter-header {
      display: flex;
      gap: 16px;
      align-items: center;
      background: var(--figma-color-bg-secondary);
      padding: 12px;
      border-radius: 8px;
    }

    .linter-score-card {
      flex-shrink: 0;
    }

    .score-ring {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      border: 4px solid var(--figma-color-bg-brand);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: var(--figma-color-bg);
    }

    .score-value {
      font-size: 18px;
      font-weight: bold;
      line-height: 1;
    }

    .score-label {
      font-size: 9px;
      text-transform: uppercase;
      color: var(--figma-color-text-secondary);
    }

    .linter-stats {
      display: flex;
      gap: 12px;
      flex: 1;
    }

    .stat-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 4px 8px;
      border-radius: 4px;
      flex: 1;
      background: var(--figma-color-bg);
    }

    .stat-item.critical {
      border-bottom: 2px solid #e03e1a;
    }

    .stat-item.major {
      border-bottom: 2px solid #f3c11b;
    }

    .stat-item.minor {
      border-bottom: 2px solid #2f80ed;
    }

    .stat-count {
      font-weight: bold;
      font-size: 14px;
    }

    .stat-label {
      font-size: 10px;
      color: var(--figma-color-text-secondary);
    }

    .linter-actions-bar {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }

    .linter-content {
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .issues-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .linter-issue-card {
      background: var(--figma-color-bg);
      border: 1px solid var(--figma-color-border);
      border-radius: 6px;
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      transition: all 0.2s;
    }

    .linter-issue-card:hover {
      border-color: var(--figma-color-border-brand);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .issue-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 8px;
    }

    .issue-title {
      font-weight: 600;
      font-size: 12px;
      color: var(--figma-color-text);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .issue-badge {
      font-size: 9px;
      padding: 2px 6px;
      border-radius: 4px;
      text-transform: uppercase;
      font-weight: bold;
    }

    .issue-badge.critical {
      background: #fadbd8;
      color: #c0392b;
    }

    .issue-badge.major {
      background: #fcf3cf;
      color: #d68910;
    }

    .issue-badge.minor {
      background: #d6eaf8;
      color: #2980b9;
    }

    .issue-desc {
      font-size: 11px;
      color: var(--figma-color-text-secondary);
      line-height: 1.4;
    }

    .issue-actions {
      display: flex;
      gap: 8px;
      margin-top: 4px;
    }

    .widgets-section h3 {
      font-size: 12px;
      margin-bottom: 8px;
      color: var(--figma-color-text);
    }

    .widgets-table-container {
      border: 1px solid var(--figma-color-border);
      border-radius: 6px;
      overflow: hidden;
    }

    .widgets-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
    }

    .widgets-table th {
      background: var(--figma-color-bg-secondary);
      text-align: left;
      padding: 8px;
      font-weight: 600;
      color: var(--figma-color-text-secondary);
    }

    .widgets-table td {
      padding: 8px;
      border-top: 1px solid var(--figma-color-border);
      color: var(--figma-color-text);
    }

    .widgets-table tr:hover td {
      background: var(--figma-color-bg-hover);
    }

    .linter-empty-state {
      text-align: center;
      padding: 16px;
      background: var(--figma-color-bg-secondary);
      border-radius: 8px;
    }

    .empty-icon {
      font-size: 24px;
      margin-bottom: 8px;
    }

    /* ========== PROBLEM DETAILS PANEL STYLES ========== */
    .problem-details-panel {
      background: var(--figma-color-bg-secondary);
      border: 1px solid var(--figma-color-border);
      border-radius: 8px;
      padding: 16px;
      margin-top: 16px;
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid var(--figma-color-border);
    }

    .panel-header h3 {
      font-size: 13px;
      font-weight: 600;
      margin: 0;
      color: var(--figma-color-text);
    }

    .panel-content {
      font-size: 11px;
      line-height: 1.5;
    }

    .problem-header {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 12px;
    }

    .problem-severity {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      padding: 3px 8px;
      border-radius: 4px;
      width: fit-content;
    }

    .problem-severity.critical {
      background: #fadbd8;
      color: #c0392b;
    }

    .problem-severity.major {
      background: #fcf3cf;
      color: #d68910;
    }

    .problem-severity.minor {
      background: #d6eaf8;
      color: #2980b9;
    }

    .problem-title {
      font-size: 12px;
      font-weight: 500;
      color: var(--figma-color-text);
      line-height: 1.4;
    }

    .problem-location {
      font-size: 10px;
      color: var(--figma-color-text-secondary);
      padding: 6px 0;
      border-bottom: 1px solid var(--figma-color-border);
      margin-bottom: 12px;
    }

    .problem-tip {
      background: var(--figma-color-bg);
      border-left: 3px solid var(--figma-color-border-brand);
      padding: 8px 10px;
      margin: 12px 0;
      border-radius: 4px;
    }

    .problem-tip p {
      margin: 0;
      font-size: 11px;
      line-height: 1.4;
      color: var(--figma-color-text-secondary);
    }

    .problem-tip strong {
      color: var(--figma-color-text);
    }

    .problem-guide {
      margin-top: 12px;
    }

    .problem-guide h4 {
      font-size: 11px;
      font-weight: 600;
      margin: 0 0 8px 0;
      color: var(--figma-color-text);
    }

    .guide-steps {
      margin: 0;
      padding-left: 20px;
      list-style: none;
      counter-reset: step-counter;
    }

    .guide-steps li {
      counter-increment: step-counter;
      margin-bottom: 6px;
      font-size: 11px;
      line-height: 1.4;
      color: var(--figma-color-text-secondary);
      position: relative;
    }

    .guide-steps li::before {
      content: counter(step-counter);
      position: absolute;
      left: -20px;
      top: 0;
      width: 16px;
      height: 16px;
      background: var(--figma-color-bg-brand);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 9px;
      font-weight: 600;
    }

    .panel-actions {
      display: flex;
      gap: 6px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--figma-color-border);
    }

    .panel-actions .btn {
      flex: 1;
      font-size: 11px;
      padding: 6px 10px;
    }

    /* ============================================
       LINTER UI v2 - Visual Analyzer
       ============================================ */

    /* Severity Colors */
    .linter-v2 {
      --color-critical: #EF4444;
      --color-warning: #F97316;
      --color-info: #3B82F6;
      --color-success: #22C55E;
    }

    /* Sub-tabs Navigation */
    .linter-subtabs {
      display: flex;
      gap: 0;
      background: var(--color-panel);
      border: 1px solid var(--color-border);
      border-radius: 8px;
      margin-bottom: 16px;
      position: relative;
      overflow: hidden;
    }

    .linter-subtab-btn {
      flex: 1;
      padding: 10px 12px;
      border: none;
      background: transparent;
      font-weight: 500;
      font-size: 12px;
      color: var(--color-text-secondary);
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }

    .linter-subtab-btn:hover {
      background: rgba(0, 0, 0, 0.03);
    }

    .linter-subtab-btn.active {
      color: var(--color-primary);
      font-weight: 600;
    }

    .linter-subtab-btn.active::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--color-primary);
    }

    .linter-subpanel {
      display: none;
      animation: fadeIn 0.2s ease;
    }

    .linter-subpanel.active {
      display: block;
    }

    /* Score Ring v2 - Gradient */
    .score-ring-v2 {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: var(--color-panel);
      position: relative;
      box-shadow: inset 0 0 0 6px var(--color-border);
    }

    .score-ring-v2.critical {
      box-shadow: inset 0 0 0 6px var(--color-critical);
    }

    .score-ring-v2.warning {
      box-shadow: inset 0 0 0 6px var(--color-warning);
    }

    .score-ring-v2.success {
      box-shadow: inset 0 0 0 6px var(--color-success);
    }

    .score-ring-v2 .score-number {
      font-size: 24px;
      font-weight: 700;
      line-height: 1;
    }

    .score-ring-v2.critical .score-number {
      color: var(--color-critical);
    }

    .score-ring-v2.warning .score-number {
      color: var(--color-warning);
    }

    .score-ring-v2.success .score-number {
      color: var(--color-success);
    }

    .score-ring-v2 .score-suffix {
      font-size: 10px;
      color: var(--color-text-secondary);
      margin-top: 2px;
    }

    /* Status Badge */
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .status-badge.ok {
      background: rgba(34, 197, 94, 0.15);
      color: var(--color-success);
    }

    .status-badge.warning {
      background: rgba(249, 115, 22, 0.15);
      color: var(--color-warning);
    }

    .status-badge.critical {
      background: rgba(239, 68, 68, 0.15);
      color: var(--color-critical);
    }

    .status-badge .badge-icon {
      font-size: 14px;
    }

    /* Summary Header */
    .linter-summary-v2 {
      display: flex;
      gap: 20px;
      align-items: flex-start;
      padding: 16px;
      background: var(--color-panel);
      border-radius: 12px;
      border: 1px solid var(--color-border);
      margin-bottom: 16px;
    }

    .linter-summary-content {
      flex: 1;
    }

    .linter-summary-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .linter-microcopy {
      font-size: 12px;
      color: var(--color-text-secondary);
      line-height: 1.5;
      margin-bottom: 12px;
    }

    /* Stats Cards Row */
    .linter-stats-row {
      display: flex;
      gap: 10px;
    }

    .stat-card {
      flex: 1;
      padding: 10px;
      background: var(--color-bg);
      border-radius: 8px;
      text-align: center;
      border: 1px solid var(--color-border);
    }

    .stat-card .stat-number {
      font-size: 20px;
      font-weight: 700;
      line-height: 1;
    }

    .stat-card.critical .stat-number {
      color: var(--color-critical);
    }

    .stat-card.warning .stat-number {
      color: var(--color-warning);
    }

    .stat-card.info .stat-number {
      color: var(--color-info);
    }

    .stat-card .stat-label {
      font-size: 10px;
      color: var(--color-text-secondary);
      margin-top: 4px;
      text-transform: uppercase;
    }

    /* Filter Chips */
    .filter-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 12px;
    }

    .filter-group {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
    }

    .filter-chip {
      padding: 5px 10px;
      border-radius: 16px;
      font-size: 11px;
      font-weight: 500;
      border: 1px solid var(--color-border);
      background: var(--color-panel);
      color: var(--color-text-secondary);
      cursor: pointer;
      transition: all 0.15s;
    }

    .filter-chip:hover {
      border-color: var(--color-primary);
      color: var(--color-primary);
    }

    .filter-chip.active {
      background: var(--color-primary);
      border-color: var(--color-primary);
      color: #fff;
    }

    .filter-chip.critical.active {
      background: var(--color-critical);
      border-color: var(--color-critical);
    }

    .filter-chip.warning.active {
      background: var(--color-warning);
      border-color: var(--color-warning);
    }

    .filter-chip.info.active {
      background: var(--color-info);
      border-color: var(--color-info);
    }

    .filter-separator {
      width: 1px;
      background: var(--color-border);
      margin: 0 6px;
    }

    /* Issues List v2 */
    .issues-list-v2 {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 350px;
      overflow-y: auto;
    }

    .issue-card-v2 {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 12px;
      background: var(--color-panel);
      border: 1px solid var(--color-border);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.15s;
      border-left: 4px solid transparent;
    }

    .issue-card-v2:hover {
      transform: translateX(2px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .issue-card-v2.critical {
      border-left-color: var(--color-critical);
    }

    .issue-card-v2.warning {
      border-left-color: var(--color-warning);
    }

    .issue-card-v2.info {
      border-left-color: var(--color-info);
    }

    .issue-card-v2.selected {
      background: rgba(12, 123, 255, 0.05);
      border-color: var(--color-primary);
    }

    /* Linter Status Bar - Feedback Visual */
    .linter-status-bar {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 11px;
      padding: 8px 12px;
      border-radius: 6px;
      margin-bottom: 12px;
      transition: all 0.2s ease;
      background: var(--color-bg-secondary);
      border: 1px solid transparent;
    }

    .linter-status-bar.hidden {
      display: none;
    }

    .linter-status-bar--success {
      background: rgba(46, 204, 113, 0.12);
      color: #2ecc71;
      border-color: rgba(46, 204, 113, 0.25);
    }

    .linter-status-bar--warning {
      background: rgba(241, 196, 15, 0.12);
      color: #f1c40f;
      border-color: rgba(241, 196, 15, 0.25);
    }

    .linter-status-bar--error {
      background: rgba(231, 76, 60, 0.12);
      color: #e74c3c;
      border-color: rgba(231, 76, 60, 0.25);
    }

    .linter-status-bar .status-icon {
      flex-shrink: 0;
    }

    .linter-status-bar .status-text {
      flex: 1;
      line-height: 1.4;
    }

    /* Active Issue Highlight */
    .linter-issue--active,
    #linter-issues-body tr.linter-issue--active {
      background: rgba(52, 152, 219, 0.08) !important;
      outline: 2px solid rgba(52, 152, 219, 0.3);
      outline-offset: -2px;
    }

    .issue-icon {
      font-size: 16px;
      flex-shrink: 0;
    }

    .issue-content {
      flex: 1;
      min-width: 0;
    }

    .issue-title-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }

    .issue-title-v2 {
      font-size: 12px;
      font-weight: 600;
      color: var(--color-text);
    }

    .issue-category-chip {
      font-size: 9px;
      padding: 2px 6px;
      border-radius: 4px;
      background: var(--color-bg);
      color: var(--color-text-secondary);
    }

    .issue-summary {
      font-size: 11px;
      color: var(--color-text-secondary);
      line-height: 1.4;
    }

    .issue-node-info {
      font-size: 10px;
      color: var(--color-text-secondary);
      margin-top: 6px;
      font-family: monospace;
      opacity: 0.8;
    }

    /* Details Panel v2 */
    .details-panel-v2 {
      background: var(--color-panel);
      border: 1px solid var(--color-border);
      border-radius: 10px;
      padding: 16px;
      margin-top: 12px;
      display: none;
    }

    .details-panel-v2.visible {
      display: block;
      animation: slideUp 0.2s ease;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .details-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }

    .details-title {
      font-size: 13px;
      font-weight: 600;
    }

    .details-close-btn {
      background: none;
      border: none;
      font-size: 16px;
      cursor: pointer;
      color: var(--color-text-secondary);
      padding: 4px;
    }

    .details-section {
      margin-bottom: 12px;
    }

    .details-label {
      font-size: 10px;
      text-transform: uppercase;
      color: var(--color-text-secondary);
      margin-bottom: 4px;
      font-weight: 600;
    }

    .details-text {
      font-size: 12px;
      line-height: 1.5;
      color: var(--color-text);
    }

    .details-suggestion {
      padding: 10px;
      background: rgba(34, 197, 94, 0.08);
      border-radius: 6px;
      border-left: 3px solid var(--color-success);
    }

    .details-tech-info {
      font-family: monospace;
      font-size: 11px;
      background: var(--color-bg);
      padding: 8px;
      border-radius: 4px;
    }

    .btn-select-node {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      background: var(--color-primary);
      color: #fff;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s;
    }

    .btn-select-node:hover {
      background: var(--color-primary-hover);
      transform: translateY(-1px);
    }

    .btn-select-node:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Logs Tab v2 */
    .logs-container-v2 {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .logs-actions {
      display: flex;
      gap: 8px;
    }

    .logs-textarea {
      width: 100%;
      min-height: 200px;
      max-height: 400px;
      padding: 12px;
      font-family: 'SFMono-Regular', Consolas, monospace;
      font-size: 11px;
      line-height: 1.5;
      background: var(--color-bg);
      border: 1px solid var(--color-border);
      border-radius: 8px;
      resize: vertical;
      color: var(--color-text);
    }

    .logs-empty {
      text-align: center;
      padding: 40px 20px;
      color: var(--color-text-secondary);
      font-size: 12px;
    }

    .logs-empty .icon {
      font-size: 32px;
      margin-bottom: 10px;
      opacity: 0.5;
    }

    /* Dark mode overrides */
    body.dark .linter-v2 .score-ring-v2,
    body.dark .linter-v2 .stat-card,
    body.dark .linter-v2 .issue-card-v2,
    body.dark .linter-v2 .details-panel-v2 {
      background: #2a2a2e;
    }

    body.dark .linter-v2 .logs-textarea {
      background: #1f1f22;
    }
  </style>
</head>

<body>
  <div id="runtime-health" style="display:none"></div>
  <input id="useDeterministic" type="checkbox" style="display:none" aria-hidden="true" />
  <div class="app">
    <header class="topbar">
      <div class="brand">
        <div class="brand-title">Figma to WP Elementor</div>
        <div class="brand-subtitle">Convers&#227;o inteligente de Layouts para WP Elementor</div>
      </div>
      <div class="top-actions">
        <label class="switch" title="Alternar tema">
          <input type="checkbox" id="theme-toggle" />
          <span class="slider">
            <span class="sun">&#9728;</span>
            <span class="moon">&#127769;</span>
          </span>
        </label>
      </div>
    </header>

    <nav class="tabs">
      <button class="tab-btn active" data-tab="layout">Layout &rarr; Elementor</button>
      <button class="tab-btn" data-tab="linter">Linter</button>
      <button class="tab-btn" data-tab="ai">Configura&#231;&#227;o da IA</button>
      <button class="tab-btn" data-tab="wp">WordPress</button>
      <button class="tab-btn" data-tab="help">Ajuda</button>
      <span class="tab-indicator"></span>
    </nav>

    <main class="tab-panels">
      <section class="tab-panel active" data-panel="layout">
        <div class="card">
          <div class="card-title">A&#231;&#245;es r&#225;pidas</div>
          <div class="row">
            <button id="btn_inspect" class="btn secondary">Inspecionar Layout</button>
            <button id="btn_analyze" class="btn secondary">🔍 Analisar Layout</button>
            <button id="btn_generate" class="btn primary">Gerar JSON</button>
            <button id="btn_reset" class="btn secondary" data-action="reset">Reiniciar</button>
          </div>
        </div>

        <!-- Linter Panel -->
        <div id="linter-panel" class="card" style="display: none;">
          <div class="card-title" style="display: flex; justify-content: space-between; align-items: center;">
            <span>Relatório de Análise</span>
            <button id="btn_close_linter" class="btn tiny secondary">Fechar</button>
          </div>

          <div id="linter-summary" class="linter-summary"></div>
          <div id="linter-issues" class="linter-issues"></div>
        </div>
        <div class="card">
          <div id="progress" class="progress hidden">
            <div class="progress-bar"></div>
            <span class="progress-text">Processando pipeline...</span>
          </div>
          <textarea id="output" placeholder="O JSON gerado aparecer&#225; aqui" readonly></textarea>
          <div id="logs" class="logs"></div>
          <div style="margin-top:12px;">
            <label style="display:block;font-size:12px;margin-bottom:6px;">JSON gerado (selecionamos automaticamente; se
              precisar use Ctrl+C):</label>
            <textarea id="figma-json-output" style="width:100%;height:200px"
              placeholder="JSON para copiar/colar no Elementor"></textarea>
            <div style="display:flex;gap:8px;margin-top:8px;align-items:center;">
              <button class="btn secondary" id="copy-manual">Copiar JSON</button>
              <span style="font-size:12px;color:#999;">Se o navegador bloquear, selecione o campo e pressione
                Ctrl+C.</span>
            </div>
          </div>
        </div>
      </section>

      <section class="tab-panel" data-panel="linter">
        <div class="linter-container linter-v2">

          <!-- Linter Header with Actions -->
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <h2 style="font-size: 16px; font-weight: 600; margin: 0;">📊 Análise de Layout</h2>
            <div style="display: flex; gap: 8px;">
              <button class="btn secondary small" id="btn-reanalyze">🔄 Reanalisar</button>
              <button class="btn ghost small" id="btn-copy-report-v2">📋 Copiar Relatório</button>
            </div>
          </div>

          <!-- Sub-tabs Navigation with PRD IDs -->
          <nav class="linter-subtabs">
            <button class="linter-subtab-btn active" id="linter-subtab-summary" data-subtab="summary">📈 Resumo</button>
            <button class="linter-subtab-btn" id="linter-subtab-issues" data-subtab="issues">⚠️ Problemas</button>
            <button class="linter-subtab-btn" id="linter-subtab-logs" data-subtab="logs">📝 Logs</button>
          </nav>

          <!-- ===== RESUMO TAB ===== -->
          <div class="linter-subpanel active" data-subpanel="summary" id="linter-panel-summary">
            <!-- Summary Card -->
            <div class="linter-summary-v2">
              <div class="score-ring-v2 success" id="score-ring-v2">
                <span class="score-number" id="linter-score-value">0</span>
                <span class="score-suffix">/ 100</span>
              </div>
              <div class="linter-summary-content">
                <div class="linter-summary-title">
                  Saúde do Layout
                  <span class="status-badge ok" id="linter-status-badge">
                    <span class="badge-icon">✓</span> OK
                  </span>
                </div>
                <p class="linter-microcopy" id="linter-summary-text">
                  Clique em "🔄 Reanalisar" para analisar o layout selecionado.
                </p>

                <!-- Stats Cards -->
                <div class="linter-stats-row">
                  <div class="stat-card critical">
                    <span class="stat-number" id="linter-critical-count">0</span>
                    <span class="stat-label">Críticos</span>
                  </div>
                  <div class="stat-card warning">
                    <span class="stat-number" id="linter-warning-count">0</span>
                    <span class="stat-label">Atenção</span>
                  </div>
                  <div class="stat-card info">
                    <span class="stat-number" id="linter-info-count">0</span>
                    <span class="stat-label">Sugestões</span>
                  </div>
                  <div class="stat-card ok" style="border-left-color: var(--color-success);">
                    <span class="stat-number" id="linter-ok-count">0</span>
                    <span class="stat-label">OK</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Top Problems Preview -->
            <div class="card" id="top-problems-preview">
              <div class="card-title">🎯 Problemas Principais</div>
              <div id="top-problems-list" style="font-size: 12px; color: var(--color-text-secondary);">
                Clique em "🔄 Reanalisar" para ver os problemas do layout selecionado.
              </div>
            </div>
          </div>

          <!-- ===== PROBLEMAS TAB ===== -->
          <div class="linter-subpanel" data-subpanel="issues" id="linter-panel-issues">
            <!-- Severity Filters with PRD IDs -->
            <div class="filter-row">
              <div class="filter-group" id="severity-filters">
                <button class="filter-chip active" id="filter-severity-all" data-filter-severity="all">Todos</button>
                <button class="filter-chip critical" id="filter-severity-critical" data-filter-severity="critical">🔴
                  Crítico</button>
                <button class="filter-chip warning" id="filter-severity-warning" data-filter-severity="warning">🟠
                  Atenção</button>
                <button class="filter-chip info" id="filter-severity-info" data-filter-severity="info">🔵 Info</button>
                <button class="filter-chip ok" id="filter-severity-ok" data-filter-severity="ok">✅ OK</button>
              </div>
              <span class="filter-separator"></span>
              <!-- Category Filters with PRD IDs -->
              <div class="filter-group" id="category-filters">
                <button class="filter-chip active" id="filter-category-all" data-filter-category="all">Todos</button>
                <button class="filter-chip" id="filter-category-auto-layout" data-filter-category="auto-layout">Auto
                  Layout</button>
                <button class="filter-chip" id="filter-category-naming"
                  data-filter-category="naming">Nomenclatura</button>
                <button class="filter-chip" id="filter-category-structure"
                  data-filter-category="structure">Estrutura</button>
                <button class="filter-chip" id="filter-category-widget" data-filter-category="widget">Widgets</button>
                <button class="filter-chip" id="filter-category-image" data-filter-category="image">Imagens</button>
              </div>
            </div>

            <!-- Search with PRD ID -->
            <div class="search-box" style="margin-bottom: 12px;">
              <input type="text" class="search-input" id="linter-search-input"
                placeholder="Filtrar por nome do layer ou mensagem...">
            </div>

            <!-- Status Bar for Node Selection Feedback -->
            <div class="linter-status-bar hidden" id="linter-status-bar">
              <span class="status-icon" id="linter-status-icon"></span>
              <span class="status-text" id="linter-status-message">Pronto</span>
            </div>

            <!-- Issues Table with standardized ID: linter-issues-body -->
            <div class="issues-list-v2" id="issues-list-v2">
              <table class="linter-issues-table" style="width:100%; font-size:12px; border-collapse: collapse;">
                <thead>
                  <tr style="background: var(--color-bg-tertiary); text-align: left;">
                    <th style="padding: 8px; width: 80px;">Severidade</th>
                    <th style="padding: 8px; width: 100px;">Categoria</th>
                    <th style="padding: 8px;">Descrição</th>
                  </tr>
                </thead>
                <tbody id="linter-issues-body">
                  <!-- Issues serão renderizados aqui -->
                  <tr>
                    <td colspan="3" style="text-align: center; padding: 24px; color: var(--color-text-secondary);">
                      ✨ Nenhum problema encontrado. Execute a análise para ver resultados.
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>

            <!-- Details Panel (contextual, appears when issue selected) -->
            <div class="details-panel-v2" id="details-panel-v2">
              <div class="details-header">
                <span class="details-title" id="details-title">🎯 Detalhes do Problema</span>
                <button class="details-close-btn" id="btn-close-details-v2">✕</button>
              </div>

              <div class="details-section">
                <div class="details-label">Descrição</div>
                <div class="details-text" id="details-description">...</div>
              </div>

              <div class="details-section">
                <div class="details-label">Sugestão de Correção</div>
                <div class="details-suggestion details-text" id="details-suggestion">...</div>
              </div>

              <div class="details-section">
                <div class="details-label">Informações Técnicas</div>
                <div class="details-tech-info" id="details-tech-info">
                  Node: ... | Tipo: ... | Auto Layout: ...
                </div>
              </div>

              <div style="margin-top: 12px;">
                <button class="btn-select-node" id="btn-select-node-v2">
                  🎯 Selecionar no Figma
                </button>
              </div>
            </div>
          </div>

          <!-- ===== LOGS TAB ===== -->
          <div class="linter-subpanel" data-subpanel="logs" id="linter-panel-logs">
            <div class="logs-container-v2">
              <div class="logs-actions">
                <button class="btn secondary small" id="linter-logs-copy">📋 Copiar Logs</button>
                <button class="btn ghost small" id="linter-logs-clear">🗑️ Limpar Visualização</button>
              </div>

              <!-- Standardized ID: linter-logs-content -->
              <textarea class="logs-textarea" id="linter-logs-content" readonly
                placeholder="Os logs de análise aparecerão aqui após executar o Linter..."></textarea>

              <div class="logs-empty" id="logs-empty-state" style="display: none;">
                <div class="icon">📋</div>
                <p>Nenhum log disponível nesta execução.</p>
              </div>
            </div>
          </div>

        </div>
      </section>


      <section class="tab-panel" data-panel="ai">
        <div class="card">
          <div class="card-title">Configura&#231;&#227;o da IA</div>
          <label class="checkbox">
            <input id="use_ai" type="checkbox" checked />
            <span>Usar IA para convers&#227;o</span>
          </label>
          <label class="input-label" for="provider_ai">Provedor de IA</label>
          <select id="provider_ai">
            <option value="gemini">Gemini</option>
            <option value="gpt">GPT (OpenAI)</option>
          </select>

          <div id="ai_settings">
            <div class="provider-block provider-gemini">
              <label class="input-label" for="gemini_api_key">Gemini API Key</label>
              <input id="gemini_api_key" type="password" autocomplete="off" placeholder="Cole sua API Key do Gemini" />
              <label class="input-label" for="gemini_model">Modelo</label>
              <select id="gemini_model">
                <option value="gemini-2.0-flash-exp">gemini-2.0-flash-exp (Experimental)</option>
                <option value="gemini-1.5-pro-002">gemini-1.5-pro-002 (Stable)</option>
                <option value="gemini-1.5-flash-002">gemini-1.5-flash-002 (Fast & Stable)</option>
              </select>
              <div class="actions">
                <button class="btn primary" data-action="test-gemini">Testar conex&#227;o</button>
              </div>
              <div id="gemini-status" class="status"></div>
            </div>

            <div class="provider-block provider-gpt">
              <label class="input-label" for="gpt_api_key">OpenAI API Key</label>
              <input id="gpt_api_key" type="password" autocomplete="off" placeholder="Cole sua chave da OpenAI" />
              <label class="input-label" for="gpt_model">Modelo GPT</label>
              <select id="gpt_model">
                <option value="gpt-4.1-mini">gpt-4.1-mini (recomendado)</option>
                <option value="gpt-4.1">gpt-4.1</option>
                <option value="gpt-4.1-preview">gpt-4.1-preview</option>
                <option value="gpt-o1">gpt-o1</option>
                <option value="gpt-o3-mini">gpt-o3-mini</option>
              </select>
              <div class="actions">
                <button class="btn primary" data-action="test-gpt">Testar conex&#227;o GPT</button>
              </div>
              <div id="gpt-status" class="status"></div>
            </div>
          </div>
          <div class="checkbox-group">
            <label class="checkbox">
              <input id="include_screenshot" type="checkbox" checked />
              <span>Enviar print do frame para a IA (Melhora precis&#227;o)</span>
            </label>
            <label class="checkbox">
              <input id="include_references" type="checkbox" checked />
              <span>Enviar arquivos de refer&#234;ncia (.md) junto com o pedido</span>
            </label>
          </div>
      </section>

      <section class="tab-panel" data-panel="wp">
        <div class="card">
          <div class="card-title">WordPress</div>
          <label class="input-label" for="wp_url">WP URL</label>
          <input id="wp_url" type="text" autocomplete="off" placeholder="https://site.com" />

          <label class="input-label" for="wp_user">Usu&#225;rio WP</label>
          <input id="wp_user" type="text" autocomplete="username" placeholder="usu&#225;rio" />

          <label class="input-label" for="wp_token">Senha do App (Token)</label>
          <input id="wp_token" type="password" autocomplete="current-password"
            placeholder="Senha de aplica&#231;&#227;o do WP" />

          <label class="checkbox">
            <input id="wp_export_images" type="checkbox" />
            <span>Exportar imagens automaticamente</span>
          </label>

          <div class="slider-group" id="webp_quality_group" style="margin: 12px 0; display: none;">
            <label class="input-label" for="wp_webp_quality">Qualidade WebP: <span
                id="webp_quality_value">85</span>%</label>
            <input id="wp_webp_quality" type="range" min="0" max="100" value="85" style="width: 100%;" />
          </div>

          <div class="actions">
            <button class="btn primary" data-action="test-wp">Testar conex&#227;o</button>
            <button class="btn secondary" data-action="export-wp">Exportar WP</button>
          </div>
          <div id="wp-status" class="status"></div>
        </div>
      </section>

      <section class="tab-panel" data-panel="help">
        <!-- Nomenclature Guide -->


        <!-- Widget Search -->
        <div class="search-box">
          <input type="text" id="widget-search" class="search-input"
            placeholder="Buscar widget (ex: button, woo, pro)..." autocomplete="off" />
        </div>
        <div id="widget-list-container"></div>
      </section>
    </main>
  </div>
  <div id="resizer-handle" aria-label="Arraste para redimensionar"></div>

  <script>
    parent.postMessage(
      { pluginMessage: { diagnosticPing: true } },
      "*"
    );
    console.log("[diagnostic] UI loaded, ping enviado");
  </script>
  <script>
    (() => {
      const tabs = document.querySelectorAll('.tab-btn');
      const panels = document.querySelectorAll('.tab-panel');
      const indicator = document.querySelector('.tab-indicator');
      const output = document.getElementById('output');
      const logs = document.getElementById('logs');
      const btnInspect = document.getElementById('btn_inspect');
      const btnDownload = document.querySelector('[data-action="download-json"]');
      const btnCopy = document.querySelector('[data-action="copy-json"]');
      const btnExport = document.querySelector('[data-action="export-wp"]');

      document.getElementById('btn_generate').onclick = () => {
        const payload = {
          type: 'generate-json',
          apiKey: fields.gpt_api_key?.value || '',
          gptModel: fields.gpt_model?.value || '',
          geminiModel: fields.gemini_model?.value || '',
          includeScreenshot: fields.include_screenshot?.checked !== false,
          includeReferences: fields.include_references?.checked !== false,
          autoRename: fields.auto_rename_layers?.checked || false,
          useDeterministic: fields.use_deterministic?.checked || false,
        };
        // ... rest of generate logic
        send('generate-json', payload);
      };



      document.getElementById('btn_inspect').onclick = () => {
        send('inspect');
      };
      const themeToggle = document.getElementById('theme-toggle');
      const darkSheet = document.getElementById('theme-dark');
      const bridgeOutput = document.getElementById('figma-json-output');
      const btnCopyManual = document.getElementById('copy-manual');
      let lastPayload = '';
      let fullPayload = '';





      const fields = {
        use_ai: document.getElementById('use_ai'),
        use_deterministic: document.getElementById('useDeterministic'),
        provider_ai: document.getElementById('provider_ai'),
        gemini_api_key: document.getElementById('gemini_api_key'),
        gemini_model: document.getElementById('gemini_model'),
        gpt_api_key: document.getElementById('gpt_api_key'),
        gpt_model: document.getElementById('gpt_model'),
        include_screenshot: document.getElementById('include_screenshot'),
        include_references: document.getElementById('include_references'),
        wp_url: document.getElementById('wp_url'),
        wp_user: document.getElementById('wp_user'),
        wp_token: document.getElementById('wp_token'),
        wp_export_images: document.getElementById('wp_export_images'),
        wp_webp_quality: document.getElementById('wp_webp_quality'),
        webp_quality_group: document.getElementById('webp_quality_group'),
        webp_quality_value: document.getElementById('webp_quality_value'),
        wp_status: document.getElementById('wp-status')
      };
      const aiSettings = document.getElementById('ai_settings');

      const storage = null; // desativado para evitar SecurityError em sandbox
      const updateBridgeOutput = (value, autoSelect = false) => {
        if (!bridgeOutput) return;
        bridgeOutput.value = value || '';
        if (autoSelect) {
          requestAnimationFrame(() => {
            bridgeOutput.focus();
            bridgeOutput.select();
          });
        }
      };

      function updateWpStatus(message, state = 'info') {
        if (!fields.wp_status) return;
        const text = message || '';
        fields.wp_status.textContent = text;
        fields.wp_status.dataset.state = state;
        fields.wp_status.style.display = text ? 'block' : 'none';
      }

      function updateExportImagesControls(enabled) {
        if (!fields.wp_export_images) return;
        const isEnabled = !!enabled;
        fields.wp_export_images.checked = isEnabled;
        if (fields.webp_quality_group) {
          fields.webp_quality_group.style.display = isEnabled ? 'block' : 'none';
        }
      }

      function debounce(fn, wait = 300) {
        let t;
        return (...args) => {
          clearTimeout(t);
          t = setTimeout(() => fn(...args), wait);
        };
      }

      function updateIndicator() {
        const active = document.querySelector('.tab-btn.active');
        if (!indicator || !active || !active.parentElement) return;
        const rect = active.getBoundingClientRect();
        const parentRect = active.parentElement.getBoundingClientRect();
        indicator.style.width = `${rect.width}px`;
        indicator.style.transform = `translateX(${rect.left - parentRect.left}px)`;
      }

      function setActiveTab(name) {
        tabs.forEach(t => t.classList.toggle('active', t.dataset.tab === name));
        panels.forEach(p => p.classList.toggle('active', p.dataset.panel === name));
        updateIndicator();
      }

      function setProvider(providerId) {
        const value = providerId === 'gpt' ? 'gpt' : 'gemini';
        document.body?.setAttribute('data-provider', value);
        if (fields.provider_ai) fields.provider_ai.value = value;
      }

      function toggleAIFields(enabled) {
        document.body?.setAttribute('data-use-ai', enabled ? 'true' : 'false');
        if (aiSettings) {
          aiSettings.classList.toggle('ai-hidden', !enabled);
        }
      }

      tabs.forEach(btn => btn.addEventListener('click', () => setActiveTab(btn.dataset.tab)));

      function applyTheme(isDark) {
        document.documentElement.classList.toggle('dark', isDark);
        if (themeToggle) themeToggle.checked = isDark;
        if (darkSheet) darkSheet.disabled = !isDark;
        if (storage) {
          try { storage.setItem('figtoel-theme', isDark ? 'dark' : 'light'); } catch (e) { /* ignore */ }
        }
      }

      function initTheme(pref) {
        let stored = null;
        if (storage) {
          try { stored = storage.getItem('figtoel-theme'); } catch (e) { stored = null; }
        }
        const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        if (typeof pref === 'boolean') applyTheme(pref);
        else applyTheme(stored === 'dark' || (stored === null && prefersDark));
      }

      if (themeToggle) {
        themeToggle.addEventListener('change', () => {
          applyTheme(themeToggle.checked);
          send('save-setting', { key: 'gptel_dark_mode', value: themeToggle.checked });
        });
      }

      function send(type, payload = {}) {
        // FORENSIC LOG
        if (type === 'analyze-layout') {
          console.error('⚠️⚠️⚠️ [UI FORENSIC] send("analyze-layout") CHAMADO!');
          console.error('⚠️ Stack trace:', new Error().stack);
          console.error('⚠️ Payload:', payload);
        }
        parent.postMessage({ pluginMessage: { type, ...payload } }, '*');
      }
      window.send = send;

      function addLog(message, level = 'info') {
        if (!logs) return;
        const now = new Date();
        const time = now.toLocaleTimeString('pt-BR', { hour12: false });
        const div = document.createElement('div');
        div.textContent = `[${time}] [${level}] ${message}`;
        logs.appendChild(div);
        logs.scrollTo(0, logs.scrollHeight);
      }

      async function copyWithFallback(text, label = 'contedo') {
        if (!text) {
          addLog(`Nenhum ${label} para copiar.`, 'warn');
          return false;
        }
        try {
          if (navigator.clipboard && navigator.clipboard.writeText) {
            await navigator.clipboard.writeText(text);
            addLog(` ${label} copiado!`, 'info');
            return true;
          }
        } catch (err) {
          console.warn('Clipboard API falhou:', err);
        }
        try {
          const textarea = document.createElement('textarea');
          textarea.value = text;
          textarea.style.position = 'fixed';
          textarea.style.opacity = '0';
          document.body.appendChild(textarea);
          textarea.select();
          const success = document.execCommand('copy');
          document.body.removeChild(textarea);
          if (success) {
            addLog(` ${label} copiado!`, 'info');
            return true;
          }
        } catch (err) {
          addLog(` Falha ao copiar. Use Ctrl+C.`, 'error');
        }
        return false;
      }

      function loadStoredSettings(payload) {
        if (!payload) return;
        const useAI = payload.useAI;
        if (fields.use_ai) {
          const val = typeof useAI === 'boolean' ? useAI : true;
          fields.use_ai.checked = val;
          toggleAIFields(val);
        }
        if (fields.provider_ai) setProvider(payload.providerAi || 'gemini');
        if (fields.gemini_api_key) fields.gemini_api_key.value = payload.geminiKey || '';
        if (fields.gemini_model && payload.geminiModel) {
          fields.gemini_model.value = payload.geminiModel;
          addLog(`Modelo carregado: ${payload.geminiModel}`, 'info');
        }
        if (fields.gpt_api_key) fields.gpt_api_key.value = payload.gptKey || '';
        if (fields.gpt_model && payload.gptModel) fields.gpt_model.value = payload.gptModel;
        if (fields.include_screenshot) fields.include_screenshot.checked = payload.includeScreenshot !== false;
        if (fields.include_references) fields.include_references.checked = payload.includeReferences !== false;
        if (fields.wp_url) fields.wp_url.value = payload.wpUrl || '';
        if (fields.wp_user) fields.wp_user.value = payload.wpUser || '';
        if (fields.wp_token) fields.wp_token.value = payload.wpToken || '';
        if (fields.wp_export_images) {
          updateExportImagesControls(payload.exportImages);
        }
        if (fields.wp_webp_quality) {
          const quality = payload.webpQuality !== undefined ? payload.webpQuality : 85;
          fields.wp_webp_quality.value = quality;
          if (fields.webp_quality_value) fields.webp_quality_value.textContent = quality;
        }
        if (typeof payload.darkMode === 'boolean') applyTheme(payload.darkMode);
        updateIndicator();
      }

      function watchInputs() {
        const saveText = (key, el) => debounce(() => send('save-setting', { key, value: el.value }));
        if (fields.use_ai) {
          fields.use_ai.addEventListener('change', () => {
            const enabled = fields.use_ai.checked;
            toggleAIFields(enabled);
            send('save-setting', { key: 'gptel_use_ai', value: enabled });
          });
        }
        if (fields.provider_ai) {
          fields.provider_ai.addEventListener('change', () => {
            setProvider(fields.provider_ai.value);
            send('save-setting', { key: 'aiProvider', value: fields.provider_ai.value });
          });
        }
        if (fields.gemini_api_key) fields.gemini_api_key.addEventListener('input', saveText('gptel_gemini_key', fields.gemini_api_key));
        if (fields.gemini_model) {
          fields.gemini_model.addEventListener('change', () => {
            send('save-setting', { key: 'gemini_model', value: fields.gemini_model.value });
            addLog(`Modelo alterado para: ${fields.gemini_model.value}`, 'info');
          });
        }
        if (fields.gpt_api_key) fields.gpt_api_key.addEventListener('input', saveText('gptApiKey', fields.gpt_api_key));
        if (fields.gpt_model) fields.gpt_model.addEventListener('change', () => send('save-setting', { key: 'gptModel', value: fields.gpt_model.value }));
        if (fields.include_screenshot) fields.include_screenshot.addEventListener('change', () => send('save-setting', { key: 'gptel_include_screenshot', value: fields.include_screenshot.checked }));
        if (fields.include_references) fields.include_references.addEventListener('change', () => send('save-setting', { key: 'gptel_include_references', value: fields.include_references.checked }));
        if (fields.wp_url) fields.wp_url.addEventListener('input', saveText('gptel_wp_url', fields.wp_url));
        if (fields.wp_user) fields.wp_user.addEventListener('input', saveText('gptel_wp_user', fields.wp_user));
        if (fields.wp_token) fields.wp_token.addEventListener('input', saveText('gptel_wp_token', fields.wp_token));
        if (fields.wp_export_images) {
          fields.wp_export_images.addEventListener('change', () => {
            const checked = fields.wp_export_images.checked;
            send('save-setting', { key: 'gptel_export_images', value: checked });
            updateExportImagesControls(checked);
          });
        }
        if (fields.wp_webp_quality) {
          fields.wp_webp_quality.addEventListener('input', () => {
            const quality = fields.wp_webp_quality.value;
            if (fields.webp_quality_value) fields.webp_quality_value.textContent = quality;
            send('save-setting', { key: 'gptel_webp_quality', value: parseInt(quality) });
          });
        }
      }

      function bindActions() {
        document.querySelectorAll('[data-action]').forEach(btn => {
          btn.addEventListener('click', () => {
            if (btn.disabled && ['copy-json', 'download-json', 'export-wp'].includes(btn.getAttribute('data-action') || '')) {
              return;
            }
            const action = btn.getAttribute('data-action');
            if (fields.gemini_model && fields.gemini_model.value) {
              send('save-setting', { key: 'gemini_model', value: fields.gemini_model.value });
            }
            const payload = {
              useAI: fields.use_ai?.checked !== false,
              providerAi: fields.provider_ai?.value || 'gemini',
              gptModel: fields.gpt_model?.value || '',
              wpConfig: {
                url: fields.wp_url?.value || '',
                user: fields.wp_user?.value || '',
                token: fields.wp_token?.value || '',
                exportImages: fields.wp_export_images?.checked || false,
                webpQuality: parseInt(fields.wp_webp_quality?.value || 85)
              },
              apiKey: fields.gemini_api_key?.value || '',
              gptApiKey: fields.gpt_api_key?.value || '',
              geminiModel: fields.gemini_model?.value || '',
              includeScreenshot: fields.include_screenshot?.checked !== false,
              includeReferences: fields.include_references?.checked !== false,
              useDeterministic: fields.use_deterministic?.checked || false,
            };
            if (payload.geminiModel) {
              send('save-setting', { key: 'gemini_model', value: payload.geminiModel });
            }
            if (payload.gptModel) {
              send('save-setting', { key: 'gptModel', value: payload.gptModel });
            }
            switch (action) {
              case 'inspect-layout': send('inspect'); break;
              case 'generate-json':
                toggleProgress(true);
                send('generate-json', payload);
                break;
              case 'optimize-structure': send('optimize-structure', payload); break;
              case 'analyze-widgets': send('analyze-widgets', payload); break;
              case 'copy-json':
                if (lastPayload) {
                  copyToClipboard(lastPayload);
                } else {
                  send('copy-json');
                }
                break;
              case 'download-json':
                if (fullPayload || lastPayload) {
                  downloadPayload(fullPayload || lastPayload);
                } else {
                  send('download-json');
                }
                break;
              case 'reset':
                if (output) output.value = '';
                if (logs) logs.innerHTML = '';
                if (fields.gemini_model) fields.gemini_model.value = fields.gemini_model.options[0]?.value || '';
                updateBridgeOutput('', false);
                updateBridgeOutput('', false);
                lastPayload = '';
                fullPayload = '';
                toggleProgress(false);
                toggleResultButtons(false);
                addLog('Sessao reiniciada.', 'info');
                send('reset');
                break;
                if (fields.gemini_model) fields.gemini_model.value = fields.gemini_model.options[0]?.value || '';
                updateBridgeOutput('', false);
                updateBridgeOutput('', false);
                lastPayload = '';
                fullPayload = '';
                toggleProgress(false);
                toggleResultButtons(false);
                addLog('Sessao reiniciada.', 'info');
                send('reset');
                break;
              case 'test-gemini': send('test-gemini', { apiKey: payload.apiKey }); break;
              case 'test-gpt': send('test-gpt', { apiKey: payload.gptApiKey, model: payload.gptModel || fields.gpt_model?.value }); break;
              case 'test-wp':
                updateWpStatus('Testando conexão...', 'pending');
                addLog('Testando conexão com WordPress...', 'info');
                send('test-wp', { wpConfig: payload.wpConfig });
                break;
              case 'resize-ui': send('resize-ui', { width: Math.min(window.innerWidth + 200, 1400), height: Math.min(window.innerHeight + 200, 1000) }); break;
              default: send(action || 'noop', payload);
            }
          });
        });
        document.querySelectorAll('[data-rename]').forEach(btn => {
          btn.addEventListener('click', () => {
            const name = btn.getAttribute('data-rename');
            send('rename-layer', { name });
          });
        });
      }

      async function convertToWebP(uint8Array, originalMime) {
        const blob = new Blob([new Uint8Array(uint8Array)], { type: originalMime });
        const url = URL.createObjectURL(blob);
        const img = new Image();
        await new Promise((resolve, reject) => {
          img.onload = resolve;
          img.onerror = reject;
          img.src = url;
        });

        const canvas = document.createElement('canvas');
        canvas.width = img.width;
        canvas.height = img.height;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0);

        return new Promise(resolve => {
          // Get quality from slider (0-100) and convert to 0-1 range
          const qualitySlider = document.getElementById('wp_webp_quality');
          const quality = qualitySlider ? parseInt(qualitySlider.value) / 100 : 0.85;

          canvas.toBlob(blob => {
            URL.revokeObjectURL(url);
            resolve(blob);
          }, 'image/webp', quality);
        });
      }

      async function uploadImage(msg) {
        const { id, name, mimeType, data, needsConversion } = msg;
        const url = (fields.wp_url.value || '').replace(/\/$/, '');
        const user = fields.wp_user.value;
        const token = fields.wp_token.value;

        if (!url || !user || !token) {
          send('upload-image-response', { id, success: false, error: 'Credenciais WP ausentes na UI' });
          return;
        }

        try {
          let blob;
          addLog('[UI] Uploading image: ' + name + ' needsConversion: ' + needsConversion, 'info');
          if (needsConversion) {
            addLog('[UI] Converting to WebP...', 'info');
            try {
              blob = await convertToWebP(data, mimeType);
            } catch (e) {
              console.warn('[UI] WebP conversion failed:', e);
              addLog('[UI] WebP conversion failed. Using original format.', 'warn');
              blob = new Blob([new Uint8Array(data)], { type: mimeType || 'image/png' });
            }
            addLog('[UI] Converted blob type: ' + blob.type + ' size: ' + blob.size, 'info');
          } else {
            blob = new Blob([new Uint8Array(data)], { type: mimeType });
            addLog('[UI] Using original blob type: ' + blob.type, 'info');
          }

          const formData = new FormData();
          formData.append('file', blob, name);
          formData.append('title', name.split('.')[0]);
          formData.append('caption', 'Exported via FigToEL');

          const auth = btoa(`${user}:${token}`);
          const resp = await fetch(`${url}/wp-json/wp/v2/media`, {
            method: 'POST',
            headers: {
              'Authorization': `Basic ${auth}`
            },
            body: formData
          });

          if (!resp.ok) {
            const errText = await resp.text();
            throw new Error(`HTTP ${resp.status}: ${errText}`);
          }

          const json = await resp.json();
          send('upload-image-response', { id, success: true, url: json.source_url, wpId: json.id });

        } catch (e) {
          send('upload-image-response', { id, success: false, error: e.message });
        }
      }

      window.onmessage = (event) => {
        const msg = (event.data || {}).pluginMessage;
        if (!msg) return;
        switch (msg.type) {
          case 'runtime-health': {
            const runtimeEl = document.getElementById('runtime-health');
            if (runtimeEl) {
              runtimeEl.textContent = msg.status || 'unknown';
              runtimeEl.dataset.status = msg.status || 'unknown';
              if (Array.isArray(msg.warnings)) {
                runtimeEl.dataset.warnings = msg.warnings.join(',');
              }
            }
            break;
          }
          case 'preview':
            // Preview = Figma JSON (readonly) -> #output
            if (output) output.value = msg.payload || '';
            break;
          case 'generation-complete':
            // Generation = Elementor JSON (editable) -> #figma-json-output
            // Use pastePayload (elements array) for display/copy, keep payload (full) for download
            lastPayload = msg.pastePayload || msg.payload || '';
            fullPayload = msg.payload || '';
            updateBridgeOutput(lastPayload, true);
            addLog('JSON gerado.', 'info');
            toggleProgress(false);
            toggleResultButtons(true);
            break;
          case 'copy-json': {
            const txt = msg.payload || '';
            lastPayload = txt;
            updateBridgeOutput(txt, true);
            addLog('JSON pronto para copiar. Clique em "Copiar JSON" ou use Ctrl+C.', 'info');
            break;
          }
          case 'clipboard:copy': {
            copyWithFallback(msg.payload || '', 'JSON');
            break;
          }
          case 'generation-error':
            toggleProgress(false);
            toggleResultButtons(false);
            alert(`Erro na geracao: ${msg.message}`);
            break;
          case 'generation-start':
            toggleProgress(true);
            updateBridgeOutput('', false);
            // No limpamos o #output (Figma JSON) pois o usurio pode querer consult-lo
            toggleResultButtons(false);
            break;
          case 'gemini-status':
            addLog(msg.message || 'Status Gemini', msg.success ? 'success' : 'error');
            const gs = document.getElementById('gemini-status');
            if (gs) gs.textContent = msg.message;
            break;
          case 'gpt-status':
            addLog(msg.message || 'Status GPT', msg.success ? 'success' : 'error');
            const gptStatus = document.getElementById('gpt-status');
            if (gptStatus) gptStatus.textContent = msg.message;
            break;
          case 'wp-status': {
            const isSuccess = msg.success === true;
            const isFailure = msg.success === false;
            const fallback = isSuccess
              ? 'Conexao com WordPress verificada.'
              : isFailure
                ? 'Falha na conexao com WordPress.'
                : 'Status do WordPress atualizado.';
            const logType = isSuccess ? 'success' : isFailure ? 'error' : 'info';
            updateWpStatus(msg.message || fallback, logType);
            addLog(msg.message || fallback, logType);
            break;
          }
          case 'upload-image-request':
            uploadImage(msg);
            break;
          case 'load-settings':
            console.log('📥 [UI] Recebendo configurações:', msg.payload);
            if (msg.payload) {
              // Gemini
              if (msg.payload.geminiKey && fields.gemini_api_key) {
                fields.gemini_api_key.value = msg.payload.geminiKey;
                console.log('✅ Gemini Key carregada');
              }
              if (msg.payload.geminiModel && fields.gemini_model) {
                fields.gemini_model.value = msg.payload.geminiModel;
              }

              // GPT
              if (msg.payload.gptKey && fields.gpt_api_key) {
                fields.gpt_api_key.value = msg.payload.gptKey;
                console.log('✅ GPT Key carregada');
              }
              if (msg.payload.gptModel && fields.gpt_model) {
                fields.gpt_model.value = msg.payload.gptModel;
              }

              // WordPress
              if (msg.payload.wpUrl && fields.wp_url) {
                fields.wp_url.value = msg.payload.wpUrl;
                console.log('✅ WP URL carregada:', msg.payload.wpUrl);
              }
              if (msg.payload.wpUser && fields.wp_user) {
                fields.wp_user.value = msg.payload.wpUser;
                console.log('✅ WP User carregado');
              }
              if (msg.payload.wpToken && fields.wp_token) {
                fields.wp_token.value = msg.payload.wpToken;
                console.log('✅ WP Token carregado');
              }

              // Provider
              if (msg.payload.providerAi) {
                if (fields.provider_ai) {
                  fields.provider_ai.value = msg.payload.providerAi;
                }
                setProvider(msg.payload.providerAi);
                console.log('✅ Provider setado:', msg.payload.providerAi);
              }

              // Checkboxes
              if (fields.use_ai !== undefined) {
                fields.use_ai.checked = msg.payload.useAI !== false;
              }
              if (fields.wp_export_images) {
                const enabled = msg.payload.exportImages === true;
                updateExportImagesControls(enabled);
              }
              if (fields.wp_webp_quality && typeof msg.payload.webpQuality === 'number') {
                fields.wp_webp_quality.value = msg.payload.webpQuality;
                if (fields.webp_quality_value) {
                  fields.webp_quality_value.textContent = msg.payload.webpQuality;
                }
              }
              if (fields.auto_page !== undefined) {
                fields.auto_page.checked = msg.payload.autoPage === true;
              }

              console.log('✅ [UI] Todas as configurações aplicadas!');
              addLog('Configurações carregadas com sucesso', 'success');
            }
            break;

          case 'linter-report':
            const report = msg.payload;
            console.log('📊 [UI] Recebendo relatório do Linter:', report);

            // Renderizar visualmente
            renderLinterReport(report);

            // Mudar para a aba do Linter automaticamente
            setActiveTab('linter');

            // Log no console para debug (mantido)
            addLog(`📊 Análise concluída: ${report.summary.total} issues encontrados.`, 'info');
            break;

          // ============================================================
          // LINTER: Node Selection Feedback (from backend)
          // ============================================================
          case 'linter:select-node:ok': {
            const { nodeId, nodeName, message } = msg.payload || {};
            console.log('[UI] linter:select-node:ok', { nodeId, nodeName });

            // Show success status bar
            const successMessage = message || 'Elemento localizado e selecionado no Figma.';
            setLinterStatus('success', '✅ ' + successMessage);

            // Log entry
            addLog(`🎯 [LINTER/UI] Node selecionado: ${nodeName || nodeId}`, 'info');
            break;
          }

          case 'linter:select-node:error': {
            const { nodeId, reason, detail } = msg.payload || {};
            console.warn('[UI] linter:select-node:error', { nodeId, reason, detail });

            // Map reason to PT-BR microcopy
            const errorMessages = {
              'NODE_NOT_FOUND': 'Não foi possível localizar esse elemento no arquivo. Ele pode ter sido excluído ou movido.',
              'INVALID_ID': 'ID de elemento inválido. Tente reanalisar o layout.',
              'INTERNAL_ERROR': 'Ocorreu um erro ao tentar selecionar o elemento. Tente novamente.',
              'UNKNOWN_ERROR': 'Ocorreu um erro ao tentar selecionar o elemento. Tente novamente.'
            };
            const errorMessage = errorMessages[reason] || 'Não foi possível selecionar o elemento. Verifique o layout e tente de novo.';

            // Show error status bar
            setLinterStatus('error', '❌ ' + errorMessage);

            // Log entry
            addLog(`❌ [LINTER/UI] Falha ao selecionar node ${nodeId || '?'} (${reason || 'desconhecido'})`, 'error');
            break;
          }

          // ============================================================
          // LINTER: Rename Node Result (from backend)
          // ============================================================
          case 'linter-rename-node:result': {
            const { nodeId, oldName, newName, status, errorMessage } = msg.payload || {};
            console.log('[UI] linter-rename-node:result', { nodeId, oldName, newName, status });

            // Re-enable rename button
            const renameBtn = document.getElementById('details-rename-apply');
            if (renameBtn) {
              renameBtn.disabled = false;
              renameBtn.textContent = '✏️ Renomear';
            }

            if (status === 'ok') {
              // Show success message
              setLinterStatus('success', `✅ Layer renomeada: "${oldName}" → "${newName}"`);
              addLog(`✏️ [LINTER/UI] Layer renomeada: ${oldName} → ${newName}`, 'success');

              // Update current name display in action panel
              const currentNameEl = document.getElementById('details-current-name');
              if (currentNameEl) currentNameEl.textContent = newName;

              // Update card that has the matching nodeId
              const card = document.querySelector(`.issue-card-v2[data-node-id="${nodeId}"]`);
              if (card) {
                const nodeInfo = card.querySelector('.issue-node-info');
                if (nodeInfo) nodeInfo.textContent = `📍 ${newName}`;

                // Hide naming suggestion since it's been applied
                const suggestionEl = card.querySelector('.issue-naming-suggestion');
                if (suggestionEl) suggestionEl.innerHTML = `<span style="color: var(--color-success);">✅ Renomeado para: ${newName}</span>`;
              }

            } else {
              // Show error message
              const errorMsg = errorMessage || 'Erro desconhecido ao renomear layer.';
              setLinterStatus('error', `❌ ${errorMsg}`);
              addLog(`❌ [LINTER/UI] Falha ao renomear: ${errorMsg}`, 'error');
            }
            break;
          }
        }
      };

      bindActions();
      watchInputs();
      initTheme();
      setProvider(fields.provider_ai?.value || 'gemini');
      toggleAIFields(fields.use_ai?.checked !== false);
      send('load-settings');
      setActiveTab('layout');
      if (fields.wp_token) fields.wp_token.setAttribute('type', 'password');

      function toggleResultButtons(enabled) {
        if (btnCopy) btnCopy.disabled = !enabled;
        if (btnDownload) btnDownload.disabled = !enabled;
        if (btnExport) btnExport.disabled = !enabled;
      }
      toggleResultButtons(false);

      function toggleProgress(show) {
        if (!progress) return;
        if (show) {
          progress.classList.remove('hidden');
          progress.style.display = 'flex';
        } else {
          progress.classList.add('hidden');
          progress.style.display = 'none';
        }
      }

      const copyToClipboard = (text) => copyWithFallback(text, 'JSON');

      function downloadPayload(text) {
        const blob = new Blob([text], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'elementor.json';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        addLog('Download iniciado.', 'info');
      }

      // Resizer handle
      const resizer = document.getElementById('resizer-handle');
      if (resizer) {
        let startX = 0, startY = 0, startW = window.innerWidth, startH = window.innerHeight;
        const onMove = (clientX, clientY) => {
          const newW = Math.min(1500, Math.max(600, startW + (clientX - startX)));
          const newH = Math.min(1000, Math.max(500, startH + (clientY - startY)));
          send('resize-ui', { width: newW, height: newH });
        };
        const onMouseMove = (e) => { e.preventDefault(); onMove(e.clientX, e.clientY); };
        const onMouseUp = () => {
          window.removeEventListener('mousemove', onMouseMove);
          window.removeEventListener('mouseup', onMouseUp);
        };
        resizer.addEventListener('mousedown', (e) => {
          e.preventDefault();
          startX = e.clientX;
          startY = e.clientY;
          startW = window.innerWidth;
          startH = window.innerHeight;
          window.addEventListener('mousemove', onMouseMove);
          window.addEventListener('mouseup', onMouseUp);
        });
        const onTouchMove = (e) => {
          const t = e.touches[0];
          if (t) onMove(t.clientX, t.clientY);
        };
        const onTouchEnd = () => {
          window.removeEventListener('touchmove', onTouchMove);
          window.removeEventListener('touchend', onTouchEnd);
        };
        resizer.addEventListener('touchstart', (e) => {
          const t = e.touches[0];
          if (!t) return;
          startX = t.clientX;
          startY = t.clientY;
          startW = window.innerWidth;
          startH = window.innerHeight;
          window.addEventListener('touchmove', onTouchMove);
          window.addEventListener('touchend', onTouchEnd);
        }, { passive: true });
      }

      if (btnCopyManual) {
        btnCopyManual.addEventListener('click', async () => {
          const txt = bridgeOutput?.value || lastPayload || '';
          if (!txt) {
            addLog('Nenhum JSON gerado para copiar ainda.', 'warn');
            return;
          }
          if (bridgeOutput) {
            bridgeOutput.focus();
            bridgeOutput.select();
          }
          await copyWithFallback(txt, 'JSON');
        });
      }

      if (bridgeOutput) {
        bridgeOutput.addEventListener('click', () => {
          bridgeOutput.focus();
          bridgeOutput.select();
        });
      }

      // Icones SVG otimizados
      const ICONS = {
        text: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 7V4h16v3M9 20h6M12 4v16"/></svg>`,
        image: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>`,
        button: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="8" width="18" height="8" rx="2"/><line x1="12" y1="12" x2="12" y2="12"/></svg>`,
        container: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M9 21V9"/></svg>`,
        woo: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></svg>`,
        star: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>`,
        video: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="23 7 16 12 23 17 23 7"/><rect x="1" y="5" width="15" height="14" rx="2" ry="2"/></svg>`,
        menu: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>`,
        form: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>`,
        default: `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>`
      };

      function getWidgetIcon(name) {
        if (name.includes('image') || name.includes('gallery') || name.includes('thumb')) return ICONS.image;
        if (name.includes('text') || name.includes('heading') || name.includes('title')) return ICONS.text;
        if (name.includes('button') || name.includes('btn') || name.includes('link')) return ICONS.button;
        if (name.includes('container') || name.includes('section') || name.includes('div')) return ICONS.container;
        if (name.includes('woo') || name.includes('product') || name.includes('cart')) return ICONS.woo;
        if (name.includes('star') || name.includes('rating') || name.includes('review')) return ICONS.star;
        if (name.includes('video') || name.includes('youtube')) return ICONS.video;
        if (name.includes('menu') || name.includes('nav')) return ICONS.menu;
        if (name.includes('form') || name.includes('input')) return ICONS.form;
        return ICONS.default;
      }

      // Dados dos widgets para geracao dinamica
      const WIDGET_DATA = {
        'Basicos': [
          'heading', 'text', 'button', 'image', 'icon', 'video', 'divider', 'spacer', 'image-box', 'icon-box',
          'star-rating', 'counter', 'progress', 'tabs', 'accordion', 'toggle', 'alert', 'social-icons',
          'soundcloud', 'shortcode', 'html', 'menu-anchor', 'sidebar', 'read-more', 'image-carousel',
          'basic-gallery', 'gallery', 'icon-list', 'nav-menu', 'search-form', 'google-maps', 'testimonial',
          'embed', 'lottie', 'loop:grid', 'w:container', 'w:inner-container',
        ],
        'Pro': [
          'form', 'login', 'subscription', 'call-to-action', 'media:carousel', 'portfolio', 'gallery-pro',
          'slider:slides', 'slideshow', 'flip-box', 'animated-headline', 'post-navigation', 'share-buttons',
          'table-of-contents', 'countdown', 'blockquote', 'testimonial-carousel', 'review-box', 'reviews', 'hotspots',
          'sitemap', 'author-box', 'price-table', 'price-list', 'progress-tracker', 'animated-text',
          'nav-menu-pro', 'breadcrumb', 'facebook-button', 'facebook-comments', 'facebook-embed',
          'facebook-page', 'loop:builder', 'loop:grid-advanced', 'loop-carousel', 'post-excerpt',
          'post-content', 'post-title', 'post-info', 'post-featured-image', 'post-author', 'post-date',
          'post-terms', 'archive-title', 'archive-description', 'site-logo', 'site-title', 'site-tagline',
          'search-results', 'global-widget', 'video-playlist', 'video-gallery'
        ],
        'WooCommerce': [
          'woo:product-title', 'woo:product-image', 'woo:product-price', 'woo:product-add-to-cart',
          'woo:product-data-tabs', 'woo:product-excerpt', 'woo:product-rating', 'woo:product-stock',
          'woo:product-meta', 'woo:product-additional-information', 'woo:product-short-description',
          'woo:product-related', 'woo:product-upsells', 'woo:product-tabs', 'woo:product-breadcrumb',
          'woo:product-gallery', 'woo:products', 'woo:product-grid', 'woo:product-carousel',
          'woo:product-loop-item', 'woo:loop-product-title', 'woo:loop-product-price',
          'woo:loop-product-rating', 'woo:loop-product-image', 'woo:loop-product-button',
          'woo:loop-product-meta', 'woo:cart', 'woo:checkout', 'woo:my-account', 'woo:purchase-summary',
          'woo:order-tracking'
        ],
        'Loop Builder': [
          'loop:item', 'loop:image', 'loop:title', 'loop:meta', 'loop:terms', 'loop:rating', 'loop:price',
          'loop:add-to-cart', 'loop:read-more', 'loop:featured-image', 'loop:pagination'
        ],
        'Experimentais': [
          'w:nested-tabs', 'w:mega-menu', 'w:scroll-snap', 'w:motion-effects', 'w:background-slideshow',
          'w:css-transform', 'w:custom-position', 'w:dynamic-tags', 'w:ajax-pagination'
        ],
        'WordPress': [
          'w:wp-search', 'w:wp-recent-posts', 'w:wp-recent-comments', 'w:wp-archives', 'w:wp-categories',
          'w:wp-calendar', 'w:wp-tag-cloud', 'w:wp-custom-menu'
        ],
        'Nomenclatura Hierárquica': [
          // Accordion
          'accordion:item', 'accordion:title', 'accordion:content', 'accordion:icon',
          // Tabs
          'tabs:item', 'tabs:title', 'tabs:content',
          // Icon List
          'list:item', 'list:icon', 'list:text',
          // Carousel
          'slide:1', 'slide:2', 'carousel:slide',
          // Countdown
          'countdown:days', 'countdown:hours', 'countdown:minutes', 'countdown:seconds',
          // Toggle
          'toggle:item', 'toggle:title', 'toggle:content',
        ]
      };

      function renderWidgetList(filterText = '') {
        const container = document.getElementById('widget-list-container');
        if (!container) return;

        const search = filterText.toLowerCase().trim();
        let html = '';

        if (search) {
          html += `<div class="search-status">Filtrando por: "<strong>${search}</strong>"</div>`;
        }

        let hasResults = false;

        for (const [category, items] of Object.entries(WIDGET_DATA)) {
          const filteredItems = items.filter(item => {
            if (!search) return true;
            return item.toLowerCase().includes(search);
          });

          if (filteredItems.length === 0) continue;
          hasResults = true;

          html += `<div class="card compact"><div class="card-title small">${category}</div><div class="help-grid compact">`;

          filteredItems.forEach(item => {
            let fullName = item;
            if (!item.includes(':') && !item.startsWith('w:')) {
              fullName = 'w:' + item;
            }
            const icon = getWidgetIcon(fullName);

            html += `
              <div class="help-item compact" title="${fullName}">
                <div class="item-header">
                  <span class="item-icon">${icon}</span>
                  <span class="label">${fullName}</span>
                </div>
                <button class="btn tiny ghost full-width" data-rename="${fullName}">Aplicar</button>
              </div>`;
          });

          html += `</div></div>`;
        }

        if (!hasResults) {
          html = `<div class="empty-state">Nenhum widget encontrado para "${search}"</div>`;
        }

        container.innerHTML = html;
      }

      renderWidgetList();

      const searchInput = document.getElementById('widget-search');
      if (searchInput) {
        searchInput.addEventListener('input', (e) => {
          renderWidgetList(e.target.value);
        });
      }

      document.body.addEventListener('click', (e) => {
        const btn = e.target.closest('[data-rename]');
        if (btn) {
          const name = btn.getAttribute('data-rename');
          send('rename-layer', { name });
        }
      });

      // Linter Logic
      const linterPanel = document.getElementById('linter-panel');
      const linterSummary = document.getElementById('linter-summary');
      const linterIssues = document.getElementById('linter-issues');
      const btnAnalyze = document.getElementById('btn_analyze');
      const btnCloseLinter = document.getElementById('btn_close_linter');

      if (btnAnalyze) {
        btnAnalyze.onclick = () => {
          send('analyze-layout');
          addLog('Iniciando análise de layout...', 'info');
        };
      }

      if (btnCloseLinter) {
        btnCloseLinter.onclick = () => {
          if (linterPanel) linterPanel.style.display = 'none';
        };
      }

      /**
       * renderLinterReport - Renderiza o relatório do Linter na UI
       * 
       * Esta função consome o objeto `report` enviado pelo backend e atualiza
       * todos os elementos da UI de forma segura, com checagens de null.
       * Segue os IDs padronizados definidos no PRD.
       * 
       * @param {Object} report - { summary, analysis, widgets, guides, metadata }
       */
      function renderLinterReport(report) {
        console.log('[UI] renderLinterReport - report recebido', report);

        // ====== Guard: report nulo/undefined ======
        if (!report) {
          console.warn('[UI] renderLinterReport: report é null/undefined');
          return;
        }

        // ====== Obter elementos da UI pelos IDs padronizados ======
        const scoreEl = document.getElementById('linter-score-value');
        const statusEl = document.getElementById('linter-status-badge');
        const summaryTextEl = document.getElementById('linter-summary-text');
        const criticalEl = document.getElementById('linter-critical-count');
        const warningEl = document.getElementById('linter-warning-count');
        const infoEl = document.getElementById('linter-info-count');
        const okEl = document.getElementById('linter-ok-count');
        const issuesBodyEl = document.getElementById('linter-issues-body');
        const scoreRingEl = document.getElementById('score-ring-v2');
        const topProblemsList = document.getElementById('top-problems-list');

        // Elementos opcionais de logs
        const logsContentEl = document.getElementById('linter-logs-content');
        const logsCopyBtn = document.getElementById('linter-logs-copy');
        const logsClearBtn = document.getElementById('linter-logs-clear');

        // ====== Guard Clause: elementos críticos ======
        if (!scoreEl || !statusEl || !issuesBodyEl) {
          console.warn('[UI] Linter UI não encontrada. Verifique IDs no HTML.', {
            scoreEl: !!scoreEl,
            statusEl: !!statusEl,
            issuesBodyEl: !!issuesBodyEl
          });
          return;
        }

        // ====== Store report globally for copy button ======
        window.__linterLastReport = report;

        // ====== Extrair dados do report - FIX: ler de múltiplos paths possíveis ======
        const summary = report.summary || {};
        const analysis = report.analysis || [];

        // Tentar ler contadores diretamente do summary (conforme contrato do backend)
        // Fallback: calcular a partir da análise se não existir
        let criticalCount = 0;
        let warningCount = 0;
        let infoCount = 0;
        let okCount = 0;

        // Primeiro: tentar ler do summary direto (backend novo)
        if (typeof summary.critical === 'number' || typeof summary.warning === 'number') {
          criticalCount = summary.critical || 0;
          warningCount = summary.warning || 0;
          infoCount = summary.info || 0;
          okCount = summary.ok || 0;
        }
        // Segundo: tentar ler de summary.counts ou summary.by_severity (formato antigo)
        else if (summary.counts || summary.by_severity) {
          const counts = summary.by_severity || summary.counts || {};
          criticalCount = counts.critical || 0;
          warningCount = counts.major || counts.warning || 0;
          infoCount = counts.minor || counts.info || 0;
          okCount = counts.ok || 0;
        }
        // Terceiro: calcular a partir do array analysis
        else if (analysis.length > 0) {
          analysis.forEach(issue => {
            const sev = (issue.severity || '').toLowerCase();
            if (sev === 'critical') criticalCount++;
            else if (sev === 'major' || sev === 'warning') warningCount++;
            else if (sev === 'minor' || sev === 'info') infoCount++;
            else if (sev === 'ok') okCount++;
          });
        }

        const totalIssues = summary.totalIssues || summary.total || analysis.length;
        const totalNodes = report.metadata?.total_nodes || report.metadata?.totalNodes || report.widgets?.length || 0;

        console.log('[UI] Contadores extraídos:', { criticalCount, warningCount, infoCount, okCount, totalIssues, totalNodes });

        // ====== Calcular score ======
        const score = report.summary?.score !== undefined
          ? Math.round(report.summary.score)
          : Math.max(0, 100 - (criticalCount * 15) - (warningCount * 5) - (infoCount * 1));

        // ====== Determinar status ======
        let status = report.summary?.status || 'warning';
        if (criticalCount > 0) status = 'critical';
        else if (warningCount > 0) status = 'warning';
        else if (totalIssues === 0) status = 'ok';

        // ====== Preencher Score ======
        scoreEl.textContent = String(score);

        // Atualizar anel de score se existir
        if (scoreRingEl) {
          scoreRingEl.classList.remove('success', 'warning', 'critical');
          if (score >= 80) scoreRingEl.classList.add('success');
          else if (score >= 40) scoreRingEl.classList.add('warning');
          else scoreRingEl.classList.add('critical');
        }

        // ====== Preencher Status Badge ======
        statusEl.classList.remove('ok', 'warning', 'critical');
        let statusLabel = 'ATENÇÃO';
        let statusIcon = '!';
        if (status === 'ok') {
          statusLabel = 'OK';
          statusIcon = '✓';
          statusEl.classList.add('ok');
        } else if (status === 'critical') {
          statusLabel = 'CRÍTICO';
          statusIcon = '✕';
          statusEl.classList.add('critical');
        } else {
          statusEl.classList.add('warning');
        }
        statusEl.innerHTML = `<span class="badge-icon">${statusIcon}</span> ${statusLabel}`;

        // ====== Preencher Contadores ======
        if (criticalEl) criticalEl.textContent = String(criticalCount);
        if (warningEl) warningEl.textContent = String(warningCount);
        if (infoEl) infoEl.textContent = String(infoCount);
        if (okEl) okEl.textContent = String(okCount);

        // ====== Preencher Texto Resumo ======
        if (summaryTextEl) {
          if (totalIssues === 0) {
            summaryTextEl.textContent = 'Excelente! Seu layout está seguindo todas as boas práticas. Pronto para exportar!';
          } else if (criticalCount > 0) {
            summaryTextEl.textContent = `Encontramos ${totalIssues} problema(s), sendo ${criticalCount} crítico(s). Corrija antes de exportar.`;
          } else if (warningCount > 0) {
            summaryTextEl.textContent = `Quase lá! ${totalIssues} item(s) de atenção para revisar.`;
          } else {
            summaryTextEl.textContent = `Análise concluída: ${totalIssues} sugestão(ões) em ${totalNodes} elementos analisados.`;
          }
        }

        // ====== Renderizar Top 3 Problemas Preview ======
        if (topProblemsList) {
          const issues = report.analysis || [];
          if (issues.length === 0) {
            topProblemsList.innerHTML = '<p style="color: var(--color-success);">✅ Nenhum problema encontrado!</p>';
          } else {
            const top3 = issues.slice(0, 3);
            topProblemsList.innerHTML = top3.map(issue => {
              const icon = issue.severity === 'critical' ? '🔴' :
                issue.severity === 'major' ? '🟠' : '🔵';
              const title = (issue.message || 'Problema detectado').split('.')[0];
              return `<div style="padding: 6px 0; border-bottom: 1px solid var(--color-border);">
                ${icon} <strong>${title}</strong>
              </div>`;
            }).join('');
          }
        }

        // ====== Renderizar Tabela de Issues ======
        issuesBodyEl.innerHTML = '';
        const issues = report.analysis || [];

        // Populate global cache for filtering (used by filters/search)
        window.__linterAnalysisCache = issues;
        if (typeof allIssuesData !== 'undefined') {
          allIssuesData = issues.map(issue => ({
            ...issue,
            nodeName: issue.node_name || issue.nodeName || '',
            nodeId: issue.node_id || issue.nodeId || '',
            category: (issue.rule || issue.category || 'geral').toLowerCase()
          }));
        }

        if (issues.length === 0) {
          const emptyRow = document.createElement('tr');
          emptyRow.innerHTML = `
            <td colspan="3" style="text-align: center; padding: 24px; color: var(--color-text-secondary);">
              ✨ Nenhum problema encontrado. Seu layout está ótimo!
            </td>
          `;
          issuesBodyEl.appendChild(emptyRow);
        } else {
          issues.forEach((issue, idx) => {
            const tr = document.createElement('tr');
            tr.style.cursor = 'pointer';
            tr.style.transition = 'background 0.15s';
            const nodeId = issue.node_id || issue.nodeId || '';
            const nodeName = issue.node_name || issue.nodeName || '(sem nome)';
            tr.dataset.nodeId = nodeId;
            tr.dataset.issueIdx = idx;
            tr.onmouseover = () => { if (!tr.classList.contains('linter-issue--active')) tr.style.background = 'var(--color-bg-secondary)'; };
            tr.onmouseout = () => { if (!tr.classList.contains('linter-issue--active')) tr.style.background = ''; };

            // Severidade
            const tdSeverity = document.createElement('td');
            tdSeverity.style.padding = '8px';
            const severityIcon = issue.severity === 'critical' ? '🔴' :
              issue.severity === 'major' || issue.severity === 'warning' ? '🟠' : '🔵';
            const severityLabel = issue.severity === 'critical' ? 'Crítico' :
              issue.severity === 'major' || issue.severity === 'warning' ? 'Atenção' : 'Info';
            tdSeverity.innerHTML = `${severityIcon} ${severityLabel}`;

            // Categoria
            const tdCategory = document.createElement('td');
            tdCategory.style.padding = '8px';
            const category = issue.rule || issue.category || 'geral';
            const categoryShort = category.includes('auto-layout') ? 'Auto Layout' :
              category.includes('naming') ? 'Nomenclatura' :
                category.includes('widget') ? 'Widgets' :
                  category.includes('image') ? 'Imagens' : 'Estrutura';
            tdCategory.textContent = categoryShort;

            // Descrição (nodeName + message + inline rename controls if widget-naming)
            const tdDesc = document.createElement('td');
            tdDesc.style.padding = '8px';
            const message = issue.message || '';

            // Extract naming suggestions for inline controls
            const naming = issue.naming || {};
            const recommendedName = naming.recommendedName || issue.widgetType || '';
            const alternatives = naming.alternatives || [];
            const hasNamingSuggestion = !!recommendedName && !!nodeId;
            const isNamingIssue = issue.rule === 'widget-naming' || (issue.category || '').includes('naming');

            // Build rename options
            const renameOptions = [];
            if (recommendedName) renameOptions.push(recommendedName);
            alternatives.forEach(alt => {
              if (alt && !renameOptions.includes(alt)) renameOptions.push(alt);
            });

            // Build inline rename controls HTML
            let inlineRenameHtml = '';
            if (isNamingIssue && hasNamingSuggestion) {
              inlineRenameHtml = `
                <div class="inline-rename-row" style="margin-top: 8px; display: flex; align-items: center; gap: 8px; padding: 6px 8px; background: rgba(59, 130, 246, 0.08); border-radius: 4px; border: 1px solid rgba(59, 130, 246, 0.2);">
                  <select class="rename-select-inline" data-node-id="${nodeId}" style="flex: 1; padding: 5px 6px; border: 1px solid var(--color-border); border-radius: 4px; font-size: 11px; background: var(--color-panel); color: var(--color-text); cursor: pointer;">
                    ${renameOptions.map((name, i) => `<option value="${name}" ${i === 0 ? 'selected' : ''}>${name}</option>`).join('')}
                  </select>
                  <button class="btn-rename-row" data-node-id="${nodeId}" style="padding: 5px 10px; font-size: 11px; background: var(--color-primary, #3b82f6); color: white; border: none; border-radius: 4px; cursor: pointer; white-space: nowrap;">
                    ✏️ Renomear
                  </button>
                </div>
              `;
            } else if (isNamingIssue && !hasNamingSuggestion) {
              inlineRenameHtml = `<div style="margin-top: 6px; font-size: 10px; color: var(--color-text-secondary);">Nenhuma sugestão disponível</div>`;
            }

            tdDesc.innerHTML = `<strong>${nodeName}</strong><br><span style="color: var(--color-text-secondary); font-size: 11px;">${message}</span>${inlineRenameHtml}`;

            // Setup inline rename handlers (after appending to prevent multiple bindings)
            const renameSelect = tdDesc.querySelector('.rename-select-inline');
            const renameBtn = tdDesc.querySelector('.btn-rename-row');
            if (renameSelect && renameBtn) {
              // Stop propagation on select and button to prevent row click
              renameSelect.addEventListener('click', e => e.stopPropagation());
              renameBtn.addEventListener('click', e => {
                e.stopPropagation();
                const newName = renameSelect.value;
                const targetNodeId = renameBtn.dataset.nodeId;
                if (newName && targetNodeId) {
                  renameBtn.disabled = true;
                  renameBtn.textContent = '⏳...';
                  send('linter-rename-node', { nodeId: targetNodeId, newName });
                  console.log('[UI] Table inline rename:', targetNodeId, '→', newName);
                }
              });
            }

            tr.appendChild(tdSeverity);
            tr.appendChild(tdCategory);
            tr.appendChild(tdDesc);

            // Click handler: highlight + select node
            tr.addEventListener('click', () => {
              // 1) Remove highlight from all rows, add to this one
              document.querySelectorAll('#linter-issues-body tr').forEach(row => {
                row.classList.remove('linter-issue--active');
                row.style.background = '';
              });
              tr.classList.add('linter-issue--active');

              // 2) Send message to select node in Figma
              if (nodeId) {
                send('select-node', { nodeId });
                console.log('[UI] Selecionando node:', nodeId, nodeName);
              }
            });

            issuesBodyEl.appendChild(tr);
          });
        }

        // ====== Preencher Logs (se existir) ======
        if (logsContentEl) {
          try {
            logsContentEl.value = JSON.stringify(report, null, 2);
          } catch (e) {
            logsContentEl.value = '[Erro ao serializar relatório]';
            console.warn('[UI] Erro ao serializar logs:', e);
          }
        }

        // ====== Conectar botões de logs ======
        if (logsCopyBtn && logsContentEl) {
          logsCopyBtn.onclick = () => {
            copyToClipboardSafe(logsContentEl.value || '', 'Logs copiados para a área de transferência!');
          };
        }

        if (logsClearBtn && logsContentEl) {
          logsClearBtn.onclick = () => {
            logsContentEl.value = '';
            addLog('Visualização de logs limpa.', 'info');
          };
        }

        // ====== Conectar botão Copiar Relatório (btn-copy-report-v2) ======
        const copyReportBtn = document.getElementById('btn-copy-report-v2');
        if (copyReportBtn) {
          copyReportBtn.onclick = () => {
            if (!window.__linterLastReport) {
              addLog('Nenhum relatório para copiar. Execute a análise primeiro.', 'warn');
              return;
            }
            const text = JSON.stringify(window.__linterLastReport, null, 2);
            copyToClipboardSafe(text, 'Relatório copiado para a área de transferência!');
          };
        }

        console.log('[UI] renderLinterReport concluído com sucesso');
      }

      /**
       * copyToClipboardSafe - Copy text to clipboard with fallback
       * @param {string} text - Text to copy
       * @param {string} successMessage - Message to show on success
       */
      function copyToClipboardSafe(text, successMessage) {
        if (!text) {
          addLog('Nada para copiar.', 'warn');
          return;
        }

        // Try modern clipboard API
        if (navigator && navigator.clipboard && typeof navigator.clipboard.writeText === 'function') {
          navigator.clipboard.writeText(text)
            .then(() => {
              addLog(successMessage || 'Copiado!', 'success');
              console.log('[UI] Texto copiado via navigator.clipboard');
            })
            .catch(err => {
              console.warn('[UI] navigator.clipboard falhou, tentando fallback:', err);
              copyFallback(text, successMessage);
            });
        } else {
          // Fallback for older browsers or restricted contexts
          copyFallback(text, successMessage);
        }
      }

      function copyFallback(text, successMessage) {
        try {
          const textarea = document.createElement('textarea');
          textarea.value = text;
          textarea.style.position = 'fixed';
          textarea.style.left = '-9999px';
          textarea.style.top = '0';
          document.body.appendChild(textarea);
          textarea.focus();
          textarea.select();

          const success = document.execCommand('copy');
          document.body.removeChild(textarea);

          if (success) {
            addLog(successMessage || 'Copiado!', 'success');
            console.log('[UI] Texto copiado via execCommand fallback');
          } else {
            addLog('Falha ao copiar. Tente selecionar e copiar manualmente.', 'error');
          }
        } catch (err) {
          console.error('[UI] Fallback de cópia falhou:', err);
          addLog('Não foi possível copiar. Copie manualmente.', 'error');
        }
      }

      // ========== PROBLEM DETAILS PANEL LOGIC ==========

      let currentProblemIndex = -1;
      let currentReport = null;

      function showProblemDetails(issue, index, report) {
        currentProblemIndex = index;
        currentReport = report;

        const panel = document.getElementById('problem-details-panel');
        const content = document.getElementById('problem-details-content');

        if (!panel || !content) return;

        // Seleciona o node no Figma
        send('select-problem-node', { nodeId: issue.node_id });

        // Gera o guia passo-a-passo baseado na regra
        const guide = generateGuideForRule(issue.rule, issue);

        // Check if this is a naming issue and extract suggested name


        const isNamingIssue = issue.rule === 'widget-naming' || issue.rule === 'generic-name-detected';


        let suggestedName = '';


        if (isNamingIssue) {


          const match = issue.message.match(/"([^"]+)"/);


          if (match) suggestedName = match[1];


        }



        // Renderiza o conteúdo do painel
        content.innerHTML = `
          <div class="problem-header">
            <div class="problem-severity ${issue.severity}">
              ${getSeverityIcon(issue.severity)} ${getSeverityLabel(issue.severity)}
            </div>
            <div class="problem-title">${issue.message}</div>
          </div>

          <div class="problem-location">
            📍 <strong>Localização:</strong> ${issue.node_name} (${issue.node_id})
          </div>

          ${isNamingIssue && suggestedName ? `
            <div style="margin: 12px 0;">
              <button id="btn-auto-rename" class="btn primary small" style="width: 100%;">
                âœ¨ Renomear para "${suggestedName}"
              </button>
            </div>
          ` : ''}

          

          <div class="problem-guide">
            <h4>✅ COMO CORRIGIR (⏱️ ${guide.estimated_time}):</h4>
            <ol class="guide-steps">
              ${guide.steps.map((step, i) => `
                <li>
                  <span class="step-number">${i + 1}</span>
                  <span class="step-action">${step}</span>
                </li>
              `).join('')
          }
            </ol >
        
          </div >
        `;

        // Mostra o painel
        panel.style.display = 'block';

        // Scroll para o painel
        panel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });



        // Add handler for auto-rename button


        if (isNamingIssue && suggestedName) {


          const btnAutoRename = document.getElementById('btn-auto-rename');


          if (btnAutoRename) {


            btnAutoRename.onclick = () => {


              send('rename-layer', { nodeId: issue.node_id, name: suggestedName });


              addLog(`Renomeando para "${suggestedName}"...`, 'info');


            };


          }


        }
      }

      function getSeverityIcon(severity) {
        const icons = {
          critical: '🔴',
          major: '🟡',
          minor: '🔵',
          info: 'ℹ️'
        };
        return icons[severity] || '⚠️';
      }

      function getSeverityLabel(severity) {
        const labels = {
          critical: 'Crítico',
          major: 'Importante',
          minor: 'Menor',
          info: 'Informação'
        };
        return labels[severity] || severity;
      }

      function getDifficultyLabel(difficulty) {
        const labels = {
          easy: 'Fácil',
          medium: 'Médio',
          hard: 'Difícil'
        };
        return labels[difficulty] || difficulty;
      }

      function generateGuideForRule(ruleId, issue) {
        // Mapeamento de regras para guias passo-a-passo
        const guides = {
          'auto-layout-required': {
            steps: [
              'Selecione o frame',
              'Pressione Shift + A',
              'Configure direÃ§Ã£o e espaÃ§amento'
            ]
          },
          'spacer-detected': {
            steps: [
              'Selecione o frame pai',
              'Aumente o Gap',
              'Delete o spacer'
            ]
          },
          'generic-name-detected': {
            steps: [
              'Use o botÃ£o "Renomear" acima',
              'Ou clique 2x no nome da camada'
            ]
          },
          'widget-naming': {
            steps: [
              'Use o botÃ£o "Renomear" acima',
              'Ou clique 2x no nome da camada'
            ]
          }
        };

        return guides[ruleId] || {
          steps: ['Corrija manualmente no Figma']
        };
      }

      // Handlers dos botões do painel
      const btnCloseDetails = document.getElementById('btn-close-details');
      const btnMarkResolved = document.getElementById('btn-mark-resolved');
      const btnNextProblem = document.getElementById('btn-next-problem');
      const btnIgnoreProblem = document.getElementById('btn-ignore-problem');

      if (btnCloseDetails) {
        btnCloseDetails.onclick = () => {
          const panel = document.getElementById('problem-details-panel');
          if (panel) panel.style.display = 'none';
        };
      }

      if (btnMarkResolved) {
        btnMarkResolved.onclick = () => {
          if (currentReport && currentProblemIndex >= 0) {
            const issue = currentReport.analysis[currentProblemIndex];
            send('mark-problem-resolved', { nodeId: issue.node_id });
            addLog('Validando correção...', 'info');
          }
        };
      }

      if (btnNextProblem) {
        btnNextProblem.onclick = () => {
          if (currentReport && currentProblemIndex < currentReport.analysis.length - 1) {
            const nextIndex = currentProblemIndex + 1;
            showProblemDetails(currentReport.analysis[nextIndex], nextIndex, currentReport);
          } else {
            addLog('Você chegou ao último problema!', 'info');
          }
        };
      }

      if (btnIgnoreProblem) {
        btnIgnoreProblem.onclick = () => {
          const panel = document.getElementById('problem-details-panel');
          if (panel) panel.style.display = 'none';
          addLog('Problema ignorado', 'info');
        };
      }

      // ========== LINTER UI v2 LOGIC ==========

      // Sub-tabs navigation
      const linterSubtabBtns = document.querySelectorAll('.linter-subtab-btn');
      const linterSubpanels = document.querySelectorAll('.linter-subpanel');

      function switchLinterSubtab(targetId) {
        linterSubtabBtns.forEach(btn => {
          btn.classList.toggle('active', btn.dataset.subtab === targetId);
        });
        linterSubpanels.forEach(panel => {
          panel.classList.toggle('active', panel.dataset.subpanel === targetId);
        });
      }

      linterSubtabBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          switchLinterSubtab(btn.dataset.subtab);
        });
      });

      // Filter chips
      let currentSeverityFilter = 'all';
      let currentCategoryFilter = 'all';
      let allIssuesData = []; // Store all issues for filtering

      document.querySelectorAll('[data-filter-severity]').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('[data-filter-severity]').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentSeverityFilter = btn.dataset.filterSeverity;
          renderFilteredIssues();
        });
      });

      document.querySelectorAll('[data-filter-category]').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('[data-filter-category]').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentCategoryFilter = btn.dataset.filterCategory;
          renderFilteredIssues();
        });
      });

      // Search with PRD ID: linter-search-input
      const linterSearchInput = document.getElementById('linter-search-input');
      let searchDebounceTimer = null;
      if (linterSearchInput) {
        linterSearchInput.addEventListener('input', () => {
          clearTimeout(searchDebounceTimer);
          searchDebounceTimer = setTimeout(() => {
            renderFilteredIssues();
          }, 200);
        });
      }

      function renderFilteredIssues() {
        const searchTerm = (linterSearchInput?.value || '').toLowerCase();
        const filtered = allIssuesData.filter(issue => {
          // Map severity: 'major' -> 'warning' for consistency
          const normalizedSeverity = issue.severity === 'major' ? 'warning' : issue.severity;
          const matchesSeverity = currentSeverityFilter === 'all' || normalizedSeverity === currentSeverityFilter;

          // Map category from rule field
          const category = (issue.rule || issue.category || '').toLowerCase();
          const matchesCategory = currentCategoryFilter === 'all' || category.includes(currentCategoryFilter);

          // Search by nodeName and message
          const nodeName = issue.node_name || issue.nodeName || '';
          const message = issue.message || '';
          const matchesSearch = !searchTerm ||
            nodeName.toLowerCase().includes(searchTerm) ||
            message.toLowerCase().includes(searchTerm);
          return matchesSeverity && matchesCategory && matchesSearch;
        });
        renderIssuesListV2(filtered);
      }

      function renderIssuesListV2(issues) {
        const container = document.getElementById('issues-list-v2');
        const emptyState = document.getElementById('issues-empty-state');

        if (!container) return;

        container.innerHTML = '';

        if (issues.length === 0) {
          container.innerHTML = `
            <div class="linter-empty-state">
              <div class="empty-icon">✨</div>
              <h3 style="font-size: 14px; margin: 8px 0;">Nenhum problema encontrado</h3>
              <p style="font-size: 12px; margin: 0;">Seu layout parece estar seguindo todas as boas práticas!</p>
            </div>`;
          return;
        }

        issues.forEach((issue, idx) => {
          const severityIcon = issue.severity === 'critical' ? '🔴' :
            issue.severity === 'warning' ? '🟠' : '🔵';
          const card = document.createElement('div');
          card.className = `issue-card-v2 ${issue.severity}`;
          card.dataset.issueIdx = idx;
          card.dataset.nodeId = issue.node_id || issue.nodeId || '';
          const nodeId = issue.node_id || issue.nodeId || '';
          const nodeName = issue.nodeName || issue.node_name || 'Node';

          // Extract naming suggestions
          const naming = issue.naming || {};
          const recommendedName = naming.recommendedName || issue.widgetType || '';
          const alternatives = naming.alternatives || [];
          const hasNamingSuggestion = !!recommendedName;

          // Build rename options for dropdown
          const renameOptions = [];
          if (recommendedName) renameOptions.push(recommendedName);
          alternatives.forEach(alt => {
            if (alt && !renameOptions.includes(alt)) renameOptions.push(alt);
          });

          // Build inline rename controls for naming issues
          let inlineRenameHtml = '';
          if (hasNamingSuggestion && nodeId) {
            inlineRenameHtml = `
              <div class="issue-rename-controls" style="margin-top: 8px; padding: 8px 10px; background: rgba(59, 130, 246, 0.08); border-radius: 6px; border: 1px solid rgba(59, 130, 246, 0.2);">
                <div style="display: flex; align-items: center; gap: 8px;">
                  <select class="rename-select" data-node-id="${nodeId}" style="flex: 1; padding: 6px 8px; border: 1px solid var(--color-border); border-radius: 4px; font-size: 11px; background: var(--color-panel); color: var(--color-text); cursor: pointer;">
                    ${renameOptions.map((name, i) => `<option value="${name}" ${i === 0 ? 'selected' : ''}>${name}</option>`).join('')}
                  </select>
                  <button class="btn-rename-inline" data-node-id="${nodeId}" style="padding: 6px 12px; font-size: 11px; background: var(--color-primary, #3b82f6); color: white; border: none; border-radius: 4px; cursor: pointer; white-space: nowrap;">
                    ✏️ Renomear
                  </button>
                </div>
                ${alternatives.length > 0 ? `<div style="font-size: 10px; color: var(--color-text-secondary); margin-top: 4px;">${alternatives.length} alternativa(s) disponível(is)</div>` : ''}
              </div>
            `;
          } else if (issue.rule === 'widget-naming' || (issue.category || '').includes('naming')) {
            // Naming issue but no suggestion available
            inlineRenameHtml = `
              <div class="issue-naming-suggestion" style="margin-top: 6px; padding: 6px 8px; background: rgba(100,100,100,0.1); border-radius: 4px; font-size: 11px; color: var(--color-text-secondary);">
                Nenhuma sugestão disponível
              </div>
            `;
          }

          card.innerHTML = `
            <span class="issue-icon">${severityIcon}</span>
            <div class="issue-content" style="flex: 1;">
              <div class="issue-title-row">
                <span class="issue-title-v2">${issue.title || issue.message}</span>
                <span class="issue-category-chip">${issue.category || 'geral'}</span>
              </div>
              <div class="issue-summary">${issue.summary || issue.message}</div>
              <div class="issue-node-info">📍 ${nodeName}</div>
              ${inlineRenameHtml}
            </div>
          `;

          // Prevent card click from firing when clicking on rename controls
          const renameControls = card.querySelector('.issue-rename-controls');
          if (renameControls) {
            renameControls.addEventListener('click', (e) => e.stopPropagation());
          }

          // Setup inline rename button handler
          const renameBtn = card.querySelector('.btn-rename-inline');
          const renameSelect = card.querySelector('.rename-select');
          if (renameBtn && renameSelect) {
            renameBtn.addEventListener('click', (e) => {
              e.stopPropagation();
              const newName = renameSelect.value;
              const targetNodeId = renameBtn.dataset.nodeId;
              if (newName && targetNodeId) {
                renameBtn.disabled = true;
                renameBtn.textContent = '⏳...';
                send('linter-rename-node', { nodeId: targetNodeId, newName });
                console.log('[UI] Inline rename:', targetNodeId, '→', newName);
              }
            });
          }

          // Card click handler for select node
          card.addEventListener('click', () => {
            // Visual highlight
            document.querySelectorAll('.issue-card-v2').forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');

            // Send message to select node in Figma
            if (nodeId) {
              send('select-node', { nodeId });
              console.log('[UI] Card click - selecionando node:', nodeId, nodeName);
            }
          });
          container.appendChild(card);
        });
      }

      /**
     * setLinterStatus - Show feedback message in the Linter status bar
     * @param {'success' | 'error' | 'warning'} state - Status type
     * @param {string} message - Message to display (with emoji prefix)
     */
      function setLinterStatus(state, message) {
        const statusBar = document.getElementById('linter-status-bar');
        const statusIcon = document.getElementById('linter-status-icon');
        const statusText = document.getElementById('linter-status-message');

        if (!statusBar) {
          console.warn('[LINTER/UI] Status bar element not found');
          return;
        }

        // Remove hidden class and previous state classes
        statusBar.classList.remove('hidden', 'linter-status-bar--success', 'linter-status-bar--warning', 'linter-status-bar--error');

        // Add new state class
        statusBar.classList.add(`linter-status-bar--${state}`);

        // Update icon
        if (statusIcon) {
          const icons = { success: '✅', warning: '⚠️', error: '❌' };
          statusIcon.textContent = icons[state] || '';
        }

        // Update message (remove emoji prefix since it's already in the message)
        if (statusText) {
          statusText.textContent = message.replace(/^[✅❌⚠️]\s*/, '');
        }

        // Auto-hide after 8 seconds
        setTimeout(() => {
          if (statusBar) {
            statusBar.classList.add('hidden');
          }
        }, 8000);

        console.log(`[LINTER/UI] Status: ${state} - ${message}`);
      }

      /**
       * Highlight active issue row in table
       * @param {string|null} nodeId - Node ID to highlight, or null to clear
       */
      function highlightActiveIssue(nodeId) {
        // Clear previous highlights
        document.querySelectorAll('.linter-issue--active').forEach(el => {
          el.classList.remove('linter-issue--active');
        });

        if (!nodeId) return;

        // Find and highlight the row with matching nodeId
        const rows = document.querySelectorAll('#linter-issues-body tr[data-node-id]');
        rows.forEach(row => {
          if (row.dataset.nodeId === nodeId) {
            row.classList.add('linter-issue--active');
          }
        });
      }

      /**
       * updateDetailsPanelV2 - Update the action panel with issue information and rename options
       * Called when clicking on an issue card
       * @param {Object} issue - Issue object with message, naming, etc.
       */
      let currentSelectedIssue = null; // Store for rename handler

      function updateDetailsPanelV2(issue) {
        currentSelectedIssue = issue;
        const panel = document.getElementById('details-panel-v2');

        if (!panel) {
          console.log('[UI] Panel details-panel-v2 não encontrado');
          return;
        }

        // Extract data with fallbacks
        const nodeName = issue.node_name || issue.nodeName || '—';
        const nodeId = issue.node_id || issue.nodeId || '';
        const nodeType = issue.node_type || issue.nodeType || '—';
        const message = issue.message || 'Problema detectado';

        // Extract naming suggestions
        const naming = issue.naming || {};
        const recommendedName = naming.recommendedName || issue.widgetType || '';
        const alternatives = naming.alternatives || [];
        const hasNamingSuggestion = !!recommendedName;

        // Build rename options for dropdown
        const renameOptions = [];
        if (recommendedName) renameOptions.push(recommendedName);
        alternatives.forEach(alt => {
          if (alt && !renameOptions.includes(alt)) renameOptions.push(alt);
        });

        // Update panel HTML with action-focused layout
        panel.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
            <h4 style="margin: 0; font-size: 13px; font-weight: 600;">🎯 Ações Rápidas</h4>
            <button onclick="this.closest('#details-panel-v2').style.display='none'" style="background: none; border: none; cursor: pointer; font-size: 16px;">×</button>
          </div>
          
          <div style="margin-bottom: 12px;">
            <label style="font-size: 11px; color: var(--color-text-secondary); display: block; margin-bottom: 4px;">Nome Atual</label>
            <div id="details-current-name" style="font-weight: 600; font-size: 13px; padding: 6px 10px; background: var(--color-bg-secondary); border-radius: 4px;">${nodeName}</div>
          </div>
          
          ${hasNamingSuggestion ? `
            <div style="margin-bottom: 12px;">
              <label style="font-size: 11px; color: var(--color-text-secondary); display: block; margin-bottom: 4px;">Renomear para</label>
              <div style="display: flex; gap: 8px;">
                <select id="details-rename-select" style="flex: 1; padding: 8px; border: 1px solid var(--color-border); border-radius: 4px; font-size: 12px; background: var(--color-panel);">
                  ${renameOptions.map((name, i) => `<option value="${name}" ${i === 0 ? 'selected' : ''}>${name}</option>`).join('')}
                </select>
                <button id="details-rename-apply" class="btn btn-primary" style="padding: 8px 12px; font-size: 11px; white-space: nowrap;">
                  ✏️ Renomear
                </button>
              </div>
              ${alternatives.length > 0 ? `<div style="font-size: 10px; color: var(--color-text-secondary); margin-top: 4px;">${alternatives.length} alternativa(s) disponível(is)</div>` : ''}
            </div>
          ` : ''}
          
          <div style="display: flex; gap: 8px; margin-bottom: 12px;">
            <button id="btn-select-node-v2" class="btn btn-secondary" style="flex: 1; padding: 8px 12px; font-size: 11px;" ${!nodeId ? 'disabled' : ''}>
              🎯 Selecionar no Figma
            </button>
          </div>
          
          <div style="font-size: 10px; color: var(--color-text-secondary); padding-top: 8px; border-top: 1px solid var(--color-border);">
            <div id="details-tech-info">Node: ${nodeName} | ID: ${nodeId || '—'}</div>
          </div>
        `;

        // Setup rename button handler
        const renameBtn = document.getElementById('details-rename-apply');
        const renameSelect = document.getElementById('details-rename-select');
        if (renameBtn && renameSelect && nodeId) {
          renameBtn.onclick = () => {
            const newName = renameSelect.value;
            if (newName && nodeId) {
              renameBtn.disabled = true;
              renameBtn.textContent = '⏳ Renomeando...';
              send('linter-rename-node', { nodeId, newName });
              console.log('[UI] Enviando rename:', nodeId, '→', newName);
            }
          };
        }

        // Setup select button handler
        const selectBtn = document.getElementById('btn-select-node-v2');
        if (selectBtn && nodeId) {
          selectBtn.onclick = () => {
            send('select-node', { nodeId });
            setLinterStatus('success', '✅ Elemento selecionado no Figma.');
          };
        }

        // Show panel
        panel.classList.add('visible');
        panel.style.display = 'block';

        console.log('[UI] Action panel atualizado para:', nodeName, hasNamingSuggestion ? `(sugestão: ${recommendedName})` : '(sem sugestão)');
      }

      /**
       * resetLinterUI - Reset the Linter UI to initial state before reanalyze
       * Called when clicking 'Reanalisar' button
       */
      function resetLinterUI() {
        console.log('[UI] Resetando Linter UI...');

        // Reset score
        const scoreEl = document.getElementById('linter-score-value');
        if (scoreEl) scoreEl.textContent = '--';

        // Reset ring color
        const scoreRing = document.getElementById('score-ring-v2');
        if (scoreRing) {
          scoreRing.classList.remove('success', 'warning', 'critical');
        }

        // Reset status badge
        const statusEl = document.getElementById('linter-status-badge');
        if (statusEl) {
          statusEl.classList.remove('ok', 'warning', 'critical');
          statusEl.classList.add('warning');
          statusEl.innerHTML = '<span class="badge-icon">⏳</span> ANALISANDO...';
        }

        // Reset summary text
        const summaryText = document.getElementById('linter-summary-text');
        if (summaryText) summaryText.textContent = 'Analisando layout selecionado...';

        // Reset counters
        ['linter-critical-count', 'linter-warning-count', 'linter-info-count', 'linter-ok-count'].forEach(id => {
          const el = document.getElementById(id);
          if (el) el.textContent = '--';
        });

        // Clear issues table
        const issuesBody = document.getElementById('linter-issues-body');
        if (issuesBody) {
          issuesBody.innerHTML = `
            <tr>
              <td colspan="3" style="text-align: center; padding: 24px; color: var(--color-text-secondary);">
                ⏳ Analisando layout... Por favor aguarde.
              </td>
            </tr>
          `;
        }

        // Clear top problems preview
        const topProblems = document.getElementById('top-problems-list');
        if (topProblems) {
          topProblems.innerHTML = '<p style="color: var(--color-text-secondary);">⏳ Analisando...</p>';
        }

        // Hide details panel
        const detailsPanel = document.getElementById('details-panel-v2');
        if (detailsPanel) {
          detailsPanel.classList.remove('visible');
          detailsPanel.style.display = 'none';
        }

        // Clear logs
        const logsContent = document.getElementById('linter-logs-content');
        if (logsContent) logsContent.value = '';

        // Clear global cache
        window.__linterLastReport = null;
        window.__linterAnalysisCache = [];
        if (typeof allIssuesData !== 'undefined') {
          allIssuesData = [];
        }
      }

      function showDetailsV2(issue) {
        const panel = document.getElementById('details-panel-v2');
        const title = document.getElementById('details-title');
        const desc = document.getElementById('details-description');
        const suggestion = document.getElementById('details-suggestion');
        const techInfo = document.getElementById('details-tech-info');
        const selectBtn = document.getElementById('btn-select-node-v2');

        if (!panel) return;

        title.textContent = `🎯 ${issue.title || issue.message}`;
        desc.textContent = issue.details || issue.message || 'Sem descrição disponível.';
        suggestion.textContent = issue.suggestion || 'Verifique a estrutura do elemento e ajuste conforme as boas práticas.';
        techInfo.textContent = `Node: ${issue.nodeName || '—'} | Tipo: ${issue.nodeType || '—'} | ID: ${issue.nodeId || '—'}`;

        selectBtn.disabled = !issue.nodeId;
        selectBtn.onclick = () => {
          if (issue.nodeId) {
            send('select-node', { nodeId: issue.nodeId });
            addLog(`Selecionando node: ${issue.nodeName}`, 'info');
          }
        };

        panel.classList.add('visible');
      }

      // Close details panel
      const btnCloseDetailsV2 = document.getElementById('btn-close-details-v2');
      if (btnCloseDetailsV2) {
        btnCloseDetailsV2.addEventListener('click', () => {
          const panel = document.getElementById('details-panel-v2');
          if (panel) panel.classList.remove('visible');
        });
      }

      // Reanalyze button
      const btnReanalyze = document.getElementById('btn-reanalyze');
      if (btnReanalyze) {
        btnReanalyze.addEventListener('click', () => {
          send('analyze-layout');
          addLog('Iniciando reanálise de layout...', 'info');
        });
      }

      // Copy report button
      const btnCopyReportV2 = document.getElementById('btn-copy-report-v2');
      if (btnCopyReportV2) {
        btnCopyReportV2.addEventListener('click', () => {
          const score = document.getElementById('score-number-v2')?.textContent || '—';
          const critical = document.getElementById('stat-critical-v2')?.textContent || '0';
          const warning = document.getElementById('stat-warning-v2')?.textContent || '0';
          const info = document.getElementById('stat-info-v2')?.textContent || '0';

          const report = `# Relatório do Linter
Score: ${score}/100
Críticos: ${critical}
Atenção: ${warning}
Sugestões: ${info}

Gerado em: ${new Date().toLocaleString('pt-BR')}`;

          navigator.clipboard.writeText(report).then(() => {
            addLog('Relatório copiado para a área de transferência!', 'success');
          });
        });
      }

      // Logs tab buttons
      const btnCopyLogs = document.getElementById('btn-copy-logs');
      const btnClearLogs = document.getElementById('btn-clear-logs');
      const logsTextarea = document.getElementById('logs-textarea-v2');

      if (btnCopyLogs && logsTextarea) {
        btnCopyLogs.addEventListener('click', () => {
          navigator.clipboard.writeText(logsTextarea.value || '').then(() => {
            addLog('Logs copiados!', 'success');
          });
        });
      }

      if (btnClearLogs && logsTextarea) {
        btnClearLogs.addEventListener('click', () => {
          logsTextarea.value = '';
          addLog('Visualização de logs limpa.', 'info');
        });
      }

      // generateSuggestion helper for issue details
      function generateSuggestion(ruleId) {
        const suggestions = {
          'auto-layout-required': 'Aplique Auto Layout neste frame para garantir responsividade.',
          'widget-naming': 'Renomeie o layer usando o prefixo semântico (w:, c:, e:).',
          'generic-name-detected': 'Use um nome descritivo como "w:button-cta" ou "c:hero-section".',
          'spacer-detected': 'Use gap e padding em vez de spacers manuais.',
          'default': 'Verifique a estrutura do elemento e ajuste conforme as boas práticas.'
        };
        return suggestions[ruleId] || suggestions.default;
      }

    })();
  </script>
</body>

</html>