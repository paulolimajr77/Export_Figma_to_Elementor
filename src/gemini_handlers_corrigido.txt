    // ==================== HANDLERS GEMINI API ====================
    // Adicionar ANTES do fechamento de figma.ui.onmessage (antes da linha com '};')
    
    // Salvar API Key do Gemini
    else if (msg.type === 'save-gemini-key') {
        await Gemini.saveKey(msg.key);
        figma.notify('üîë API Key salva com sucesso!');
    }

    // Testar conex√£o com Gemini
    else if (msg.type === 'test-gemini-connection') {
        try {
            const isConnected = await Gemini.testConnection();
            figma.ui.postMessage({
                type: 'gemini-connection-result',
                success: isConnected
            });

            if (isConnected) {
                figma.notify('‚úÖ Conex√£o com Gemini OK!');
            } else {
                figma.notify('‚ùå Falha na conex√£o. Verifique a API Key.');
            }
        } catch (e: any) {
            figma.notify('‚ùå Erro ao testar conex√£o');
        }
    }

    // Analisar layout com IA e criar novo frame otimizado
    else if (msg.type === 'analyze-with-gemini') {
        const selection = figma.currentPage.selection;
        if (selection.length !== 1) {
            figma.notify('‚ö†Ô∏è Selecione apenas 1 frame para an√°lise');
            return;
        }

        const node = selection[0];
        figma.notify('ü§ñ Analisando layout com IA...');

        try {
            // Exporta screenshot do frame
            const imageData = await node.exportAsync({ format: 'PNG' });

            // Envia para an√°lise e recria√ß√£o
            const analysis = await Gemini.analyzeAndRecreate(imageData, node);

            figma.notify('üé® Criando novo frame otimizado...');

            // Cria novo frame baseado na an√°lise
            const newFrame = await Gemini.createOptimizedFrame(analysis, node);

            // Seleciona o novo frame
            figma.currentPage.selection = [newFrame];
            figma.viewport.scrollAndZoomIntoView([newFrame]);

            // Retorna resultados para UI
            figma.ui.postMessage({
                type: 'gemini-creation-complete',
                data: {
                    originalName: node.name,
                    newName: newFrame.name,
                    improvements: analysis.improvements || []
                }
            });

            figma.notify('‚úÖ Novo frame criado com sucesso!');
        } catch (e: any) {
            console.error(e);
            figma.notify('‚ùå Erro na an√°lise: ' + e.message);
            figma.ui.postMessage({
                type: 'gemini-error',
                error: e.message
            });
        }
    }
